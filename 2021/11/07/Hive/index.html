<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>Hive |  anzhen.tech</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css"
      />
      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
      <meta name="baidu-site-verification" content="code-BgeZtJHZzY" />
      <meta name="google-site-verification" content="wNOxVwDPcgD6IwrCt_pD_Xtq-E86p8USRXPN73jLu0A" />
    <link rel="alternate" href="/atom.xml" title="anzhen.tech" type="application/atom+xml">
</head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-Hive"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Hive
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2021/11/07/Hive/" class="article-date">
  <time datetime="2021-11-07T00:08:35.000Z" itemprop="datePublished">2021-11-07</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Hive/">Hive</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">36.8k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">182 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="Hive"><a href="#Hive" class="headerlink" title="Hive"></a>Hive</h1><h1 id="一、Hive基本概念"><a href="#一、Hive基本概念" class="headerlink" title="一、Hive基本概念"></a>一、Hive基本概念</h1><h2 id="1-1-什么是Hive"><a href="#1-1-什么是Hive" class="headerlink" title="1.1 什么是Hive"></a>1.1 什么是Hive</h2><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1456786">通俗易懂理解hive是什么</a></p>
<ol>
<li>Hive简介<ul>
<li>Hive：由Facebook开源用于解决海量结构化日志的数据统计工具。</li>
<li>Hive是基于Hadoop的一个数据仓库工具，可以将结构化的数据文件映射为一张表，并提供类SQL查询功能。</li>
</ul>
</li>
<li>Hive本质：将HQL转化成MapReduce程序<ol>
<li>Hive处理的数据存储在HDFS</li>
<li>Hive分析数据底层的实现是MapReduce</li>
<li>执行程序运行在Yarn上<br><img src="https://anzhen-tech-imges.oss-cn-beijing.aliyuncs.com/2021/11/07/16346965217937.jpg?x-oss-process=image/auto-orient,1/quality,q_90/watermark,text_YW56aGVuLnRlY2g,size_40,x_10,y_10"></li>
</ol>
</li>
</ol>
<h2 id="1-2Hive的优缺点"><a href="#1-2Hive的优缺点" class="headerlink" title="1.2Hive的优缺点"></a>1.2Hive的优缺点</h2><h3 id="1-2-1-优点"><a href="#1-2-1-优点" class="headerlink" title="1.2.1 优点"></a>1.2.1 优点</h3><ol>
<li>操作接口采用类SQL语法，提供快速开发的能力（简单、容易上手）。</li>
<li>避免了去写MapReduce，减少开发人员的学习成本。</li>
<li>Hive的执行延迟比较高，因此Hive常用于数据分析，对实时性要求不高的场合。</li>
<li>Hive优势在于处理大数据，对于处理小数据没有优势，因为Hive的执行延迟比较高。</li>
<li>Hive支持用户自定义函数，用户可以根据自己的需求来实现自己的函数。<h3 id="1-2-2-缺点"><a href="#1-2-2-缺点" class="headerlink" title="1.2.2 缺点"></a>1.2.2 缺点</h3></li>
<li>Hive的HQL表达能力有限<ol>
<li>迭代式算法无法表达</li>
<li>数据挖掘方面不擅长，由于MapReduce数据处理流程的限制，效率更高的算法却无法实现。</li>
</ol>
</li>
<li>Hive的效率比较低<ol>
<li>Hive自动生成的MapReduce作业，通常情况下不够智能化</li>
<li>Hive调优比较困难，粒度较粗</li>
</ol>
</li>
</ol>
<h2 id="1-3-Hive架构原理"><a href="#1-3-Hive架构原理" class="headerlink" title="1.3 Hive架构原理"></a>1.3 Hive架构原理</h2><p><img src="https://anzhen-tech-imges.oss-cn-beijing.aliyuncs.com/2021/11/07/16346968536473.jpg?x-oss-process=image/auto-orient,1/quality,q_90/watermark,text_YW56aGVuLnRlY2g,size_40,x_10,y_10"></p>
<ol>
<li>用户接口：Client<ul>
<li>CLI（command-line interface）、JDBC/ODBC(jdbc访问hive)、WEBUI（浏览器访问hive）</li>
</ul>
</li>
<li>元数据：Metastore<ul>
<li>元数据包括：表名、表所属的数据库（默认是default）、表的拥有者、列/分区字段、表的类型（是否是外部表）、表的数据所在目录等；</li>
<li>默认存储在自带的derby数据库中，推荐使用MySQL存储Metastore</li>
</ul>
</li>
<li>Hadoop<ul>
<li>使用HDFS进行存储，使用MapReduce进行计算。</li>
</ul>
</li>
<li>驱动器：Driver<ul>
<li>解析器（SQL Parser）：将SQL字符串转换成抽象语法树AST，这一步一般都用第三方工具库完成，比如antlr；对AST进行语法分析，比如表是否存在、字段是否存在、SQL语义是否有误。</li>
<li>编译器（Physical Plan）：将AST编译生成逻辑执行计划。</li>
<li>优化器（Query Optimizer）：对逻辑执行计划进行优化。</li>
<li>执行器（Execution）：把逻辑执行计划转换成可以运行的物理计划。对于Hive来说，就是MR/Spark。</li>
</ul>
</li>
</ol>
<h2 id="1-4-Hive和-数据库比较"><a href="#1-4-Hive和-数据库比较" class="headerlink" title="1.4 Hive和 数据库比较"></a>1.4 Hive和 数据库比较</h2><ul>
<li>由于 Hive 采用了类似SQL 的查询语言 HQL(Hive Query Language)，因此很容易将 Hive 理解为数据库。其实从结构上来看，Hive 和数据库除了拥有类似的查询语言，再无类似之处。本文将从多个方面来阐述 Hive 和数据库的差异。数据库可以用在 Online 的应用中，但是Hive 是为数据仓库而设计的，清楚这一点，有助于从应用角度理解 Hive 的特性。<h3 id="1-4-1-查询语言"><a href="#1-4-1-查询语言" class="headerlink" title="1.4.1 查询语言"></a>1.4.1 查询语言</h3></li>
<li>由于SQL被广泛的应用在数据仓库中，因此，专门针对Hive的特性设计了类SQL的查询语言HQL。熟悉SQL开发的开发者可以很方便的使用Hive进行开发。<h3 id="1-4-2-数据更新"><a href="#1-4-2-数据更新" class="headerlink" title="1.4.2 数据更新"></a>1.4.2 数据更新</h3></li>
<li>由于Hive是针对数据仓库应用设计的，而数据仓库的内容是读多写少的。因此，Hive中不建议对数据的改写，所有的数据都是在加载的时候确定好的。而数据库中的数据通常是需要经常进行修改的，因此可以使用 INSERT INTO …  VALUES 添加数据，使用 UPDATE … SET修改数据。<h3 id="1-4-3-执行延迟"><a href="#1-4-3-执行延迟" class="headerlink" title="1.4.3 执行延迟"></a>1.4.3 执行延迟</h3></li>
<li>Hive 在查询数据的时候，由于没有索引，需要扫描整个表，因此延迟较高。另外一个导致 Hive 执行延迟高的因素是 MapReduce框架。由于MapReduce 本身具有较高的延迟，因此在利用MapReduce 执行Hive查询时，也会有较高的延迟。相对的，数据库的执行延迟较低。当然，这个低是有条件的，即数据规模较小，当数据规模大到超过数据库的处理能力的时候，Hive的并行计算显然能体现出优势。<h3 id="1-4-4-数据规模"><a href="#1-4-4-数据规模" class="headerlink" title="1.4.4 数据规模"></a>1.4.4 数据规模</h3></li>
<li>由于Hive建立在集群上并可以利用MapReduce进行并行计算，因此可以支持很大规模的数据；对应的，数据库可以支持的数据规模较小。</li>
</ul>
<h1 id="二、Hive安装"><a href="#二、Hive安装" class="headerlink" title="二、Hive安装"></a>二、Hive安装</h1><h2 id="2-1-Hive安装地址"><a href="#2-1-Hive安装地址" class="headerlink" title="2.1 Hive安装地址"></a>2.1 Hive安装地址</h2><ol>
<li>Hive官网地址<ul>
<li><a target="_blank" rel="noopener" href="http://hive.apache.org/">http://hive.apache.org/</a></li>
</ul>
</li>
<li>文档查看地址<ul>
<li><a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/Hive/GettingStarted">https://cwiki.apache.org/confluence/display/Hive/GettingStarted</a></li>
</ul>
</li>
<li>下载地址<ul>
<li><a target="_blank" rel="noopener" href="http://archive.apache.org/dist/hive/">http://archive.apache.org/dist/hive/</a></li>
</ul>
</li>
<li>github地址<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/apache/hive">https://github.com/apache/hive</a></li>
</ul>
</li>
</ol>
<h2 id="2-2-MySql安装"><a href="#2-2-MySql安装" class="headerlink" title="2.2 MySql安装"></a>2.2 MySql安装</h2><ul>
<li>参考<a href="mweblib://16347028415943">Mysql安装</a></li>
</ul>
<h2 id="2-3-Hive安装部署"><a href="#2-3-Hive安装部署" class="headerlink" title="2.3 Hive安装部署"></a>2.3 Hive安装部署</h2><ol>
<li>把apache-hive-3.1.2-bin.tar.gz上传到linux的/opt/software目录下  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 software]$ <span class="built_in">pwd</span></span><br><span class="line">/opt/software</span><br><span class="line">[atguigu@hadoop001 software]$ ll</span><br><span class="line">total 835216</span><br><span class="line">-rw-r--r--. 1 atguigu atguigu 312850286 Apr 20  2020 apache-hive-3.1.2-bin.tar.gz</span><br><span class="line">-rw-r--r--. 1 atguigu atguigu   9311744 Apr 20  2020 apache-zookeeper-3.5.7-bin.tar.gz</span><br><span class="line">-rw-r--r--. 1 atguigu atguigu 338075860 Oct  9 12:59 hadoop-3.1.3.tar.gz</span><br><span class="line">-rw-r--r--. 1 atguigu atguigu 195013152 Oct  9 12:59 jdk-8u212-linux-x64.tar.gz</span><br><span class="line">[atguigu@hadoop001 software]$</span><br></pre></td></tr></table></figure></li>
<li>解压apache-hive-3.1.2-bin.tar.gz到/opt/module/目录下面 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop102 software]$ tar -zxvf /opt/software/apache-hive-3.1.2-bin.tar.gz -C /opt/module/</span><br><span class="line">···</span><br><span class="line">[atguigu@hadoop001 module]$ ll</span><br><span class="line">total 0</span><br><span class="line">drwxrwxr-x.  9 atguigu atguigu 153 Oct 20 13:55 apache-hive-3.1.2-bin</span><br><span class="line">drwxr-xr-x.  9 atguigu atguigu 149 Oct 19 14:29 hadoop-3.1.3</span><br><span class="line">drwxr-xr-x. 11 atguigu atguigu 173 Oct 19 14:45 ha-hadoop-3.1.3</span><br><span class="line">drwxr-xr-x.  7 atguigu atguigu 245 Apr  2  2019 jdk1.8.0_212</span><br><span class="line">drwxrwxr-x.  8 atguigu atguigu 160 Oct 18 13:44 zookeeper-3.5.7</span><br><span class="line">[atguigu@hadoop001 module]$</span><br></pre></td></tr></table></figure></li>
<li>修改apache-hive-3.1.2-bin.tar.gz的名称为hive<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 module]$ mv apache-hive-3.1.2-bin hive-3.1.2</span><br><span class="line">[atguigu@hadoop001 module]$ ll</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x.  9 atguigu atguigu 149 Oct 19 14:29 hadoop-3.1.3</span><br><span class="line">drwxr-xr-x. 11 atguigu atguigu 173 Oct 19 14:45 ha-hadoop-3.1.3</span><br><span class="line">drwxrwxr-x.  9 atguigu atguigu 153 Oct 20 13:55 hive-3.1.2</span><br><span class="line">drwxr-xr-x.  7 atguigu atguigu 245 Apr  2  2019 jdk1.8.0_212</span><br><span class="line">drwxrwxr-x.  8 atguigu atguigu 160 Oct 18 13:44 zookeeper-3.5.7</span><br><span class="line">[atguigu@hadoop001 module]$</span><br></pre></td></tr></table></figure></li>
<li>修改/etc/profile.d/set_env.sh，添加环境变量 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 module]$ cat /etc/profile.d/set_env.sh</span><br><span class="line"><span class="comment">#JAVA_HOME</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/opt/module/jdk1.8.0_212</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment">#HADOOP_HOME</span></span><br><span class="line"><span class="built_in">export</span> HADOOP_HOME=/opt/module/ha-hadoop-3.1.3</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HADOOP_HOME</span>/bin</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HADOOP_HOME</span>/sbin</span><br><span class="line"></span><br><span class="line"><span class="comment">#HIVE_HOME</span></span><br><span class="line"><span class="built_in">export</span> HIVE_HOME=/opt/module/hive-3.1.2</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HIVE_HOME</span>/bin</span><br><span class="line">[atguigu@hadoop001 module]$</span><br></pre></td></tr></table></figure></li>
<li>解决日志Jar包冲突 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 ~]$ ll <span class="variable">$HIVE_HOME</span>/lib/log4j-slf4j-impl-2.10.0.jar</span><br><span class="line">-rw-rw-r--. 1 atguigu atguigu 24173 Apr 15  2020 /opt/module/hive-3.1.2/lib/log4j-slf4j-impl-2.10.0.jar</span><br><span class="line">[atguigu@hadoop001 ~]$ mv <span class="variable">$HIVE_HOME</span>/lib/log4j-slf4j-impl-2.10.0.jar <span class="variable">$HIVE_HOME</span>/lib/log4j-slf4j-impl-2.10.0.jar_bak</span><br><span class="line">[atguigu@hadoop001 ~]$ ll <span class="variable">$HIVE_HOME</span>/lib/log4j-slf4j-impl-2.10.0.jar_bak</span><br><span class="line">-rw-rw-r--. 1 atguigu atguigu 24173 Apr 15  2020 /opt/module/hive-3.1.2/lib/log4j-slf4j-impl-2.10.0.jar_bak</span><br><span class="line">[atguigu@hadoop001 ~]$</span><br></pre></td></tr></table></figure>
<h2 id="2-4-Hive元数据配置到MySql"><a href="#2-4-Hive元数据配置到MySql" class="headerlink" title="2.4 Hive元数据配置到MySql"></a>2.4 Hive元数据配置到MySql</h2><h3 id="2-4-1-拷贝驱动"><a href="#2-4-1-拷贝驱动" class="headerlink" title="2.4.1 拷贝驱动"></a>2.4.1 拷贝驱动</h3></li>
<li>将MySQL的JDBC驱动拷贝到Hive的lib目录下 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 software]$ cp /opt/software/mysql-connector-java-8.0.25.jar <span class="variable">$HIVE_HOME</span>/lib</span><br><span class="line">[atguigu@hadoop001 software]$ ll <span class="variable">$HIVE_HOME</span>/lib/mysql-connector-java-8.0.25.jar</span><br><span class="line">-rw-r--r--. 1 atguigu atguigu 2428320 Oct 20 14:14 /opt/module/hive-3.1.2/lib/mysql-connector-java-8.0.25.jar</span><br><span class="line">[atguigu@hadoop001 software]$</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="2-4-2-配置Metastore到MySql"><a href="#2-4-2-配置Metastore到MySql" class="headerlink" title="2.4.2 配置Metastore到MySql"></a>2.4.2 配置Metastore到MySql</h3><ol>
<li>在$HIVE_HOME/conf目录下新建hive-site.xml文件添加如下内容 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- jdbc连接的URL --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionURL<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>jdbc:mysql://hadoop102:3306/metastore?useSSL=false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- jdbc连接的Driver--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionDriverName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- jdbc连接的username--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionUserName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>root<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- jdbc连接的password --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionPassword<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>root<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Hive默认在HDFS的工作目录 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.warehouse.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/user/hive/warehouse<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Hive元数据存储的验证 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.schema.verification<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 元数据存储授权  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.event.db.notification.api.auth<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="2-5-启动Hive"><a href="#2-5-启动Hive" class="headerlink" title="2.5 启动Hive"></a>2.5 启动Hive</h2><h3 id="2-5-1-初始化元数据库"><a href="#2-5-1-初始化元数据库" class="headerlink" title="2.5.1 初始化元数据库"></a>2.5.1 初始化元数据库</h3><ol>
<li>登陆MySQL创建Hive元数据库 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> database metastore;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> metastore          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>初始化Hive元数据库 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 conf]$ schematool -initSchema -dbType mysql -verbose</span><br><span class="line">Metastore connection URL:	 jdbc:mysql://mysql:3306/metastore?useSSL=<span class="literal">false</span></span><br><span class="line">Metastore Connection Driver :	 com.mysql.jdbc.Driver</span><br><span class="line">Metastore connection User:	 root</span><br><span class="line">Loading class `com.mysql.jdbc.Driver<span class="string">&#x27;. This is deprecated. The new driver class is `com.mysql.cj.jdbc.Driver&#x27;</span>. The driver is automatically registered via the SPI and manual loading of the driver class is generally unnecessary.</span><br><span class="line">Starting metastore schema initialization to 3.1.0</span><br><span class="line">Initialization script hive-schema-3.1.0.mysql.sql</span><br><span class="line">Connecting to jdbc:mysql://mysql:3306/metastore?useSSL=<span class="literal">false</span></span><br><span class="line">Connected to: MySQL (version 8.0.25)</span><br><span class="line">Driver: MySQL Connector/J (version mysql-connector-java-8.0.25 (Revision: 08be9e9b4cba6aa115f9b27b215887af40b159e0))</span><br><span class="line">Transaction isolation: TRANSACTION_READ_COMMITTED</span><br><span class="line">0: jdbc:mysql://mysql:3306/metastore&gt; !autocommit on</span><br><span class="line">Autocommit status: <span class="literal">true</span></span><br><span class="line">···</span><br><span class="line">···</span><br><span class="line">Closing: 0: jdbc:mysql://mysql:3306/metastore?useSSL=<span class="literal">false</span></span><br><span class="line">beeline&gt;</span><br><span class="line">beeline&gt; Initialization script completed</span><br><span class="line">schemaTool completed</span><br><span class="line">[atguigu@hadoop001 conf]$</span><br></pre></td></tr></table></figure></li>
<li>元数据相关表 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> dbs;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+---------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> Field           <span class="operator">|</span> Type          <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+---------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> DB_ID           <span class="operator">|</span> <span class="type">bigint</span>        <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">DESC</span>            <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">4000</span>) <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> DB_LOCATION_URI <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">4000</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> NAME            <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">128</span>)  <span class="operator">|</span> YES  <span class="operator">|</span> MUL <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> OWNER_NAME      <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">128</span>)  <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> OWNER_TYPE      <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">10</span>)   <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CTLG_NAME       <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">256</span>)  <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> MUL <span class="operator">|</span> hive    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+---------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> tbls;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+--------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> Field              <span class="operator">|</span> Type         <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+--------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> TBL_ID             <span class="operator">|</span> <span class="type">bigint</span>       <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CREATE_TIME        <span class="operator">|</span> <span class="type">int</span>          <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> DB_ID              <span class="operator">|</span> <span class="type">bigint</span>       <span class="operator">|</span> YES  <span class="operator">|</span> MUL <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> LAST_ACCESS_TIME   <span class="operator">|</span> <span class="type">int</span>          <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> OWNER              <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">767</span>) <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> OWNER_TYPE         <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">10</span>)  <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> RETENTION          <span class="operator">|</span> <span class="type">int</span>          <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> SD_ID              <span class="operator">|</span> <span class="type">bigint</span>       <span class="operator">|</span> YES  <span class="operator">|</span> MUL <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> TBL_NAME           <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">256</span>) <span class="operator">|</span> YES  <span class="operator">|</span> MUL <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> TBL_TYPE           <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">128</span>) <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> VIEW_EXPANDED_TEXT <span class="operator">|</span> mediumtext   <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> VIEW_ORIGINAL_TEXT <span class="operator">|</span> mediumtext   <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> IS_REWRITE_ENABLED <span class="operator">|</span> bit(<span class="number">1</span>)       <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> b<span class="string">&#x27;0&#x27;</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+--------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="number">13</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> sds;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+---------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> Field                     <span class="operator">|</span> Type          <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+---------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> SD_ID                     <span class="operator">|</span> <span class="type">bigint</span>        <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CD_ID                     <span class="operator">|</span> <span class="type">bigint</span>        <span class="operator">|</span> YES  <span class="operator">|</span> MUL <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> INPUT_FORMAT              <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">4000</span>) <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> IS_COMPRESSED             <span class="operator">|</span> bit(<span class="number">1</span>)        <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> IS_STOREDASSUBDIRECTORIES <span class="operator">|</span> bit(<span class="number">1</span>)        <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> LOCATION                  <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">4000</span>) <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> NUM_BUCKETS               <span class="operator">|</span> <span class="type">int</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> OUTPUT_FORMAT             <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">4000</span>) <span class="operator">|</span> YES  <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> SERDE_ID                  <span class="operator">|</span> <span class="type">bigint</span>        <span class="operator">|</span> YES  <span class="operator">|</span> MUL <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+---------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="number">9</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="2-5-2-启动Hive"><a href="#2-5-2-启动Hive" class="headerlink" title="2.5.2 启动Hive"></a>2.5.2 启动Hive</h3></li>
<li>先启动hadoop集群</li>
<li>启动Hive <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 conf]$ hive</span><br><span class="line"><span class="built_in">which</span>: no hbase <span class="keyword">in</span> (/usr/<span class="built_in">local</span>/bin:/usr/bin:/usr/<span class="built_in">local</span>/sbin:/usr/sbin:/opt/module/jdk1.8.0_212/bin:/opt/module/ha-hadoop-3.1.3/bin:/opt/module/ha-hadoop-3.1.3/sbin:/opt/module/hive-3.1.2/bin:/home/atguigu/.<span class="built_in">local</span>/bin:/home/atguigu/bin)</span><br><span class="line">Hive Session ID = 6e003b50-4b21-418c-9983-d13aea1037a4</span><br><span class="line"></span><br><span class="line">Logging initialized using configuration <span class="keyword">in</span> jar:file:/opt/module/hive-3.1.2/lib/hive-common-3.1.2.jar!/hive-log4j2.properties Async: <span class="literal">true</span></span><br><span class="line">Loading class `com.mysql.jdbc.Driver<span class="string">&#x27;. This is deprecated. The new driver class is `com.mysql.cj.jdbc.Driver&#x27;</span>. The driver is automatically registered via the SPI and manual loading of the driver class is generally unnecessary.</span><br><span class="line">Hive-on-MR is deprecated <span class="keyword">in</span> Hive 2 and may not be available <span class="keyword">in</span> the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.</span><br><span class="line">Hive Session ID = 19720043-aa70-4ba3-8eb9-7ff94beb4379</span><br><span class="line">hive&gt; </span><br></pre></td></tr></table></figure></li>
<li>使用Hive <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line">OK</span><br><span class="line"><span class="keyword">default</span></span><br><span class="line"><span class="type">Time</span> taken: <span class="number">0.58</span> seconds, Fetched: <span class="number">1</span> <span class="type">row</span>(s)</span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line">OK</span><br><span class="line">test</span><br><span class="line">test_2</span><br><span class="line"><span class="type">Time</span> taken: <span class="number">0.029</span> seconds, Fetched: <span class="number">2</span> <span class="type">row</span>(s)</span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> test_3 (id <span class="type">int</span>,name string,age <span class="type">int</span>);</span><br><span class="line">OK</span><br><span class="line"><span class="type">Time</span> taken: <span class="number">0.346</span> seconds</span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line">OK</span><br><span class="line">test</span><br><span class="line">test_2</span><br><span class="line">test_3</span><br><span class="line"><span class="type">Time</span> taken: <span class="number">0.034</span> seconds, Fetched: <span class="number">3</span> <span class="type">row</span>(s)</span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> test_3 <span class="keyword">values</span> (<span class="number">123</span>,<span class="string">&#x27;zhangsan&#x27;</span>,<span class="number">18</span>);</span><br><span class="line">Query ID <span class="operator">=</span> atguigu_20211020154850_d4a395ef<span class="operator">-</span>b85d<span class="number">-466</span>a<span class="number">-852</span>f<span class="operator">-</span>b6707a260960</span><br><span class="line">Total jobs <span class="operator">=</span> <span class="number">3</span></span><br><span class="line">Launching Job <span class="number">1</span> <span class="keyword">out</span> <span class="keyword">of</span> <span class="number">3</span></span><br><span class="line">Number <span class="keyword">of</span> reduce tasks determined <span class="keyword">at</span> compile <span class="type">time</span>: <span class="number">1</span></span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> change the average load <span class="keyword">for</span> a reducer (<span class="keyword">in</span> bytes):</span><br><span class="line">  <span class="keyword">set</span> hive.exec.reducers.bytes.per.reducer<span class="operator">=</span><span class="operator">&lt;</span>number<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> limit the maximum number <span class="keyword">of</span> reducers:</span><br><span class="line">  <span class="keyword">set</span> hive.exec.reducers.max<span class="operator">=</span><span class="operator">&lt;</span>number<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">In</span> <span class="keyword">order</span> <span class="keyword">to</span> <span class="keyword">set</span> a constant number <span class="keyword">of</span> reducers:</span><br><span class="line">  <span class="keyword">set</span> mapreduce.job.reduces<span class="operator">=</span><span class="operator">&lt;</span>number<span class="operator">&gt;</span></span><br><span class="line">Starting Job <span class="operator">=</span> job_1634689350447_0003, Tracking URL <span class="operator">=</span> http:<span class="operator">/</span><span class="operator">/</span>hadoop003:<span class="number">8088</span><span class="operator">/</span>proxy<span class="operator">/</span>application_1634689350447_0003<span class="operator">/</span></span><br><span class="line">Kill Command <span class="operator">=</span> <span class="operator">/</span>opt<span class="operator">/</span><span class="keyword">module</span><span class="operator">/</span>ha<span class="operator">-</span>hadoop<span class="number">-3.1</span><span class="number">.3</span><span class="operator">/</span>bin<span class="operator">/</span>mapred job  <span class="operator">-</span>kill job_1634689350447_0003</span><br><span class="line">Hadoop job information <span class="keyword">for</span> Stage<span class="number">-1</span>: number <span class="keyword">of</span> mappers: <span class="number">1</span>; number <span class="keyword">of</span> reducers: <span class="number">1</span></span><br><span class="line"><span class="number">2021</span><span class="number">-10</span><span class="number">-20</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">00</span>,<span class="number">166</span> Stage<span class="number">-1</span> map <span class="operator">=</span> <span class="number">0</span><span class="operator">%</span>,  reduce <span class="operator">=</span> <span class="number">0</span><span class="operator">%</span></span><br><span class="line"><span class="number">2021</span><span class="number">-10</span><span class="number">-20</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">05</span>,<span class="number">319</span> Stage<span class="number">-1</span> map <span class="operator">=</span> <span class="number">100</span><span class="operator">%</span>,  reduce <span class="operator">=</span> <span class="number">0</span><span class="operator">%</span>, Cumulative CPU <span class="number">1.37</span> sec</span><br><span class="line"><span class="number">2021</span><span class="number">-10</span><span class="number">-20</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">10</span>,<span class="number">425</span> Stage<span class="number">-1</span> map <span class="operator">=</span> <span class="number">100</span><span class="operator">%</span>,  reduce <span class="operator">=</span> <span class="number">100</span><span class="operator">%</span>, Cumulative CPU <span class="number">2.49</span> sec</span><br><span class="line">MapReduce Total cumulative CPU <span class="type">time</span>: <span class="number">2</span> seconds <span class="number">490</span> msec</span><br><span class="line">Ended Job <span class="operator">=</span> job_1634689350447_0003</span><br><span class="line">Stage<span class="number">-4</span> <span class="keyword">is</span> selected <span class="keyword">by</span> <span class="keyword">condition</span> resolver.</span><br><span class="line">Stage<span class="number">-3</span> <span class="keyword">is</span> filtered <span class="keyword">out</span> <span class="keyword">by</span> <span class="keyword">condition</span> resolver.</span><br><span class="line">Stage<span class="number">-5</span> <span class="keyword">is</span> filtered <span class="keyword">out</span> <span class="keyword">by</span> <span class="keyword">condition</span> resolver.</span><br><span class="line">Moving data <span class="keyword">to</span> directory hdfs:<span class="operator">/</span><span class="operator">/</span>mycluster<span class="operator">/</span><span class="keyword">user</span><span class="operator">/</span>hive<span class="operator">/</span>warehouse<span class="operator">/</span>test_3<span class="operator">/</span>.hive<span class="operator">-</span>staging_hive_2021<span class="number">-10</span><span class="number">-20</span>_15<span class="number">-48</span><span class="number">-50</span>_976_8532078537182566570<span class="number">-1</span><span class="operator">/</span><span class="operator">-</span>ext<span class="number">-10000</span></span><br><span class="line">Loading data <span class="keyword">to</span> <span class="keyword">table</span> default.test_3</span><br><span class="line">MapReduce Jobs Launched:</span><br><span class="line">Stage<span class="operator">-</span>Stage<span class="number">-1</span>: Map: <span class="number">1</span>  Reduce: <span class="number">1</span>   Cumulative CPU: <span class="number">2.49</span> sec   HDFS Read: <span class="number">16281</span> HDFS Write: <span class="number">285</span> SUCCESS</span><br><span class="line">Total MapReduce CPU <span class="type">Time</span> Spent: <span class="number">2</span> seconds <span class="number">490</span> msec</span><br><span class="line">OK</span><br><span class="line"><span class="type">Time</span> taken: <span class="number">80.881</span> seconds</span><br><span class="line">hive<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test_3;</span><br><span class="line">OK</span><br><span class="line"><span class="number">123</span>	zhangsan	<span class="number">18</span></span><br><span class="line"><span class="type">Time</span> taken: <span class="number">0.109</span> seconds, Fetched: <span class="number">1</span> <span class="type">row</span>(s)</span><br><span class="line">hive<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="2-5-3-使用独立的元数据服务的方式访问Hive"><a href="#2-5-3-使用独立的元数据服务的方式访问Hive" class="headerlink" title="2.5.3 使用独立的元数据服务的方式访问Hive"></a>2.5.3 使用独立的元数据服务的方式访问Hive</h3><ol>
<li>在hive-site.xml文件中添加如下配置信息 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 指定存储元数据要连接的地址 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.uris<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>thrift://hadoop102:9083<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>启动metastore <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 conf]$ hive --service metastore</span><br><span class="line">2021-10-20 16:19:53: Starting Hive Metastore Server</span><br><span class="line">Loading class `com.mysql.jdbc.Driver<span class="string">&#x27;. This is deprecated. The new driver class is `com.mysql.cj.jdbc.Driver&#x27;</span>. The driver is automatically registered via the SPI and manual loading of the driver class is generally unnecessary.</span><br></pre></td></tr></table></figure>
 注意: 启动后窗口不能再操作，需打开一个新的shell窗口做别的操作</li>
<li>启动 hive <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 ~]$ hive</span><br><span class="line"><span class="built_in">which</span>: no hbase <span class="keyword">in</span> (/usr/<span class="built_in">local</span>/bin:/usr/bin:/usr/<span class="built_in">local</span>/sbin:/usr/sbin:/opt/module/jdk1.8.0_212/bin:/opt/module/ha-hadoop-3.1.3/bin:/opt/module/ha-hadoop-3.1.3/sbin:/opt/module/hive-3.1.2/bin:/home/atguigu/.<span class="built_in">local</span>/bin:/home/atguigu/bin)</span><br><span class="line">Hive Session ID = cc81e23a-657b-47e7-b211-bc4364e64fc2</span><br><span class="line"></span><br><span class="line">Logging initialized using configuration <span class="keyword">in</span> jar:file:/opt/module/hive-3.1.2/lib/hive-common-3.1.2.jar!/hive-log4j2.properties Async: <span class="literal">true</span></span><br><span class="line">Hive-on-MR is deprecated <span class="keyword">in</span> Hive 2 and may not be available <span class="keyword">in</span> the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.</span><br><span class="line">Hive Session ID = 60aa1b01-a2b8-4766-b9fc-4246f8c5fee6</span><br><span class="line">hive&gt;</span><br></pre></td></tr></table></figure>
<h3 id="2-5-4-使用JDBC方式访问Hive"><a href="#2-5-4-使用JDBC方式访问Hive" class="headerlink" title="2.5.4 使用JDBC方式访问Hive"></a>2.5.4 使用JDBC方式访问Hive</h3></li>
<li>在hive-site.xml文件中添加如下配置信息 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">&lt;!-- 指定hiveserver2连接的host --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.server2.thrift.bind.host<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hadoop102<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 指定hiveserver2连接的端口号 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.server2.thrift.port<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>10000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    ```    </span><br><span class="line">2. 启动hiveserver2</span><br><span class="line">    ```bash</span><br><span class="line">    [atguigu@hadoop001 ~]$ hive --service hiveserver2</span><br><span class="line">    which: no hbase in (/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/opt/module/jdk1.8.0_212/bin:/opt/module/ha-hadoop-3.1.3/bin:/opt/module/ha-hadoop-3.1.3/sbin:/opt/module/hive-3.1.2/bin:/home/atguigu/.local/bin:/home/atguigu/bin)</span><br><span class="line">    2021-10-20 16:23:25: Starting HiveServer2</span><br><span class="line">    Hive Session ID = 9191577f-34bc-478c-a4ae-8b0f2d20f945</span><br><span class="line">    Hive Session ID = 769ddf72-053a-4f0b-aa48-5723090f513b</span><br></pre></td></tr></table></figure></li>
<li>启动beeline客户端（需要多等待一会） <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 ~]$ beeline -u jdbc:hive2://hadoop001:10000 -n atguigu</span><br><span class="line">Connecting to jdbc:hive2://hadoop001:10000</span><br><span class="line">Connected to: Apache Hive (version 3.1.2)</span><br><span class="line">Driver: Hive JDBC (version 3.1.2)</span><br><span class="line">Transaction isolation: TRANSACTION_REPEATABLE_READ</span><br><span class="line">Beeline version 3.1.2 by Apache Hive</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt;</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt;</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt;</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt; show databases;</span><br><span class="line">INFO  : Compiling <span class="built_in">command</span>(queryId=atguigu_20211020162645_fd2a8faf-9209-4bec-b36d-ec4c63bd8149): show databases</span><br><span class="line">INFO  : Concurrency mode is disabled, not creating a lock manager</span><br><span class="line">INFO  : Semantic Analysis Completed (retrial = <span class="literal">false</span>)</span><br><span class="line">INFO  : Returning Hive schema: Schema(fieldSchemas:[FieldSchema(name:database_name, <span class="built_in">type</span>:string, comment:from deserializer)], properties:null)</span><br><span class="line">INFO  : Completed compiling <span class="built_in">command</span>(queryId=atguigu_20211020162645_fd2a8faf-9209-4bec-b36d-ec4c63bd8149); Time taken: 0.589 seconds</span><br><span class="line">INFO  : Concurrency mode is disabled, not creating a lock manager</span><br><span class="line">INFO  : Executing <span class="built_in">command</span>(queryId=atguigu_20211020162645_fd2a8faf-9209-4bec-b36d-ec4c63bd8149): show databases</span><br><span class="line">INFO  : Starting task [Stage-0:DDL] <span class="keyword">in</span> serial mode</span><br><span class="line">INFO  : Completed executing <span class="built_in">command</span>(queryId=atguigu_20211020162645_fd2a8faf-9209-4bec-b36d-ec4c63bd8149); Time taken: 0.016 seconds</span><br><span class="line">INFO  : OK</span><br><span class="line">INFO  : Concurrency mode is disabled, not creating a lock manager</span><br><span class="line">+----------------+</span><br><span class="line">| database_name  |</span><br><span class="line">+----------------+</span><br><span class="line">| default        |</span><br><span class="line">+----------------+</span><br><span class="line">1 row selected (0.84 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="2-5-5-编写启动metastore和hiveserver2脚本"><a href="#2-5-5-编写启动metastore和hiveserver2脚本" class="headerlink" title="2.5.5 编写启动metastore和hiveserver2脚本"></a>2.5.5 编写启动metastore和hiveserver2脚本</h3><ol>
<li><p>前台启动的方式导致需要打开多个shell窗口，可以使用如下方式后台方式启动</p>
<ul>
<li>nohup: 放在命令开头，表示不挂起,也就是关闭终端进程也继续保持运行状态<ul>
<li>0:标准输入</li>
<li>1:标准输出</li>
<li>2:错误输出</li>
<li>2&gt;&amp;1 : 表示将错误重定向到标准输出上</li>
<li>&amp;: 放在命令结尾,表示后台运行</li>
<li>一般会组合使用: nohup  [xxx命令操作]&gt; file  2&gt;&amp;1 &amp;  ， 表示将xxx命令运行的<br>结果输出到file中，并保持命令启动的进程在后台运行。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 ~]$ nohup hive --service metastore 2&gt;&amp;1 &amp;</span><br><span class="line">[1] 19488</span><br><span class="line">[atguigu@hadoop001 ~]$ nohup: ignoring input and appending output to ‘nohup.out’</span><br><span class="line"></span><br><span class="line">[atguigu@hadoop001 ~]$</span><br><span class="line">[atguigu@hadoop001 ~]$ nohup hive --service hiveserver2 2&gt;&amp;1 &amp;</span><br><span class="line">[2] 19603</span><br><span class="line">[atguigu@hadoop001 ~]$ nohup: ignoring input and appending output to ‘nohup.out’</span><br><span class="line"></span><br><span class="line">[atguigu@hadoop001 ~]$</span><br><span class="line">[atguigu@hadoop001 ~]$ tail -f nohup.out</span><br><span class="line">2021-10-20 16:46:00: Starting Hive Metastore Server</span><br><span class="line">Loading class `com.mysql.jdbc.Driver<span class="string">&#x27;. This is deprecated. The new driver class is `com.mysql.cj.jdbc.Driver&#x27;</span>. The driver is automatically registered via the SPI and manual loading of the driver class is generally unnecessary.</span><br><span class="line"><span class="built_in">which</span>: no hbase <span class="keyword">in</span> (/usr/<span class="built_in">local</span>/bin:/usr/bin:/usr/<span class="built_in">local</span>/sbin:/usr/sbin:/opt/module/jdk1.8.0_212/bin:/opt/module/ha-hadoop-3.1.3/bin:/opt/module/ha-hadoop-3.1.3/sbin:/opt/module/hive-3.1.2/bin:/home/atguigu/.<span class="built_in">local</span>/bin:/home/atguigu/bin)</span><br><span class="line">2021-10-20 16:46:07: Starting HiveServer2</span><br><span class="line">Hive Session ID = e305ccdf-dd51-48e1-a740-fbc309de0a31</span><br><span class="line">Hive Session ID = b9a65f04-071e-493d-b89e-774daf7cac0f</span><br><span class="line">Hive Session ID = 985ef9a9-6d00-47f6-a0e4-178eed45c7f8</span><br><span class="line">Hive Session ID = dae41fea-63a9-4bda-84e6-c4e171fc0ecc</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p>编写脚本hiveservices.sh</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">HIVE_LOG_DIR=<span class="variable">$HIVE_HOME</span>/logs</span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="variable">$HIVE_LOG_DIR</span> ]; <span class="keyword">then</span></span><br><span class="line">    mkdir -p <span class="variable">$HIVE_LOG_DIR</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment">#检查进程是否运行正常，参数1为进程名，参数2为进程端口</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">check_process</span></span>() &#123;</span><br><span class="line">    pid=$(ps -ef 2&gt;/dev/null | grep -v grep | grep -i <span class="variable">$1</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">    ppid=$(netstat -nltp 2&gt;/dev/null | grep <span class="variable">$2</span> | awk <span class="string">&#x27;&#123;print $7&#125;&#x27;</span> | cut -d <span class="string">&#x27;/&#x27;</span> -f 1)</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$pid</span></span><br><span class="line">    [[ <span class="string">&quot;<span class="variable">$pid</span>&quot;</span> =~ <span class="string">&quot;<span class="variable">$ppid</span>&quot;</span> ]] &amp;&amp; [ <span class="string">&quot;<span class="variable">$ppid</span>&quot;</span> ] &amp;&amp; <span class="built_in">return</span> 0 || <span class="built_in">return</span> 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">hive_start</span></span>() &#123;</span><br><span class="line">    metapid=$(check_process HiveMetastore 9083)</span><br><span class="line">    cmd=<span class="string">&quot;nohup hive --service metastore &gt;<span class="variable">$HIVE_LOG_DIR</span>/metastore.log 2&gt;&amp;1 &amp;&quot;</span></span><br><span class="line">    cmd=<span class="variable">$cmd</span><span class="string">&quot; sleep 4; hdfs dfsadmin -safemode wait &gt;/dev/null 2&gt;&amp;1&quot;</span></span><br><span class="line">    [ -z <span class="string">&quot;<span class="variable">$metapid</span>&quot;</span> ] &amp;&amp; <span class="built_in">eval</span> <span class="variable">$cmd</span> || <span class="built_in">echo</span> <span class="string">&quot;Metastroe服务已启动&quot;</span></span><br><span class="line">    server2pid=$(check_process HiveServer2 10000)</span><br><span class="line">    cmd=<span class="string">&quot;nohup hive --service hiveserver2 &gt;<span class="variable">$HIVE_LOG_DIR</span>/hiveServer2.log 2&gt;&amp;1 &amp;&quot;</span></span><br><span class="line">    [ -z <span class="string">&quot;<span class="variable">$server2pid</span>&quot;</span> ] &amp;&amp; <span class="built_in">eval</span> <span class="variable">$cmd</span> || <span class="built_in">echo</span> <span class="string">&quot;HiveServer2服务已启动&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">hive_stop</span></span>() &#123;</span><br><span class="line">    metapid=$(check_process HiveMetastore 9083)</span><br><span class="line">    [ <span class="string">&quot;<span class="variable">$metapid</span>&quot;</span> ] &amp;&amp; <span class="built_in">kill</span> <span class="variable">$metapid</span> || <span class="built_in">echo</span> <span class="string">&quot;Metastore服务未启动&quot;</span></span><br><span class="line">    server2pid=$(check_process HiveServer2 10000)</span><br><span class="line">    [ <span class="string">&quot;<span class="variable">$server2pid</span>&quot;</span> ] &amp;&amp; <span class="built_in">kill</span> <span class="variable">$server2pid</span> || <span class="built_in">echo</span> <span class="string">&quot;HiveServer2服务未启动&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line"><span class="string">&quot;start&quot;</span>)</span><br><span class="line">    hive_start</span><br><span class="line">    ;;</span><br><span class="line"><span class="string">&quot;stop&quot;</span>)</span><br><span class="line">    hive_stop</span><br><span class="line">    ;;</span><br><span class="line"><span class="string">&quot;restart&quot;</span>)</span><br><span class="line">    hive_stop</span><br><span class="line">    sleep 2</span><br><span class="line">    hive_start</span><br><span class="line">    ;;</span><br><span class="line"><span class="string">&quot;status&quot;</span>)</span><br><span class="line">    check_process HiveMetastore 9083 &gt;/dev/null &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;Metastore服务运行正常&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;Metastore服务运行异常&quot;</span></span><br><span class="line">    check_process HiveServer2 10000 &gt;/dev/null &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;HiveServer2服务运行正常&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;HiveServer2服务运行异常&quot;</span></span><br><span class="line">    ;;</span><br><span class="line">*)</span><br><span class="line">    <span class="built_in">echo</span> Invalid Args!</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&#x27;Usage: &#x27;</span>$(basename <span class="variable">$0</span>)<span class="string">&#x27; start|stop|restart|status&#x27;</span></span><br><span class="line">    ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>添加执行权限</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 bin]$ ll</span><br><span class="line">total 20</span><br><span class="line">-rw-rw-r--. 1 atguigu atguigu 1723 Oct 20 17:02 hive_server.sh</span><br><span class="line">[atguigu@hadoop001 bin]$ chmod a+x hive_server.sh</span><br><span class="line">[atguigu@hadoop001 bin]$ ll</span><br><span class="line">total 20</span><br><span class="line">-rwxrwxr-x. 1 atguigu atguigu 1723 Oct 20 17:02 hive_server.sh</span><br><span class="line">[atguigu@hadoop001 bin]$</span><br></pre></td></tr></table></figure></li>
<li><p>启动Hive后台服务</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 bin]$ hive_server.sh start</span><br><span class="line">[atguigu@hadoop001 bin]$ hive_server.sh status</span><br><span class="line">Metastore服务运行正常</span><br><span class="line">HiveServer2服务运行正常</span><br><span class="line">[atguigu@hadoop001 bin]$</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="2-6-Hive常用交互命令"><a href="#2-6-Hive常用交互命令" class="headerlink" title="2.6 Hive常用交互命令"></a>2.6 Hive常用交互命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 hive]$ hive -<span class="built_in">help</span></span><br><span class="line"><span class="built_in">which</span>: no hbase <span class="keyword">in</span> (/usr/<span class="built_in">local</span>/bin:/usr/bin:/usr/<span class="built_in">local</span>/sbin:/usr/sbin:/opt/module/jdk1.8.0_212/bin:/opt/module/ha-hadoop-3.1.3/bin:/opt/module/ha-hadoop-3.1.3/sbin:/opt/module/hive-3.1.2/bin:/home/atguigu/.<span class="built_in">local</span>/bin:/home/atguigu/bin)</span><br><span class="line">Hive Session ID = ccd1a72b-c24a-4b49-9583-1601fa1f7a34</span><br><span class="line">usage: hive</span><br><span class="line"> -d,--define &lt;key=value&gt;          Variable substitution to apply to Hive</span><br><span class="line">                                  commands. e.g. -d A=B or --define A=B</span><br><span class="line">    --database &lt;databasename&gt;     Specify the database to use</span><br><span class="line"> -e &lt;quoted-query-string&gt;         SQL from <span class="built_in">command</span> line</span><br><span class="line"> -f &lt;filename&gt;                    SQL from files</span><br><span class="line"> -H,--<span class="built_in">help</span>                        Print <span class="built_in">help</span> information</span><br><span class="line">    --hiveconf &lt;property=value&gt;   Use value <span class="keyword">for</span> given property</span><br><span class="line">    --hivevar &lt;key=value&gt;         Variable substitution to apply to Hive</span><br><span class="line">                                  commands. e.g. --hivevar A=B</span><br><span class="line"> -i &lt;filename&gt;                    Initialization SQL file</span><br><span class="line"> -S,--silent                      Silent mode <span class="keyword">in</span> interactive shell</span><br><span class="line"> -v,--verbose                     Verbose mode (<span class="built_in">echo</span> executed SQL to the</span><br><span class="line">                                  console)</span><br><span class="line">[atguigu@hadoop001 hive]$</span><br></pre></td></tr></table></figure>
<ol>
<li>“-e”不进入hive的交互窗口执行sql语句 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 hive]$ hive -e <span class="string">&#x27;select count(1) from test_3&#x27;</span></span><br><span class="line"><span class="built_in">which</span>: no hbase <span class="keyword">in</span> (/usr/<span class="built_in">local</span>/bin:/usr/bin:/usr/<span class="built_in">local</span>/sbin:/usr/sbin:/opt/module/jdk1.8.0_212/bin:/opt/module/ha-hadoop-3.1.3/bin:/opt/module/ha-hadoop-3.1.3/sbin:/opt/module/hive-3.1.2/bin:/home/atguigu/.<span class="built_in">local</span>/bin:/home/atguigu/bin)</span><br><span class="line">Hive Session ID = 8eeed838-5d5e-4ed4-a252-29f85e7f15f3</span><br><span class="line"></span><br><span class="line">Logging initialized using configuration <span class="keyword">in</span> jar:file:/opt/module/hive-3.1.2/lib/hive-common-3.1.2.jar!/hive-log4j2.properties Async: <span class="literal">true</span></span><br><span class="line">Hive Session ID = c1c58f1c-71c4-4869-9f5e-8dc2a4ac52f4</span><br><span class="line">OK</span><br><span class="line">32</span><br><span class="line">Time taken: 1.972 seconds, Fetched: 1 row(s)</span><br><span class="line">[atguigu@hadoop001 hive]$</span><br></pre></td></tr></table></figure></li>
<li>-f”执行脚本中sql语句 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 hive]$ ls</span><br><span class="line">selectall.sql</span><br><span class="line"><span class="comment"># 编写sql脚本</span></span><br><span class="line">[atguigu@hadoop001 hive]$ cat selectall.sql</span><br><span class="line">select count(1) from test_3</span><br><span class="line"><span class="comment"># 使用-f执行脚本</span></span><br><span class="line">[atguigu@hadoop001 hive]$ hive -f selectall.sql</span><br><span class="line"><span class="built_in">which</span>: no hbase <span class="keyword">in</span> (/usr/<span class="built_in">local</span>/bin:/usr/bin:/usr/<span class="built_in">local</span>/sbin:/usr/sbin:/opt/module/jdk1.8.0_212/bin:/opt/module/ha-hadoop-3.1.3/bin:/opt/module/ha-hadoop-3.1.3/sbin:/opt/module/hive-3.1.2/bin:/home/atguigu/.<span class="built_in">local</span>/bin:/home/atguigu/bin)</span><br><span class="line">Hive Session ID = 2b43ecf4-1fd8-4bd1-be10-60adaad0ffa4</span><br><span class="line"></span><br><span class="line">Logging initialized using configuration <span class="keyword">in</span> jar:file:/opt/module/hive-3.1.2/lib/hive-common-3.1.2.jar!/hive-log4j2.properties Async: <span class="literal">true</span></span><br><span class="line">Hive Session ID = a07efeea-d038-4ca8-b342-7b001f1493d7</span><br><span class="line">OK</span><br><span class="line">32</span><br><span class="line">Time taken: 1.954 seconds, Fetched: 1 row(s)</span><br><span class="line">[atguigu@hadoop001 hive]$</span><br><span class="line"><span class="comment"># 执行并导出文件</span></span><br><span class="line">[atguigu@hadoop001 hive]$ hive -f selectall.sql &gt; selectall.txt</span><br><span class="line"><span class="built_in">which</span>: no hbase <span class="keyword">in</span> (/usr/<span class="built_in">local</span>/bin:/usr/bin:/usr/<span class="built_in">local</span>/sbin:/usr/sbin:/opt/module/jdk1.8.0_212/bin:/opt/module/ha-hadoop-3.1.3/bin:/opt/module/ha-hadoop-3.1.3/sbin:/opt/module/hive-3.1.2/bin:/home/atguigu/.<span class="built_in">local</span>/bin:/home/atguigu/bin)</span><br><span class="line">Hive Session ID = 13cd6a52-4af8-4234-86bf-70841d565b98</span><br><span class="line"></span><br><span class="line">Logging initialized using configuration <span class="keyword">in</span> jar:file:/opt/module/hive-3.1.2/lib/hive-common-3.1.2.jar!/hive-log4j2.properties Async: <span class="literal">true</span></span><br><span class="line">Hive Session ID = 9279ee4e-997c-4a92-b258-11ac8c0beaa6</span><br><span class="line">OK</span><br><span class="line">Time taken: 1.953 seconds, Fetched: 1 row(s)</span><br><span class="line">[atguigu@hadoop001 hive]$ cat selectall.txt</span><br><span class="line">32</span><br><span class="line">[atguigu@hadoop001 hive]$</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="2-7-Hive其他命令操作"><a href="#2-7-Hive其他命令操作" class="headerlink" title="2.7 Hive其他命令操作"></a>2.7 Hive其他命令操作</h2><ol>
<li>退出hive窗口： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hive(default)&gt;<span class="built_in">exit</span>;</span><br><span class="line">hive(default)&gt;quit;</span><br></pre></td></tr></table></figure>
<ul>
<li>在新版的hive中没区别了，在以前的版本是有的：</li>
<li>exit:先隐性提交数据，再退出；</li>
<li>quit:不提交数据，退出；</li>
</ul>
</li>
<li>在hive cli命令窗口中如何查看hdfs文件系统 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; dfs -ls /user;</span><br><span class="line">Found 1 items</span><br><span class="line">drwxr-xr-x   - atguigu supergroup          0 2021-10-20 14:52 /user/hive</span><br><span class="line">hive&gt; dfs -ls /user/hive;</span><br><span class="line">Found 1 items</span><br><span class="line">drwxr-xr-x   - atguigu supergroup          0 2021-10-20 15:48 /user/hive/warehouse</span><br><span class="line">hive&gt; dfs -ls /user/hive/warehouse;</span><br><span class="line">Found 3 items</span><br><span class="line">drwxr-xr-x   - atguigu supergroup          0 2021-10-20 15:40 /user/hive/warehouse/<span class="built_in">test</span></span><br><span class="line">drwxr-xr-x   - atguigu supergroup          0 2021-10-20 15:43 /user/hive/warehouse/test_2</span><br><span class="line">drwxr-xr-x   - atguigu supergroup          0 2021-10-22 15:06 /user/hive/warehouse/test_3</span><br><span class="line">hive&gt;</span><br></pre></td></tr></table></figure></li>
<li>查看在hive中输入的所有历史命令,用户home目录下.hivehistory文件,~/.hivehistory <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 ~]$ head -n 10 ~/.hivehistory</span><br><span class="line">show databases;</span><br><span class="line">create table <span class="built_in">test</span> (id int);</span><br><span class="line">show database;</span><br><span class="line">show databases;</span><br><span class="line">ls</span><br><span class="line">show databases;</span><br><span class="line">quit;</span><br><span class="line">show databases;</span><br><span class="line">quit</span><br><span class="line">;</span><br><span class="line">[atguigu@hadoop001 ~]$</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="2-8-Hive常见属性配置"><a href="#2-8-Hive常见属性配置" class="headerlink" title="2.8 Hive常见属性配置"></a>2.8 Hive常见属性配置</h2><h3 id="2-8-1-hive窗口打印默认库和表头"><a href="#2-8-1-hive窗口打印默认库和表头" class="headerlink" title="2.8.1 hive窗口打印默认库和表头"></a>2.8.1 hive窗口打印默认库和表头</h3><ol>
<li>打印 当前库 和 表头 hive-site.xml中加入如下两个配置:  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.cli.print.header<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.cli.print.current.db<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test_2;</span><br><span class="line">OK</span><br><span class="line">test_2.id	test_2.name</span><br><span class="line"><span class="number">123</span>	zhangsan</span><br><span class="line"><span class="type">Time</span> taken: <span class="number">0.106</span> seconds, Fetched: <span class="number">1</span> <span class="type">row</span>(s)</span><br><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="2-8-2-Hive运行日志信息配置"><a href="#2-8-2-Hive运行日志信息配置" class="headerlink" title="2.8.2 Hive运行日志信息配置"></a>2.8.2 Hive运行日志信息配置</h3></li>
<li>Hive的log默认存放在/tmp/atguigu/hive.log目录下（当前用户名下）</li>
<li>修改hive的log存放日志到/opt/module/hive-3.1.2/logs<ol>
<li>修改/opt/module/hive/conf/hive-log4j2.properties.template文件名称为hive-log4j2.properties <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop102 conf]$ <span class="built_in">pwd</span></span><br><span class="line">/opt/module/hive/conf</span><br><span class="line">[atguigu@hadoop102 conf]$ mv hive-log4j2.properties.template hive-log4j2.properties</span><br></pre></td></tr></table></figure></li>
<li>在hive-log4j.properties文件中修改log存放位置 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">property.hive.log.dir=/opt/module/hive/logs</span><br></pre></td></tr></table></figure>
<h3 id="2-8-2-参数配置方式"><a href="#2-8-2-参数配置方式" class="headerlink" title="2.8.2 参数配置方式"></a>2.8.2 参数配置方式</h3></li>
</ol>
</li>
<li>查看当前所有的配置信息 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive<span class="operator">&gt;</span><span class="keyword">set</span>;</span><br></pre></td></tr></table></figure></li>
<li>参数的配置三种方式<ol>
<li>配置文件方式<ul>
<li>默认配置文件：hive-default.xml </li>
<li>用户自定义配置文件：hive-site.xml</li>
<li>注意：用户自定义配置会覆盖默认配置。另外，Hive也会读入Hadoop的配置，因为Hive是作为Hadoop的客户端启动的，Hive的配置会覆盖Hadoop的配置。配置文件的设定对本机启动的所有Hive进程都有效。</li>
</ul>
</li>
<li>命令行参数方式<ul>
<li>启动Hive时，可以在命令行添加-hiveconf param=value来设定参数。</li>
<li>例如：  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop103 hive]$ bin/hive -hiveconf mapred.reduce.tasks=10;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>注意：仅对本次hive启动有效。查看参数设置：  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">set</span> mapred.reduce.tasks;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>参数声明方式<ul>
<li>可以在HQL中使用SET关键字设定参数</li>
<li>例如：  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">set</span> mapred.reduce.tasks<span class="operator">=</span><span class="number">100</span>;</span><br></pre></td></tr></table></figure></li>
<li>注意：仅对本次hive启动有效。查看参数设置  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">set</span> mapred.reduce.tasks;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>上述三种设定方式的优先级依次递增。即default配置文件&lt;hive-site.x配置文件&lt;命令行参数&lt;参数声明。注意某些系统级的参数，例如log4j相关的设定，必须用前两种方式设定，因为那些参数的读取在会话建立以前已经完成了。</li>
</ol>
</li>
</ol>
<h1 id="三、Hive数据类型"><a href="#三、Hive数据类型" class="headerlink" title="三、Hive数据类型"></a>三、Hive数据类型</h1><h2 id="3-1-基本数据类型"><a href="#3-1-基本数据类型" class="headerlink" title="3.1 基本数据类型"></a>3.1 基本数据类型</h2><table>
<thead>
<tr>
<th>Hive数据类型</th>
<th>Java数据类型</th>
<th>长度</th>
</tr>
</thead>
<tbody><tr>
<td>TINYINT</td>
<td>byte</td>
<td>1byte有符号整数</td>
</tr>
<tr>
<td>SMALINT</td>
<td>short</td>
<td>2byte有符号整数</td>
</tr>
<tr>
<td>INT</td>
<td>int</td>
<td>4byte有符号整数</td>
</tr>
<tr>
<td>BIGINT</td>
<td>long</td>
<td>8byte有符号整数</td>
</tr>
<tr>
<td>BOOLEAN</td>
<td>boolean</td>
<td>布尔类型</td>
</tr>
<tr>
<td>FLOAT</td>
<td>float</td>
<td>单精度浮点数</td>
</tr>
<tr>
<td>DOUBLE</td>
<td>double</td>
<td>双精度浮点数</td>
</tr>
<tr>
<td>STRING</td>
<td>string</td>
<td>字符系列。可以指定字符集。使用单引号或者双引号</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>Dat</td>
<td>时间类型</td>
</tr>
<tr>
<td>BINARY</td>
<td></td>
<td>字节数组</td>
</tr>
</tbody></table>
<ul>
<li>对于Hive的String类型相当于数据库的varchar类型，该类型是一个可变的字符串，不过它不能声明其中最多能存储多少个字符，理论上它可以存储2GB的字符数</li>
</ul>
<h2 id="3-2-集合数据类型"><a href="#3-2-集合数据类型" class="headerlink" title="3.2 集合数据类型"></a>3.2 集合数据类型</h2><table>
<thead>
<tr>
<th>数据类型</th>
<th>描述</th>
<th>语法示例</th>
</tr>
</thead>
<tbody><tr>
<td>STRUCT</td>
<td>和c语言中的struct类似，都可以通过“点”符号访问元素内容。例如，如果某个列的数据类型是STRUCT{first STRING, last STRING},那么第1个元素可以通过字段.first来引用。</td>
<td>struct()<br> 例如struct&lt;street:string, city:string&gt;</td>
</tr>
<tr>
<td>MAP</td>
<td>MAP是一组键-值对元组集合，使用数组表示法可以访问数据。例如，如果某个列的数据类型是MAP，其中键-&gt;值对是’first’-&gt;’John’和’last’-&gt;’Doe’，那么可以通过字段名[‘last’]获取最后一个元素</td>
<td>map()<br>例如map&lt;string, int&gt;</td>
</tr>
<tr>
<td>ARRAY</td>
<td>数组是一组具有相同类型和名称的变量的集合。这些变量称为数组的元素，每个数组元素都有一个编号，编号从零开始。例如，数组值为[‘John’, ‘Doe’]，那么第2个元素可以通过数组名[1]进行引用。</td>
<td>Array()<br>例如array<string></td>
</tr>
</tbody></table>
<ul>
<li>Hive有三种复杂数据类型ARRAY、MAP 和 STRUCT。ARRAY和MAP与Java中的Array和Map类似，而STRUCT与C语言中的Struct类似，它封装了一个命名字段集合，复杂数据类型允许任意层次的嵌套</li>
</ul>
<ol>
<li>数据类型实操<ol>
<li>数据示例 <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;songsong&quot;</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="attr">&quot;friends&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;bingbing&quot;</span>,</span><br><span class="line">        <span class="string">&quot;lili&quot;</span></span><br><span class="line">    ], </span><br><span class="line">    <span class="attr">&quot;children&quot;</span>: &#123; </span><br><span class="line">        <span class="attr">&quot;xiao song&quot;</span>: <span class="number">19</span>,</span><br><span class="line">        <span class="attr">&quot;xiaoxiao song&quot;</span>: <span class="number">18</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;address&quot;</span>: &#123; </span><br><span class="line">        <span class="attr">&quot;street&quot;</span>: <span class="string">&quot;hui long guan&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;city&quot;</span>: <span class="string">&quot;beijing&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;zip&quot;</span>: <span class="number">1000001</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>基于上述数据结构，在Hive里创建对应的表，并导入数据 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">test.txt</span><br><span class="line">songsong,bingbing_lili,xiao song:18_xiaoxiao song:19,hui long guan_beijing_1000001</span><br><span class="line">yangyang,caicai_susu,xiao yang:18_xiaoxiao yang:19,chao yang_beijing_1000001</span><br></pre></td></tr></table></figure>
<ul>
<li>注意：MAP，STRUCT和ARRAY里的元素间关系都可以用同一个字符表示，这里用“_”。</li>
</ul>
</li>
<li>Hive上创建测试表user <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> person_info (</span><br><span class="line">    name     string,</span><br><span class="line">    friends  <span class="keyword">array</span><span class="operator">&lt;</span>string<span class="operator">&gt;</span>,</span><br><span class="line">    children map<span class="operator">&lt;</span>string, <span class="type">int</span><span class="operator">&gt;</span>,</span><br><span class="line">    address  struct<span class="operator">&lt;</span>street:string, city:string, zip:<span class="type">int</span><span class="operator">&gt;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment">-- 列分隔符</span></span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span></span><br><span class="line"><span class="comment">-- MAP STRUCT 和 ARRAY 的分隔符(数据分割符号)</span></span><br><span class="line">collection items terminated <span class="keyword">by</span> <span class="string">&#x27;_&#x27;</span></span><br><span class="line"><span class="comment">-- MAP中的key与value的分隔符</span></span><br><span class="line">map keys terminated <span class="keyword">by</span> <span class="string">&#x27;:&#x27;</span></span><br><span class="line"><span class="comment">-- 行分隔符</span></span><br><span class="line">lines terminated <span class="keyword">by</span> <span class="string">&#x27;\n&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li>导入数据 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> load data <span class="keyword">local</span> inpath <span class="string">&#x27;/home/atguigu/hive/user.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> person_info;</span><br><span class="line">Loading data <span class="keyword">to</span> <span class="keyword">table</span> default.user_test</span><br><span class="line">OK</span><br><span class="line"><span class="type">Time</span> taken: <span class="number">0.873</span> seconds</span><br><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>查看数据 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> person_info <span class="keyword">where</span> friends[<span class="number">1</span>]<span class="operator">=</span><span class="string">&#x27;lili&#x27;</span> <span class="keyword">and</span> address.city<span class="operator">=</span><span class="string">&#x27;beijing&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+----------------------+--------------------------------------+----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> person_info.name  <span class="operator">|</span> person_info.friends  <span class="operator">|</span>         person_info.children         <span class="operator">|</span>                person_info.address                 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+----------------------+--------------------------------------+----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> songsong          <span class="operator">|</span> [&quot;bingbing&quot;,&quot;lili&quot;]  <span class="operator">|</span> &#123;&quot;xiao song&quot;:<span class="number">18</span>,&quot;xiaoxiao song&quot;:<span class="number">19</span>&#125;  <span class="operator">|</span> &#123;&quot;street&quot;:&quot;hui long guan&quot;,&quot;city&quot;:&quot;beijing&quot;,&quot;zip&quot;:<span class="number">1000001</span>&#125; <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+----------------------+--------------------------------------+----------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.076</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<h2 id="3-3-类型转化"><a href="#3-3-类型转化" class="headerlink" title="3.3 类型转化"></a>3.3 类型转化</h2><p>Hive的原生数据类型是可以进行隐式转换的，类似于Java的类型转换，例如某表达式使用INT类型，TINYINT会自动转换为INT类型，但是Hive不会进行反向转化，例如，某表达式使用TINYINT类型，INT不会自动转换为TINYINT类型，它会返回错误，除非使用CAST操作。</p>
<ol>
<li>隐式类型转换规则如下<ul>
<li>任何整数类型都可以隐式地转换为一个范围更广的类型，如TINYINT可以转换成INT，INT可以转换成BIGINT。</li>
<li>所有整数类型、FLOAT和STRING类型都可以隐式地转换成DOUBLE。</li>
<li>TINYINT、SMALLINT、INT都可以转换为FLOAT。</li>
<li>BOOLEAN类型不可以转换为任何其它的类型。</li>
</ul>
</li>
<li>可以使用CAST操作显示进行数据类型转换<ul>
<li>例如CAST(‘1’ AS INT)将把字符串’1’ 转换成整数1；如果强制类型转换失败，如执行CAST(‘X’ AS INT)，表达式返回空值 NULL。  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="number">1</span><span class="operator">+</span><span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> _c0  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2.0</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.098</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="number">1</span><span class="operator">+</span><span class="built_in">cast</span>(<span class="string">&#x27;1&#x27;</span> <span class="keyword">as</span> <span class="type">int</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> _c0  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.087</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="number">1</span><span class="operator">+</span><span class="built_in">cast</span>(<span class="string">&#x27;x&#x27;</span> <span class="keyword">as</span> <span class="type">int</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span>  _c0  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.096</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h1 id="四、DDL数据库定义操作"><a href="#四、DDL数据库定义操作" class="headerlink" title="四、DDL数据库定义操作"></a>四、DDL数据库定义操作</h1><h2 id="4-1-创建数据库"><a href="#4-1-创建数据库" class="headerlink" title="4.1 创建数据库"></a>4.1 创建数据库</h2><ul>
<li>格式  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] database_name</span><br><span class="line">[COMMENT database_comment]</span><br><span class="line">[LOCATION hdfs_path]</span><br><span class="line">[<span class="keyword">WITH</span> DBPROPERTIES (property_name<span class="operator">=</span>property_value, ...)];</span><br></pre></td></tr></table></figure></li>
</ul>
<ol>
<li>创建一个数据库，数据库在HDFS上的默认存储路径是/user/hive/warehouse/*.db。 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">create</span> database hive_id;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.108</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> database_name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">default</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> hive_id        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> selected (<span class="number">0.044</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>避免要创建的数据库已经存在错误，增加if not exists判断。（标准写法） <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> database_name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">default</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> hive_id        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> selected (<span class="number">0.044</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">create</span> database hive_id;</span><br><span class="line">Error: Error while processing statement: FAILED: Execution Error, <span class="keyword">return</span> code <span class="number">1</span> <span class="keyword">from</span> org.apache.hadoop.hive.ql.exec.DDLTask. Database hive_id already <span class="keyword">exists</span> (state<span class="operator">=</span><span class="number">42000</span>,code<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> hive_id;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.031</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> database_name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">default</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> hive_id        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> selected (<span class="number">0.03</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>创建一个数据库，指定数据库在HDFS上存放的位置 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> database_test location <span class="string">&#x27;/hive/db/test/location/location_test_db.db&#x27;</span> <span class="keyword">with</span> dbproperties (<span class="string">&#x27;author&#x27;</span><span class="operator">=</span><span class="string">&#x27;anzhen&#x27;</span>, <span class="string">&#x27;create_time&#x27;</span><span class="operator">=</span><span class="string">&#x27;2021/10/25&#x27;</span>);</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.057</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="operator">|</span>   database_name   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">default</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> hive_id           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> location_test_db  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> selected (<span class="number">0.027</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> dfs <span class="operator">-</span>ls <span class="operator">/</span>hive<span class="operator">/</span>db<span class="operator">/</span>test<span class="operator">/</span>location<span class="operator">/</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                     DFS Output                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Found <span class="number">1</span> items                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> drwxr<span class="operator">-</span>xr<span class="operator">-</span>x   <span class="operator">-</span> atguigu supergroup          <span class="number">0</span> <span class="number">2021</span><span class="number">-10</span><span class="number">-22</span> <span class="number">17</span>:<span class="number">11</span> <span class="operator">/</span>hive<span class="operator">/</span>db<span class="operator">/</span>test<span class="operator">/</span>location<span class="operator">/</span>location_test_db.db <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> selected (<span class="number">0.011</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="4-2-查询数据库"><a href="#4-2-查询数据库" class="headerlink" title="4.2 查询数据库"></a>4.2 查询数据库</h2></li>
<li>2.1 显示数据库</li>
<li>显示数据库 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="operator">|</span>   database_name   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">default</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> hive_id           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> location_test_db  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> selected (<span class="number">0.096</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>过滤显示查询的数据库 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> databases <span class="keyword">like</span> <span class="string">&#x27;l*&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="operator">|</span>   database_name   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="operator">|</span> location_test_db  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.025</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-2-2-查看数据库详情"><a href="#4-2-2-查看数据库详情" class="headerlink" title="4.2.2 查看数据库详情"></a>4.2.2 查看数据库详情</h3></li>
<li>显示数据库信息 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">desc</span> database location_test_db;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+----------+----------------------------------------------------+-------------+-------------+-------------+</span></span><br><span class="line"><span class="operator">|</span>      db_name      <span class="operator">|</span> comment  <span class="operator">|</span>                      location                      <span class="operator">|</span> owner_name  <span class="operator">|</span> owner_type  <span class="operator">|</span> parameters  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+----------+----------------------------------------------------+-------------+-------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> location_test_db  <span class="operator">|</span>          <span class="operator">|</span> hdfs:<span class="operator">/</span><span class="operator">/</span>mycluster<span class="operator">/</span>hive<span class="operator">/</span>db<span class="operator">/</span>test<span class="operator">/</span>location<span class="operator">/</span>location_test_db.db <span class="operator">|</span> atguigu     <span class="operator">|</span> <span class="keyword">USER</span>        <span class="operator">|</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+----------+----------------------------------------------------+-------------+-------------+-------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.037</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>显示数据库详细信息，extended <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">desc</span> database EXTENDED database_test;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+----------+----------------------------------------------------+-------------+-------------+------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>    db_name     <span class="operator">|</span> comment  <span class="operator">|</span>                      location                      <span class="operator">|</span> owner_name  <span class="operator">|</span> owner_type  <span class="operator">|</span>                parameters                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+----------+----------------------------------------------------+-------------+-------------+------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> database_test  <span class="operator">|</span>          <span class="operator">|</span> hdfs:<span class="operator">/</span><span class="operator">/</span>mycluster<span class="operator">/</span>hive<span class="operator">/</span>db<span class="operator">/</span>test<span class="operator">/</span>location<span class="operator">/</span>location_test_db.db <span class="operator">|</span> atguigu     <span class="operator">|</span> <span class="keyword">USER</span>        <span class="operator">|</span> &#123;create_time<span class="operator">=</span><span class="number">2021</span><span class="operator">/</span><span class="number">10</span><span class="operator">/</span><span class="number">25</span>, author<span class="operator">=</span>anzhen&#125;  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+----------+----------------------------------------------------+-------------+-------------+------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.019</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-2-3-切换当前数据库"><a href="#4-2-3-切换当前数据库" class="headerlink" title="4.2.3 切换当前数据库"></a>4.2.3 切换当前数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> use location_test_db;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.026</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> use hive_id;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.022</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="4-3-修改数据库"><a href="#4-3-修改数据库" class="headerlink" title="4.3 修改数据库"></a>4.3 修改数据库</h2></li>
<li>用户可以使用ALTER DATABASE命令为某个数据库的DBPROPERTIES设置键-值对属性值，来描述这个数据库的属性信息。 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">alter</span> database location_test_db <span class="keyword">set</span> dbproperties(<span class="string">&#x27;createtile&#x27;</span><span class="operator">=</span><span class="string">&#x27;20211022&#x27;</span>);</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.069</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">desc</span> database extended location_test_db;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+----------+----------------------------------------------------+-------------+-------------+------------------------+</span></span><br><span class="line"><span class="operator">|</span>      db_name      <span class="operator">|</span> comment  <span class="operator">|</span>                      location                      <span class="operator">|</span> owner_name  <span class="operator">|</span> owner_type  <span class="operator">|</span>       parameters       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+----------+----------------------------------------------------+-------------+-------------+------------------------+</span></span><br><span class="line"><span class="operator">|</span> location_test_db  <span class="operator">|</span>          <span class="operator">|</span> hdfs:<span class="operator">/</span><span class="operator">/</span>mycluster<span class="operator">/</span>hive<span class="operator">/</span>db<span class="operator">/</span>test<span class="operator">/</span>location<span class="operator">/</span>location_test_db.db <span class="operator">|</span> atguigu     <span class="operator">|</span> <span class="keyword">USER</span>        <span class="operator">|</span> &#123;createtile<span class="operator">=</span><span class="number">20211022</span>&#125;  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+----------+----------------------------------------------------+-------------+-------------+------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.023</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="4-4-删除数据库"><a href="#4-4-删除数据库" class="headerlink" title="4.4 删除数据库"></a>4.4 删除数据库</h2><ol>
<li>删除空数据库 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="operator">|</span>   database_name   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">default</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> hive_id           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> location_test_db  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> selected (<span class="number">0.026</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">drop</span> database location_test_db;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.12</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> database_name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">default</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> hive_id        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> selected (<span class="number">0.022</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>如果删除的数据库不存在，最好采用 if exists判断数据库是否存在 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> database_name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">default</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> hive_id        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> selected (<span class="number">0.022</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">drop</span> database location_test_db;</span><br><span class="line">Error: Error while compiling statement: FAILED: SemanticException [Error <span class="number">10072</span>]: Database does <span class="keyword">not</span> exist: location_test_db (state<span class="operator">=</span><span class="number">42000</span>,code<span class="operator">=</span><span class="number">10072</span>)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">drop</span> database if <span class="keyword">exists</span> location_test_db;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.011</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> database_name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">default</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> hive_id        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> selected (<span class="number">0.02</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>如果数据库不为空，可以采用cascade命令，强制删除 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> database_name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">default</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> hive_id        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> selected (<span class="number">0.02</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">create</span> database location_test_db;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.051</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> use location_test_db;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> test(id <span class="type">int</span>,name string);</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.053</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">drop</span> database location_test_db;</span><br><span class="line">Error: Error while processing statement: FAILED: Execution Error, <span class="keyword">return</span> code <span class="number">1</span> <span class="keyword">from</span> org.apache.hadoop.hive.ql.exec.DDLTask. InvalidOperationException(message:Database location_test_db <span class="keyword">is</span> <span class="keyword">not</span> empty. <span class="keyword">One</span> <span class="keyword">or</span> more tables exist.) (state<span class="operator">=</span><span class="number">08</span>S01,code<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">drop</span> database location_test_db cascade;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.31</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> database_name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">default</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> hive_id        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> selected (<span class="number">0.02</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="4-5-创建表"><a href="#4-5-创建表" class="headerlink" title="4.5 创建表"></a>4.5 创建表</h2><ol>
<li>建表语法 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> [<span class="keyword">EXTERNAL</span>] <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] table_name </span><br><span class="line">[(col_name data_type [COMMENT col_comment], ...)] </span><br><span class="line">[COMMENT table_comment] </span><br><span class="line">[PARTITIONED <span class="keyword">BY</span> (col_name data_type [COMMENT col_comment], ...)] </span><br><span class="line">[CLUSTERED <span class="keyword">BY</span> (col_name, col_name, ...) </span><br><span class="line">[SORTED <span class="keyword">BY</span> (col_name [<span class="keyword">ASC</span><span class="operator">|</span><span class="keyword">DESC</span>], ...)] <span class="keyword">INTO</span> num_buckets BUCKETS] </span><br><span class="line">[<span class="type">ROW</span> FORMAT row_format] </span><br><span class="line">[STORED <span class="keyword">AS</span> file_format] </span><br><span class="line">[LOCATION hdfs_path]</span><br><span class="line">[TBLPROPERTIES (property_name<span class="operator">=</span>property_value, ...)]</span><br><span class="line">[<span class="keyword">AS</span> select_statement]</span><br></pre></td></tr></table></figure></li>
<li>字段解释说明 <ol>
<li><code>CREATE TABLE</code>: 创建一个指定名字的表。如果相同名字的表已经存在，则抛出异常；用户可以用<code>IF NOT EXISTS</code>选项来忽略这个异常。</li>
<li><code>EXTERNAL</code>: 关键字可以让用户创建一个外部表，在建表的同时可以指定一个指向实际数据的路径（<code>LOCATION</code>），<font color ='red' >在删除表的时候，内部表的元数据和数据会被一起删除，而外部表只删除元数据，不删除数据</font>。</li>
<li><code>COMMENT</code>: 为表和列添加注释。</li>
<li><code>PARTITIONED BY</code>: 指定分区表的规范</li>
<li><code>CLUSTERED BY</code>: 指定分桶表的规范</li>
<li><code>SORTED BY</code>: 指定单签表默认排序规则及粪桶数量</li>
<li><code>ROW FORMAT DELIMITED</code>: 定义每一行中字段之间的分隔符</li>
<li><code>collection items terminated by</code>: 集合数据类型，元素之间的分隔符</li>
<li><code>map keys terminated by</code>: map数据类型key-value分隔符</li>
<li><code>lines terminated by</code>: 每一行的分隔符</li>
<li><code>STORED AS</code>: 指定存储文件类型<ul>
<li>常用的存储文件类型：SEQUENCEFILE（二进制序列文件）、TEXTFILE（文本）、RCFILE（列式存储格式文件）</li>
<li>如果文件数据是纯文本，可以使用STORED AS TEXTFILE。如果数据需要压缩，使用 STORED AS SEQUENCEFILE。</li>
</ul>
</li>
<li><code>LOCATION</code>: 指定表在HDFS上的存储位置。</li>
<li><code>AS select_statement</code>: 后跟查询语句，根据查询结果创建表。</li>
<li><code>LIKE</code>: 允许用户复制现有的表结构，但是不复制数据。</li>
</ol>
</li>
</ol>
<h3 id="4-5-1-管理表-内部表"><a href="#4-5-1-管理表-内部表" class="headerlink" title="4.5.1 管理表(内部表)"></a>4.5.1 管理表(内部表)</h3><ol>
<li>理论<ul>
<li>默认创建的表都是所谓的管理表，有时也被称为内部表。因为这种表，Hive会（或多或少地）控制着数据的生命周期。Hive默认情况下会将这些表的数据存储在由配置项hive.metastore.warehouse.dir(例如，/user/hive/warehouse)所定义的目录的子目录下。当我们<font color ='red' >删除一个管理表时，Hive也会删除这个表中数据。管理表不适合和其他工具共享数据</font>。</li>
</ul>
</li>
<li>案例实操<ol>
<li>原始数据 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1001	ss1</span><br><span class="line">1002	ss2</span><br><span class="line">1003	ss3</span><br><span class="line">1004	ss4</span><br><span class="line">1005	ss5</span><br><span class="line">1006	ss6</span><br><span class="line">1007	ss7</span><br><span class="line">1008	ss8</span><br><span class="line">1009	ss9</span><br><span class="line">1010	ss10</span><br><span class="line">1011	ss11</span><br><span class="line">1012	ss12</span><br><span class="line">1013	ss13</span><br><span class="line">1014	ss14</span><br><span class="line">1015	ss15</span><br><span class="line">1016	ss16</span><br></pre></td></tr></table></figure></li>
<li>普通创建表 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> student (</span><br><span class="line">    id   <span class="type">int</span>,</span><br><span class="line">    name string</span><br><span class="line">)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span></span><br><span class="line">stored <span class="keyword">as</span> textfile</span><br><span class="line">location <span class="string">&#x27;/user/hive/warehouse/student&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li>导入数据 </li>
<li>根据查询结果创建表（查询的结果会添加到新创建的表中） <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> student_copy <span class="keyword">as</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student;</span><br></pre></td></tr></table></figure></li>
<li>根据已经存在的表结构创建表 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> student_copy_like <span class="keyword">like</span> student;</span><br></pre></td></tr></table></figure></li>
<li>查询表的类型 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">desc</span> student;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------------+----------+</span></span><br><span class="line"><span class="operator">|</span> col_name  <span class="operator">|</span> data_type  <span class="operator">|</span> comment  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------------+----------+</span></span><br><span class="line"><span class="operator">|</span> id        <span class="operator">|</span> <span class="type">int</span>        <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> name      <span class="operator">|</span> string     <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------------+----------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> selected (<span class="number">0.101</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-5-2-外部表"><a href="#4-5-2-外部表" class="headerlink" title="4.5.2 外部表"></a>4.5.2 外部表</h3></li>
</ol>
</li>
<li>理论<ul>
<li>因为表是外部表，所以Hive并非认为其完全拥有这份数据。<font color ='red' >删除该表并不会删除掉这份数据，不过描述表的元数据信息会被删除掉</font>。</li>
</ul>
</li>
<li>管理表和外部表的使用场景<ul>
<li>每天将收集到的网站日志定期流入HDFS文本文件。在外部表（原始日志表）的基础上做大量的统计分析，用到的中间表、结果表使用内部表存储，数据通过SELECT+INSERT进入内部表。</li>
</ul>
</li>
<li>案例实操<ul>
<li>分别创建部门和员工外部表，并向表中导入数据。</li>
</ul>
<ol>
<li>原始数据<ul>
<li>dept:  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">10	ACCOUNTING	1700</span><br><span class="line">20	RESEARCH	1800</span><br><span class="line">30	SALES	1900</span><br><span class="line">40	OPERATIONS	1700</span><br></pre></td></tr></table></figure></li>
<li>emp：  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">7369	SMITH	CLERK	7902	1980-12-17	800.00		20</span><br><span class="line">7499	ALLEN	SALESMAN	7698	1981-2-20	1600.00	300.00	30</span><br><span class="line">7521	WARD	SALESMAN	7698	1981-2-22	1250.00	500.00	30</span><br><span class="line">7566	JONES	MANAGER	7839	1981-4-2	2975.00		20</span><br><span class="line">7654	MARTIN	SALESMAN	7698	1981-9-28	1250.00	1400.00	30</span><br><span class="line">7698	BLAKE	MANAGER	7839	1981-5-1	2850.00		30</span><br><span class="line">7782	CLARK	MANAGER	7839	1981-6-9	2450.00		10</span><br><span class="line">7788	SCOTT	ANALYST	7566	1987-4-19	3000.00		20</span><br><span class="line">7839	KING	PRESIDENT		1981-11-17	5000.00		10</span><br><span class="line">7844	TURNER	SALESMAN	7698	1981-9-8	1500.00	0.00	30</span><br><span class="line">7876	ADAMS	CLERK	7788	1987-5-23	1100.00		20</span><br><span class="line">7900	JAMES	CLERK	7698	1981-12-3	950.00		30</span><br><span class="line">7902	FORD	ANALYST	7566	1981-12-3	3000.00		20</span><br><span class="line">7934	MILLER	CLERK	7782	1982-1-23	1300.00		10</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>上传数据到HDFS <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 hive]$ hadoop fs -put dep.txt /hive/source_data/</span><br><span class="line">[atguigu@hadoop001 hive]$ hadoop fs -put emp.txt /hive/source_data/</span><br><span class="line">[atguigu@hadoop001 hive]$ hadoop fs -ls /hive/source_data</span><br><span class="line">Found 2 items</span><br><span class="line">-rw-r--r--   3 atguigu supergroup         69 2021-10-25 13:15 /hive/source_data/dep.txt</span><br><span class="line">-rw-r--r--   3 atguigu supergroup        657 2021-10-25 13:15 /hive/source_data/emp.txt</span><br><span class="line">[atguigu@hadoop001 hive]$</span><br></pre></td></tr></table></figure></li>
<li>建表语句，创建外部表<ul>
<li>创建部门表  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> dept (</span><br><span class="line">    dept_no <span class="type">int</span>,</span><br><span class="line">    dept_name  string,</span><br><span class="line">    loc    <span class="type">int</span></span><br><span class="line">)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li>创建员工表  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> emp (</span><br><span class="line">    emp_no    <span class="type">int</span>,</span><br><span class="line">    emp_name  string,</span><br><span class="line">    job       string,</span><br><span class="line">    mgr       <span class="type">int</span>,</span><br><span class="line">    hire_date string,</span><br><span class="line">    sal       <span class="keyword">double</span>,</span><br><span class="line">    comm      <span class="keyword">double</span>,</span><br><span class="line">    dept_no   <span class="type">int</span></span><br><span class="line">)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li>查看表格式化数据  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:hive2://hadoop001:10000&gt; desc formatted dept;</span><br><span class="line">+---------------+------------------+--------+</span><br><span class="line">| col_name      | data_type        | comment|</span><br><span class="line">+---------------+------------------+--------+</span><br><span class="line">···</span><br><span class="line">···</span><br><span class="line">| Table Type:   | EXTERNAL_TABLE   | NULL   |</span><br><span class="line">···</span><br><span class="line">···</span><br><span class="line">+---------------+------------------+--------+</span><br><span class="line">35 rows selected (0.054 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>导入数据 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:hive2://hadoop001:10000&gt; load data inpath <span class="string">&#x27;/hive/source_data/dep.txt&#x27;</span> into table mock_data.dept;</span><br><span class="line">No rows affected (0.132 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt; load data inpath <span class="string">&#x27;/hive/source_data/emp.txt&#x27;</span> into table mock_data.emp;</span><br><span class="line">No rows affected (0.095 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt; select count(1) from mock_data.emp;</span><br><span class="line">+------+</span><br><span class="line">| _c0  |</span><br><span class="line">+------+</span><br><span class="line">| 14   |</span><br><span class="line">+------+</span><br><span class="line">1 row selected (14.939 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt; select count(1) from mock_data.dept;</span><br><span class="line">+------+</span><br><span class="line">| _c0  |</span><br><span class="line">+------+</span><br><span class="line">| 4    |</span><br><span class="line">+------+</span><br><span class="line">1 row selected (13.836 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt;</span><br></pre></td></tr></table></figure></li>
<li>删除外部表后，hdfs中的数据还在，但是metadata中dept的元数据已被删除 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">table</span> mock_data.dept;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.097</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span>      tab_name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> emp                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> person             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> person_info        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> student            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> student_copy_as    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> student_copy_like  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> selected (<span class="number">0.02</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> dfs <span class="operator">-</span>ls <span class="operator">/</span><span class="keyword">user</span><span class="operator">/</span>hive<span class="operator">/</span>warehouse<span class="operator">/</span>mock_data.db<span class="operator">/</span>dept;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                     DFS Output                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Found <span class="number">1</span> items                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--   3 atguigu supergroup         69 2021-10-25 13:15 /user/hive/warehouse/mock_data.db/dept/dep.txt |</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> selected (<span class="number">0.042</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>重建表，再次查询 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> dept (</span><br><span class="line">     dept_no <span class="type">int</span>,</span><br><span class="line">     dept_name  string,</span><br><span class="line">     loc    <span class="type">int</span></span><br><span class="line"> )</span><br><span class="line"> <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.039</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> tables ;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span>      tab_name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> dept               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> emp                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> person             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> person_info        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> student            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> student_copy_as    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> student_copy_like  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> selected (<span class="number">0.021</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dept;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> dept.dept_no  <span class="operator">|</span> dept.dept_name  <span class="operator">|</span> dept.loc  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span>            <span class="operator">|</span> ACCOUNTING      <span class="operator">|</span> <span class="number">1700</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span>            <span class="operator">|</span> RESEARCH        <span class="operator">|</span> <span class="number">1800</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">30</span>            <span class="operator">|</span> SALES           <span class="operator">|</span> <span class="number">1900</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">40</span>            <span class="operator">|</span> OPERATIONS      <span class="operator">|</span> <span class="number">1700</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+-----------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> selected (<span class="number">0.059</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<h3 id="4-5-3-管理表-内部表-与外部表的互相转换"><a href="#4-5-3-管理表-内部表-与外部表的互相转换" class="headerlink" title="4.5.3 管理表(内部表)与外部表的互相转换"></a>4.5.3 管理表(内部表)与外部表的互相转换</h3><ol>
<li>查询表的类型 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 hive]$ hive -e <span class="string">&#x27;desc formatted mock_data.student;&#x27;</span>| grep <span class="string">&#x27;Table Type&#x27;</span></span><br><span class="line"><span class="built_in">which</span>: no hbase <span class="keyword">in</span> (/usr/<span class="built_in">local</span>/bin:/usr/bin:/usr/<span class="built_in">local</span>/sbin:/usr/sbin:/opt/module/jdk1.8.0_212/bin:/opt/module/ha-hadoop-3.1.3/bin:/opt/module/ha-hadoop-3.1.3/sbin:/opt/module/hive-3.1.2/bin:/home/atguigu/.<span class="built_in">local</span>/bin:/home/atguigu/bin)</span><br><span class="line">Hive Session ID = 8eb096f9-31db-49d1-b22b-5eb6e458c0c4</span><br><span class="line"></span><br><span class="line">Logging initialized using configuration <span class="keyword">in</span> file:/opt/module/hive-3.1.2/conf/hive-log4j2.properties Async: <span class="literal">true</span></span><br><span class="line">Hive Session ID = a1d905c5-6885-493a-bd5e-db945af0b3ac</span><br><span class="line">OK</span><br><span class="line">Table Type:         	MANAGED_TABLE</span><br><span class="line">Time taken: 0.679 seconds, Fetched: 32 row(s)</span><br><span class="line">[atguigu@hadoop001 hive]$</span><br></pre></td></tr></table></figure></li>
<li>内部表外部表转换 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 外部表</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student <span class="keyword">set</span> tblproperties(<span class="string">&#x27;EXTERNAL&#x27;</span><span class="operator">=</span><span class="string">&#x27;TRUE&#x27;</span>);</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.048</span> seconds)</span><br><span class="line"># 内部表</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student <span class="keyword">set</span> tblproperties(<span class="string">&#x27;EXTERNAL&#x27;</span><span class="operator">=</span><span class="string">&#x27;FALSE&#x27;</span>);</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.053</span> seconds)</span><br></pre></td></tr></table></figure>
<ul>
<li>注意：(‘EXTERNAL’=’TRUE’)和(‘EXTERNAL’=’FALSE’)为固定写法，区分大小写！</li>
</ul>
</li>
</ol>
<h3 id="4-5-3-内部表外部表使用场景"><a href="#4-5-3-内部表外部表使用场景" class="headerlink" title="4.5.3 内部表外部表使用场景"></a>4.5.3 内部表外部表使用场景</h3><ul>
<li>内部表：不常用，通常一些中间表(运算过程产生)会使用内部表</li>
<li>外部表：常用，主要考虑HDFS源数据安全性，数据分析一般采用外部表</li>
</ul>
<h2 id="4-6-修改表"><a href="#4-6-修改表" class="headerlink" title="4.6 修改表"></a>4.6 修改表</h2><h3 id="4-6-1-重命名表"><a href="#4-6-1-重命名表" class="headerlink" title="4.6.1 重命名表"></a>4.6.1 重命名表</h3><ol>
<li>语法 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name RENAME <span class="keyword">TO</span> new_table_name</span><br></pre></td></tr></table></figure></li>
<li>实操案例 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span>      tab_name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> dept               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> emp                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> person             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> person_info        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> student            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> student_copy_as    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> student_copy_like  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> selected (<span class="number">0.035</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> student_copy_as rename <span class="keyword">to</span> student_copy_as_rename;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.069</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="operator">|</span>        tab_name         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="operator">|</span> dept                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> emp                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> person                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> person_info             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> student                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> student_copy_as_rename  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> student_copy_like       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> selected (<span class="number">0.019</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-6-2-增加、修改和删除表分区"><a href="#4-6-2-增加、修改和删除表分区" class="headerlink" title="4.6.2 增加、修改和删除表分区"></a>4.6.2 增加、修改和删除表分区</h3> 详见7.1章分区表基本操作。</li>
</ol>
<h3 id="4-6-3-增加-修改-替换列信息"><a href="#4-6-3-增加-修改-替换列信息" class="headerlink" title="4.6.3 增加/修改/替换列信息"></a>4.6.3 增加/修改/替换列信息</h3><ol>
<li>语法<ul>
<li>更新列  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name CHANGE [<span class="keyword">COLUMN</span>] col_old_name col_new_name column_type [COMMENT col_comment] [<span class="keyword">FIRST</span><span class="operator">|</span>AFTER column_name]</span><br></pre></td></tr></table></figure></li>
<li>增加和替换列  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">ADD</span><span class="operator">|</span>REPLACE COLUMNS (col_name data_type [COMMENT col_comment], ...) </span><br></pre></td></tr></table></figure>
<ul>
<li>注：ADD是代表新增一字段，字段位置在所有列后面(partition列前)，REPLACE则是表示替换表中所有字段。</li>
</ul>
</li>
</ul>
</li>
<li>实操案例<ul>
<li>查询表结构  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">desc</span> student;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------------+----------+</span></span><br><span class="line"><span class="operator">|</span> col_name  <span class="operator">|</span> data_type  <span class="operator">|</span> comment  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------------+----------+</span></span><br><span class="line"><span class="operator">|</span> id        <span class="operator">|</span> <span class="type">int</span>        <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> name      <span class="operator">|</span> string     <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------------+----------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> selected (<span class="number">0.027</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>添加列  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> dept <span class="keyword">add</span> columns(dept_desc string, dept_create_time string);</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.058</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">desc</span> dept;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+------------+----------+</span></span><br><span class="line"><span class="operator">|</span>     col_name      <span class="operator">|</span> data_type  <span class="operator">|</span> comment  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+------------+----------+</span></span><br><span class="line"><span class="operator">|</span> dept_no           <span class="operator">|</span> <span class="type">int</span>        <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> dept_name         <span class="operator">|</span> string     <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> loc               <span class="operator">|</span> <span class="type">int</span>        <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> dept_desc         <span class="operator">|</span> string     <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> dept_create_time  <span class="operator">|</span> string     <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+------------+----------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> selected (<span class="number">0.026</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>更新列  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:hive2://hadoop001:10000&gt; alter table dept change column dept_desc desc string;</span><br><span class="line">No rows affected (0.055 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt; desc dept;</span><br><span class="line">+-------------------+------------+----------+</span><br><span class="line">|     col_name      | data_type  | comment  |</span><br><span class="line">+-------------------+------------+----------+</span><br><span class="line">| dept_no           | int        |          |</span><br><span class="line">| dept_name         | string     |          |</span><br><span class="line">| loc               | int        |          |</span><br><span class="line">| desc              | string     |          |</span><br><span class="line">| dept_create_time  | string     |          |</span><br><span class="line">+-------------------+------------+----------+</span><br><span class="line">5 rows selected (0.026 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt;</span><br></pre></td></tr></table></figure></li>
<li>替换列  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> dept replace columns(deptno string, dname string, loc string);</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.083</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">desc</span> dept;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------------+----------+</span></span><br><span class="line"><span class="operator">|</span> col_name  <span class="operator">|</span> data_type  <span class="operator">|</span> comment  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------------+----------+</span></span><br><span class="line"><span class="operator">|</span> deptno    <span class="operator">|</span> string     <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> dname     <span class="operator">|</span> string     <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> loc       <span class="operator">|</span> string     <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------------+----------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> selected (<span class="number">0.027</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h1 id="五、DML数据库操作"><a href="#五、DML数据库操作" class="headerlink" title="五、DML数据库操作"></a>五、DML数据库操作</h1><h2 id="5-1-数据导入"><a href="#5-1-数据导入" class="headerlink" title="5.1 数据导入"></a>5.1 数据导入</h2><h3 id="5-1-1-向表中装载数据（Load）"><a href="#5-1-1-向表中装载数据（Load）" class="headerlink" title="5.1.1 向表中装载数据（Load）"></a>5.1.1 向表中装载数据（Load）</h3><ol>
<li>语法 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load data [<span class="built_in">local</span>] inpath <span class="string">&#x27;数据的path&#x27;</span> [overwrite] into table student [partition (partcol1=val1,…)];</span><br></pre></td></tr></table></figure>
<ul>
<li>load data:表示加载数据</li>
<li>local:表示从本地加载数据到hive表；否则从HDFS加载数据到hive表</li>
<li>inpath:表示加载数据的路径</li>
<li>overwrite:表示覆盖表中已有数据，否则表示追加</li>
<li>into table:表示加载到哪张表</li>
<li>student:表示具体的表</li>
<li>partition:表示上传到指定分区</li>
</ul>
</li>
<li>实操案例<ul>
<li>加载本地文件到hive  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> load data <span class="keyword">local</span> inpath <span class="string">&#x27;/home/atguigu/hive/student.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> mock_data.student;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.148</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>加载HDFS文件到hive中  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> dfs <span class="operator">-</span>ls <span class="operator">/</span>hive<span class="operator">/</span>source_data;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                     DFS Output                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Found <span class="number">1</span> items                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--   3 atguigu supergroup        150 2021-10-25 15:22 /hive/source_data/student.txt |</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> selected (<span class="number">0.055</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> load data inpath <span class="string">&#x27;/hive/source_data/student.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> mock_data.student;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.121</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>加载数据覆盖表中已有的数据  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:hive2://hadoop001:10000&gt; select count(*) from mock_data.student;</span><br><span class="line">+------+</span><br><span class="line">| _c0  |</span><br><span class="line">+------+</span><br><span class="line">| 48   |</span><br><span class="line">+------+</span><br><span class="line">1 row selected (16.219 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt; load data <span class="built_in">local</span> inpath <span class="string">&#x27;/home/atguigu/hive/student.txt&#x27;</span> overwrite into table mock_data.student;</span><br><span class="line">No rows affected (0.104 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt; select count(*) from mock_data.student;</span><br><span class="line">+------+</span><br><span class="line">| _c0  |</span><br><span class="line">+------+</span><br><span class="line">| 16   |</span><br><span class="line">+------+</span><br><span class="line">1 row selected (14.727 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>导入顺序<ul>
<li>追加导入数据根据文件名字典序排序</li>
</ul>
</li>
</ol>
<h3 id="5-1-2-通过查询语句向表中插入数据（Insert）"><a href="#5-1-2-通过查询语句向表中插入数据（Insert）" class="headerlink" title="5.1.2 通过查询语句向表中插入数据（Insert）"></a>5.1.2 通过查询语句向表中插入数据（Insert）</h3><ol>
<li>根据单张表查询结果插入 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> student_from_select <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student;</span><br></pre></td></tr></table></figure>
<ul>
<li>insert into：以追加数据的方式插入到表或分区，原有数据不会删除</li>
<li>insert overwrite：会覆盖表中已存在的数据</li>
<li>注意：insert不支持插入部分字段</li>
</ul>
</li>
<li>多表（多分区）插入模式（根据多张表查询结果） <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> student</span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> student_from_select</span><br><span class="line"><span class="keyword">select</span> id, name <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1001</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> student_copy_like</span><br><span class="line"><span class="keyword">select</span> id, name <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1009</span></span><br></pre></td></tr></table></figure>
<h3 id="5-1-3-查询语句中创建表并加载数据（As-Select）"><a href="#5-1-3-查询语句中创建表并加载数据（As-Select）" class="headerlink" title="5.1.3 查询语句中创建表并加载数据（As Select）"></a>5.1.3 查询语句中创建表并加载数据（As Select）</h3></li>
<li>根据查询结果创建表（查询的结果会添加到新创建的表中） <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> student3 <span class="keyword">as</span> <span class="keyword">select</span> id, name <span class="keyword">from</span> student; </span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="5-1-4-创建表时通过Location指定加载数据路径"><a href="#5-1-4-创建表时通过Location指定加载数据路径" class="headerlink" title="5.1.4 创建表时通过Location指定加载数据路径"></a>5.1.4 创建表时通过Location指定加载数据路径</h3><ol>
<li>上传数据到hdfs上 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> dfs <span class="operator">-</span>put <span class="operator">/</span>home<span class="operator">/</span>atguigu<span class="operator">/</span>hive<span class="operator">/</span>load_student.txt <span class="operator">/</span>hive<span class="operator">/</span>db<span class="operator">/</span>mock_data<span class="operator">/</span>load_student<span class="operator">/</span>load_student.txt;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span> DFS Output  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> selected (<span class="number">0.019</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>创建表，并指定在hdfs上的位置 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> load_student (</span><br><span class="line">    id   <span class="type">int</span>,</span><br><span class="line">    name string</span><br><span class="line">)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span></span><br><span class="line">stored <span class="keyword">as</span> textfile</span><br><span class="line">location <span class="string">&#x27;/hive/db/mock_data/load_student&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li>查询数据 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mock_data.load_student limit <span class="number">10</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> load_student.id  <span class="operator">|</span> load_student.name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">22852294</span>         <span class="operator">|</span> 司寇俊                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">22852295</span>         <span class="operator">|</span> 安投悬                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">22852296</span>         <span class="operator">|</span> 申燎赢                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">22852297</span>         <span class="operator">|</span> 洪谎                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">22852298</span>         <span class="operator">|</span> 丰觅                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">22852299</span>         <span class="operator">|</span> 拓跋卷                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">22852300</span>         <span class="operator">|</span> 汪舶                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">22852301</span>         <span class="operator">|</span> 涂钦羡                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">22852302</span>         <span class="operator">|</span> 濮崭                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">22852303</span>         <span class="operator">|</span> 阚撑                 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+--------------------+</span></span><br><span class="line"><span class="number">10</span> <span class="keyword">rows</span> selected (<span class="number">0.057</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="5-1-5-Import数据到指定Hive表中"><a href="#5-1-5-Import数据到指定Hive表中" class="headerlink" title="5.1.5 Import数据到指定Hive表中"></a>5.1.5 Import数据到指定Hive表中</h3><ul>
<li>注意：先用export导出后，再将数据导入。多用于小规模迁移，会自动创建表。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> export <span class="keyword">table</span> mock_data.person <span class="keyword">to</span> <span class="string">&#x27;/hive/source_data/person/export&#x27;</span>;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">17.558</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> import <span class="keyword">table</span> mock_data.import_person <span class="keyword">from</span> <span class="string">&#x27;/hive/source_data/person/export&#x27;</span>;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">4.487</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> mock_data.import_person;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span>    _c0    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">24307000</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">19.358</span> seconds)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="5-2-数据导出"><a href="#5-2-数据导出" class="headerlink" title="5.2 数据导出"></a>5.2 数据导出</h2><h3 id="5-2-1-Insert导出"><a href="#5-2-1-Insert导出" class="headerlink" title="5.2.1 Insert导出"></a>5.2.1 Insert导出</h3><ol>
<li>将查询的结果导出到本地 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">local</span> directory <span class="string">&#x27;/home/atguigu/hive/export/person&#x27;</span> <span class="keyword">select</span> id,name <span class="keyword">from</span> mock_data.person;</span><br></pre></td></tr></table></figure></li>
<li>将查询的结果格式化导出到本地 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">local</span> directory <span class="string">&#x27;/home/atguigu/hive/export/person&#x27;</span> <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\t&#x27;</span> <span class="keyword">select</span> id,name <span class="keyword">from</span> mock_data.person;</span><br></pre></td></tr></table></figure></li>
<li>将查询的结果导出到HDFS上(没有local) <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">insert</span> overwrite directory <span class="string">&#x27;/hive/source_data/person&#x27;</span> <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\t&#x27;</span> <span class="keyword">select</span> id,name <span class="keyword">from</span> mock_data.person;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">21.398</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> dfs <span class="operator">-</span>ls <span class="operator">/</span>hive<span class="operator">/</span>source_data<span class="operator">/</span>person;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                     DFS Output                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Found <span class="number">5</span> items                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--   3 atguigu supergroup  115767751 2021-10-25 19:13 /hive/source_data/person/000000_0 |</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--   3 atguigu supergroup  115656456 2021-10-25 19:13 /hive/source_data/person/000001_0 |</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--   3 atguigu supergroup  111382098 2021-10-25 19:13 /hive/source_data/person/000002_0 |</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--   3 atguigu supergroup   55441386 2021-10-25 19:13 /hive/source_data/person/000003_0 |</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--   3 atguigu supergroup   27719097 2021-10-25 19:13 /hive/source_data/person/000004_0 |</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> selected (<span class="number">0.012</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="5-2-2-Export导出到HDFS上"><a href="#5-2-2-Export导出到HDFS上" class="headerlink" title="5.2.2 Export导出到HDFS上"></a>5.2.2 Export导出到HDFS上</h3><p>export和import主要用于两个Hadoop平台集群之间Hive表迁移。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export <span class="keyword">table</span> mock_data.person <span class="keyword">to</span> <span class="string">&#x27;/hive/source_data/person/export&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-3-Hive-Shell-命令导出"><a href="#5-2-3-Hive-Shell-命令导出" class="headerlink" title="5.2.3 Hive Shell 命令导出"></a>5.2.3 Hive Shell 命令导出</h3><ul>
<li>基本语法：（hive -f/-e 执行语句或者脚本 &gt; file）  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop102 hive]$ bin/hive -e <span class="string">&#x27;select * from default.student;&#x27;</span> &gt;</span><br><span class="line"> /opt/module/hive/datas/<span class="built_in">export</span>/student4.txt;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="5-2-4-Export导出到HDFS上"><a href="#5-2-4-Export导出到HDFS上" class="headerlink" title="5.2.4 Export导出到HDFS上"></a>5.2.4 Export导出到HDFS上</h3><ul>
<li>export和import主要用于两个Hadoop平台集群之间Hive表迁移。  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(defahiveult)<span class="operator">&gt;</span> export <span class="keyword">table</span> default.student <span class="keyword">to</span></span><br><span class="line"> <span class="string">&#x27;/user/hive/warehouse/export/student&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="5-2-5-清除表中数据（Truncate）"><a href="#5-2-5-清除表中数据（Truncate）" class="headerlink" title="5.2.5 清除表中数据（Truncate）"></a>5.2.5 清除表中数据（Truncate）</h3><ul>
<li>注意：Truncate只能删除管理表，不能删除外部表中数据<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">truncate</span> <span class="keyword">table</span> student;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="六、查询"><a href="#六、查询" class="headerlink" title="六、查询"></a>六、查询</h1><h3 id="6-1-1-全表和特定列查询"><a href="#6-1-1-全表和特定列查询" class="headerlink" title="6.1.1 全表和特定列查询"></a>6.1.1 全表和特定列查询</h3><ol>
<li>数据准备 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">dept:</span><br><span class="line">10	ACCOUNTING	1700</span><br><span class="line">20	RESEARCH	1800</span><br><span class="line">30	SALES	1900</span><br><span class="line">40	OPERATIONS	1700</span><br><span class="line">emp：</span><br><span class="line">7369	SMITH	CLERK	7902	1980-12-17	800.00		20</span><br><span class="line">7499	ALLEN	SALESMAN	7698	1981-2-20	1600.00	300.00	30</span><br><span class="line">7521	WARD	SALESMAN	7698	1981-2-22	1250.00	500.00	30</span><br><span class="line">7566	JONES	MANAGER	7839	1981-4-2	2975.00		20</span><br><span class="line">7654	MARTIN	SALESMAN	7698	1981-9-28	1250.00	1400.00	30</span><br><span class="line">7698	BLAKE	MANAGER	7839	1981-5-1	2850.00		30</span><br><span class="line">7782	CLARK	MANAGER	7839	1981-6-9	2450.00		10</span><br><span class="line">7788	SCOTT	ANALYST	7566	1987-4-19	3000.00		20</span><br><span class="line">7839	KING	PRESIDENT		1981-11-17	5000.00		10</span><br><span class="line">7844	TURNER	SALESMAN	7698	1981-9-8	1500.00	0.00	30</span><br><span class="line">7876	ADAMS	CLERK	7788	1987-5-23	1100.00		20</span><br><span class="line">7900	JAMES	CLERK	7698	1981-12-3	950.00		30</span><br><span class="line">7902	FORD	ANALYST	7566	1981-12-3	3000.00		20</span><br><span class="line">7934	MILLER	CLERK	7782	1982-1-23	1300.00		10</span><br></pre></td></tr></table></figure></li>
<li>创建表结构 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 部门表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> dept(</span><br><span class="line">    deptno <span class="type">int</span>,</span><br><span class="line">    dname string,</span><br><span class="line">    loc <span class="type">int</span></span><br><span class="line">)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"><span class="comment">-- 员工表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> emp(</span><br><span class="line">    empno <span class="type">int</span>,</span><br><span class="line">    ename string,</span><br><span class="line">    job string,</span><br><span class="line">    mgr <span class="type">int</span>,</span><br><span class="line">    hiredate string, </span><br><span class="line">    sal <span class="keyword">double</span>, </span><br><span class="line">    comm <span class="keyword">double</span>,</span><br><span class="line">    deptno <span class="type">int</span></span><br><span class="line">)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li>导入数据 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/opt/module/datas/dept.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span></span><br><span class="line">dept;	</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/opt/module/datas/emp.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> emp;</span><br></pre></td></tr></table></figure></li>
<li>全表查询 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;</span><br><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> empno,ename,job,mgr,hiredate,sal,comm,deptno <span class="keyword">from</span> emp ;</span><br></pre></td></tr></table></figure></li>
<li>选择特定列查询 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> empno, ename <span class="keyword">from</span> emp;</span><br></pre></td></tr></table></figure></li>
<li>注意：<ul>
<li>（1）SQL 语言大小写不敏感。 </li>
<li>（2）SQL 可以写在一行或者多行</li>
<li>（3）关键字不能被缩写也不能分行</li>
<li>（4）各子句一般要分行写。</li>
<li>（5）使用缩进提高语句的可读性。</li>
</ul>
</li>
</ol>
<h3 id="6-1-2-列别名"><a href="#6-1-2-列别名" class="headerlink" title="6.1.2 列别名"></a>6.1.2 列别名</h3><ol>
<li>用途<ol>
<li>重命名一个列</li>
<li>便于计算</li>
<li>紧跟列名，也可以在列名和别名之间加入关键字‘AS’ </li>
<li>案例实操 </li>
</ol>
</li>
<li>查询名称和部门 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> ename <span class="keyword">AS</span> name, deptno dn <span class="keyword">from</span> emp;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="6-1-3-算术运算符"><a href="#6-1-3-算术运算符" class="headerlink" title="6.1.3 算术运算符"></a>6.1.3 算术运算符</h3><table>
<thead>
<tr>
<th>运算符</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>A+B</td>
<td>A和B 相加</td>
</tr>
<tr>
<td>A-B</td>
<td>A减去B</td>
</tr>
<tr>
<td>A*B</td>
<td>A和B 相乘</td>
</tr>
<tr>
<td>A/B</td>
<td>A除以B</td>
</tr>
<tr>
<td>A%B</td>
<td>A对B取余</td>
</tr>
<tr>
<td>A&amp;B</td>
<td>A和B按位取与</td>
</tr>
<tr>
<td>A</td>
<td>B</td>
</tr>
<tr>
<td>A^B</td>
<td>A和B按位取异或</td>
</tr>
<tr>
<td>~A</td>
<td>A按位取反</td>
</tr>
</tbody></table>
<ul>
<li>案例实操：查询出所有员工的薪水后加1显示。<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> sal <span class="operator">+</span><span class="number">1</span> <span class="keyword">from</span> emp;</span><br></pre></td></tr></table></figure>
<h3 id="6-1-4-常用函数"><a href="#6-1-4-常用函数" class="headerlink" title="6.1.4 常用函数"></a>6.1.4 常用函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 求总行数（count）</span></span><br><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) cnt <span class="keyword">from</span> emp;</span><br><span class="line"><span class="comment">-- 求工资的最大值（max）</span></span><br><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">max</span>(sal) max_sal <span class="keyword">from</span> emp;</span><br><span class="line"><span class="comment">-- 求工资的最小值（min）</span></span><br><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">min</span>(sal) min_sal <span class="keyword">from</span> emp;</span><br><span class="line"><span class="comment">-- 求工资的总和（sum）</span></span><br><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">sum</span>(sal) sum_sal <span class="keyword">from</span> emp; </span><br><span class="line"><span class="comment">-- 求工资的平均值（avg）</span></span><br><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">avg</span>(sal) avg_sal <span class="keyword">from</span> emp;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="6-1-5-Limit语句"><a href="#6-1-5-Limit语句" class="headerlink" title="6.1.5 Limit语句"></a>6.1.5 Limit语句</h3><ul>
<li>LIMIT子句用于限制返回的行数。  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp limit <span class="number">5</span>;</span><br><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp limit <span class="number">2</span>,<span class="number">3</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="6-1-6-Where语句"><a href="#6-1-6-Where语句" class="headerlink" title="6.1.6 Where语句"></a>6.1.6 Where语句</h3><ol>
<li>使用WHERE子句，将不满足条件的行过滤掉</li>
<li>WHERE子句紧随FROM子句</li>
<li>案例实操<ul>
<li>查询出薪水大于1000的所有员工  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> sal <span class="operator">&gt;</span><span class="number">1000</span>;</span><br></pre></td></tr></table></figure></li>
<li>注意：where子句中不能使用字段别名。</li>
</ul>
</li>
</ol>
<h3 id="6-1-7-比较运算符（Between-In-Is-Null）"><a href="#6-1-7-比较运算符（Between-In-Is-Null）" class="headerlink" title="6.1.7 比较运算符（Between/In/ Is Null）"></a>6.1.7 比较运算符（Between/In/ Is Null）</h3><ol>
<li><p>下面表中描述了谓词操作符，这些操作符同样可以用于JOIN…ON和HAVING语句中。</p>
<table>
<thead>
<tr>
<th>操作符</th>
<th>支持的数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>A=B</td>
<td>基本数据类型</td>
<td>如果A等于B则返回TRUE，反之返回FALSE</td>
</tr>
<tr>
<td>A&lt;=&gt;B</td>
<td>基本数据类型</td>
<td>如果A和B都为NULL，则返回TRUE，如果一边为NULL，返回False</td>
</tr>
<tr>
<td>A&lt;&gt;B, A!=B</td>
<td>基本数据类型</td>
<td>A或者B为NULL则返回NULL；如果A不等于B，则返回TRUE，反之返回FALSE</td>
</tr>
<tr>
<td>A&lt;B</td>
<td>基本数据类型</td>
<td>A或者B为NULL，则返回NULL；如果A小于B，则返回TRUE，反之返回FALSE</td>
</tr>
<tr>
<td>A&lt;=B</td>
<td>基本数据类型</td>
<td>A或者B为NULL，则返回NULL；如果A小于等于B，则返回TRUE，反之返回FALSE</td>
</tr>
<tr>
<td>A&gt;B</td>
<td>基本数据类型</td>
<td>A或者B为NULL，则返回NULL；如果A大于B，则返回TRUE，反之返回FALSE</td>
</tr>
<tr>
<td>A&gt;=B</td>
<td>基本数据类型</td>
<td>A或者B为NULL，则返回NULL；如果A大于等于B，则返回TRUE，反之返回FALSE</td>
</tr>
<tr>
<td>A [NOT] BETWEEN B AND C</td>
<td>基本数据类型</td>
<td>如果A，B或者C任一为NULL，则结果为NULL。如果A的值大于等于B而且小于或等于C，则结果为TRUE，反之为FALSE。如果使用NOT关键字则可达到相反的效果。</td>
</tr>
<tr>
<td>A IS NULL</td>
<td>所有数据类型</td>
<td>如果A等于NULL，则返回TRUE，反之返回FALSE</td>
</tr>
<tr>
<td>A IS NOT NULL</td>
<td>所有数据类型</td>
<td>如果A不等于NULL，则返回TRUE，反之返回FALSE</td>
</tr>
<tr>
<td>IN(数值1, 数值2)</td>
<td>所有数据类型</td>
<td>使用 IN运算显示列表中的值</td>
</tr>
<tr>
<td>A [NOT] LIKE B</td>
<td>STRING 类型</td>
<td>B是一个SQL下的简单正则表达式，也叫通配符模式，如果A与其匹配的话，则返回TRUE；反之返回FALSE。B的表达式说明如下：‘x%’表示A必须以字母‘x’开头，‘%x’表示A必须以字母’x’结尾，而‘%x%’表示A包含有字母’x’,可以位于开头，结尾或者字符串中间。如果使用NOT关键字则可达到相反的效果。</td>
</tr>
<tr>
<td>A RLIKE B, A REGEXP B</td>
<td>STRING 类型</td>
<td>B是基于java的正则表达式，如果A与其匹配，则返回TRUE；反之返回FALSE。匹配使用的是JDK中的正则表达式接口实现的，因为正则也依据其中的规则。例如，正则表达式必须和整个字符串A相匹配，而不是只需与其字符串匹配。</td>
</tr>
</tbody></table>
</li>
<li><p>案例实操</p>
<ul>
<li>查询出薪水等于5000的所有员工  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (default)&gt; select * from emp <span class="built_in">where</span> sal =5000;</span><br></pre></td></tr></table></figure></li>
<li>查询工资在500到1000的员工信息  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> sal <span class="keyword">between</span> <span class="number">500</span> <span class="keyword">and</span> <span class="number">1000</span>;</span><br></pre></td></tr></table></figure></li>
<li>查询comm为空的所有员工信息  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> comm <span class="keyword">is</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure></li>
<li>查询工资是1500或5000的员工信息  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> sal <span class="keyword">IN</span> (<span class="number">1500</span>, <span class="number">5000</span>);</span><br></pre></td></tr></table></figure>
<h3 id="6-1-8-Like和RLike"><a href="#6-1-8-Like和RLike" class="headerlink" title="6.1.8 Like和RLike"></a>6.1.8 Like和RLike</h3></li>
</ul>
</li>
<li><p>使用LIKE运算选择类似的值</p>
</li>
<li><p>选择条件可以包含字符或数字:</p>
<ul>
<li>% 代表零个或多个字符(任意个字符)。</li>
<li>_ 代表一个字符。</li>
</ul>
</li>
<li><p>RLIKE子句</p>
<ul>
<li>RLIKE子句是Hive中这个功能的一个扩展，其可以通过Java的正则表达式这个更强大的语言来指定匹配条件。</li>
</ul>
</li>
<li><p>案例实操</p>
<ol>
<li>查找名字以A开头的员工信息 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> ename <span class="keyword">LIKE</span> <span class="string">&#x27;A%&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li>查找名字中第二个字母为A的员工信息 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> ename <span class="keyword">LIKE</span> <span class="string">&#x27;_A%&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li>查找名字中带有A-N的员工信息 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> ename  RLIKE <span class="string">&#x27;[A-N]&#x27;</span>;</span><br></pre></td></tr></table></figure>
<h3 id="6-1-9-逻辑运算符（And-Or-Not）"><a href="#6-1-9-逻辑运算符（And-Or-Not）" class="headerlink" title="6.1.9 逻辑运算符（And/Or/Not）"></a>6.1.9 逻辑运算符（And/Or/Not）</h3><table>
<thead>
<tr>
<th>操作符</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>AND</td>
<td>逻辑并</td>
</tr>
<tr>
<td>OR</td>
<td>逻辑或</td>
</tr>
<tr>
<td>NOT</td>
<td>逻辑否</td>
</tr>
</tbody></table>
</li>
</ol>
</li>
<li><p>案例实操</p>
<ol>
<li>查询薪水大于1000，部门是30 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> sal<span class="operator">&gt;</span><span class="number">1000</span> <span class="keyword">and</span> deptno<span class="operator">=</span><span class="number">30</span>;</span><br></pre></td></tr></table></figure></li>
<li>查询薪水大于1000，或者部门是30 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> sal<span class="operator">&gt;</span><span class="number">1000</span> <span class="keyword">or</span> deptno<span class="operator">=</span><span class="number">30</span>;</span><br></pre></td></tr></table></figure></li>
<li>查询除了20部门和30部门以外的员工信息 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> deptno <span class="keyword">not</span> <span class="keyword">IN</span>(<span class="number">30</span>, <span class="number">20</span>);</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<h2 id="6-2-分组"><a href="#6-2-分组" class="headerlink" title="6.2 分组"></a>6.2 分组</h2><h3 id="6-2-1-Group-By语句"><a href="#6-2-1-Group-By语句" class="headerlink" title="6.2.1 Group By语句"></a>6.2.1 Group By语句</h3><p>GROUP BY语句通常会和聚合函数一起使用，按照一个或者多个列队结果进行分组，然后对每个组执行聚合操作。</p>
<ol>
<li>案例实操：<ol>
<li>计算emp表每个部门的平均工资 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> t.deptno, <span class="built_in">avg</span>(t.sal) avg_sal <span class="keyword">from</span> emp t <span class="keyword">group</span> <span class="keyword">by</span> t.deptno;</span><br></pre></td></tr></table></figure></li>
<li>计算emp每个部门中每个岗位的最高薪水 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> t.deptno, t.job, <span class="built_in">max</span>(t.sal) max_sal <span class="keyword">from</span> emp t <span class="keyword">group</span> <span class="keyword">by</span> t.deptno, t.job;</span><br></pre></td></tr></table></figure>
<h3 id="6-2-2-Having语句"><a href="#6-2-2-Having语句" class="headerlink" title="6.2.2 Having语句"></a>6.2.2 Having语句</h3></li>
</ol>
</li>
<li>having与where不同点<ol>
<li>where后面不能写分组函数，而having后面可以使用分组函数。</li>
<li>having只用于group by分组统计语句。</li>
</ol>
</li>
<li>案例实操<ol>
<li>求每个部门的平均薪水大于2000的部门<ol>
<li>求每个部门的平均工资 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> deptno, <span class="built_in">avg</span>(sal) <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> deptno;</span><br></pre></td></tr></table></figure></li>
<li>求每个部门的平均薪水大于2000的部门  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> deptno, <span class="built_in">avg</span>(sal) avg_sal <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> deptno <span class="keyword">having</span> avg_sal <span class="operator">&gt;</span> <span class="number">2000</span>;</span><br></pre></td></tr></table></figure>
<h2 id="6-3-Join语句"><a href="#6-3-Join语句" class="headerlink" title="6.3 Join语句"></a>6.3 Join语句</h2><h3 id="6-3-1-等值Join"><a href="#6-3-1-等值Join" class="headerlink" title="6.3.1 等值Join"></a>6.3.1 等值Join</h3>Hive支持通常的SQL JOIN语句。 </li>
</ol>
</li>
</ol>
</li>
<li>案例实操<ol>
<li>根据员工表和部门表中的部门编号相等，查询员工编号、员工名称和部门名称； <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> e.empno, e.ename, d.deptno, d.dname <span class="keyword">from</span> emp e <span class="keyword">join</span> dept d <span class="keyword">on</span> e.deptno <span class="operator">=</span> d.deptno;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<h3 id="6-3-2-表的别名"><a href="#6-3-2-表的别名" class="headerlink" title="6.3.2 表的别名"></a>6.3.2 表的别名</h3><ol>
<li>好处<ol>
<li>使用别名可以简化查询。</li>
<li>使用表名前缀可以提高执行效率。</li>
</ol>
</li>
<li>案例实操<ol>
<li>合并员工表和部门表 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> e.empno, e.ename, d.deptno <span class="keyword">from</span> emp e <span class="keyword">join</span> dept d <span class="keyword">on</span> e.deptno <span class="operator">=</span> d.deptno;</span><br></pre></td></tr></table></figure>
<h3 id="6-3-3-内连接"><a href="#6-3-3-内连接" class="headerlink" title="6.3.3 内连接"></a>6.3.3 内连接</h3></li>
</ol>
</li>
</ol>
<ul>
<li>只有进行连接的两个表中都存在与连接条件相匹配的数据才会被保留下来。  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> e.empno, e.ename, d.deptno <span class="keyword">from</span> emp e <span class="keyword">join</span> dept d <span class="keyword">on</span> e.deptno <span class="operator">=</span> d.deptno;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="6-3-4-左外连接"><a href="#6-3-4-左外连接" class="headerlink" title="6.3.4 左外连接"></a>6.3.4 左外连接</h3><ul>
<li>JOIN操作符左边表中符合WHERE子句的所有记录将会被返回。  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> e.empno, e.ename, d.deptno <span class="keyword">from</span> emp e <span class="keyword">left</span> <span class="keyword">join</span> dept d <span class="keyword">on</span> e.deptno <span class="operator">=</span> d.deptno;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="6-3-5-右外连接"><a href="#6-3-5-右外连接" class="headerlink" title="6.3.5 右外连接"></a>6.3.5 右外连接</h3><ul>
<li>JOIN操作符右边表中符合WHERE子句的所有记录将会被返回。  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> e.empno, e.ename, d.deptno <span class="keyword">from</span> emp e <span class="keyword">right</span> <span class="keyword">join</span> dept d <span class="keyword">on</span> e.deptno <span class="operator">=</span> d.deptno;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="6-3-6-满外连接"><a href="#6-3-6-满外连接" class="headerlink" title="6.3.6 满外连接"></a>6.3.6 满外连接</h3><ul>
<li>将会返回所有表中符合WHERE语句条件的所有记录。如果任一表的指定字段没有符合条件的值的话，那么就使用NULL值替代。  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> e.empno, e.ename, d.deptno <span class="keyword">from</span> emp e <span class="keyword">full</span> <span class="keyword">join</span> dept d <span class="keyword">on</span> e.deptno <span class="operator">=</span> d.deptno;</span><br></pre></td></tr></table></figure>
<h3 id="6-3-7-多表连接"><a href="#6-3-7-多表连接" class="headerlink" title="6.3.7 多表连接"></a>6.3.7 多表连接</h3></li>
<li>注意：连接 n个表，至少需要n-1个连接条件。例如：连接三个表，至少需要两个连接条件。</li>
<li>数据准备  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location</span><br><span class="line">1700	Beijing</span><br><span class="line">1800	London</span><br><span class="line">1900	Tokyo</span><br></pre></td></tr></table></figure></li>
</ul>
<ol>
<li>创建位置表 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> location(</span><br><span class="line">    loc <span class="type">int</span>,</span><br><span class="line">    loc_name string</span><br><span class="line">)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li>导入数据 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> load data <span class="keyword">local</span> inpath <span class="string">&#x27;/opt/module/datas/location.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> location;</span><br></pre></td></tr></table></figure></li>
<li>多表连接查询 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span><span class="keyword">SELECT</span></span><br><span class="line">       e.emp_name,</span><br><span class="line">       d.dept_name,</span><br><span class="line">       l.loc_name</span><br><span class="line"><span class="keyword">FROM</span> emp e</span><br><span class="line"><span class="keyword">JOIN</span> dept d <span class="keyword">ON</span> d.dept_no <span class="operator">=</span> e.dept_no</span><br><span class="line"><span class="keyword">JOIN</span> location l <span class="keyword">ON</span> d.loc <span class="operator">=</span> l.loc;</span><br></pre></td></tr></table></figure>
<ul>
<li>大多数情况下，Hive会对每对JOIN连接对象启动一个MapReduce任务。本例中会首先启动一个MapReduce job对表e和表d进行连接操作，然后会再启动一个MapReduce job将第一个MapReduce job的输出和表l;进行连接操作。</li>
<li>注意：为什么不是表d和表l先进行连接操作呢？这是因为Hive总是按照从左到右的顺序执行的。</li>
<li>优化：当对3个或者更多表进行join连接时，如果每个on子句都使用相同的连接键的话，那么只会产生一个MapReduce job。</li>
</ul>
</li>
</ol>
<h3 id="6-3-8-笛卡尔积"><a href="#6-3-8-笛卡尔积" class="headerlink" title="6.3.8 笛卡尔积"></a>6.3.8 笛卡尔积</h3><ol>
<li>笛卡尔积会在下面条件下产生<ol>
<li>省略连接条件</li>
<li>连接条件无效</li>
<li>所有表中的所有行互相连接</li>
</ol>
</li>
<li>案例实操 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> emp_name, dept_name <span class="keyword">from</span> emp, dept;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="6-4-排序"><a href="#6-4-排序" class="headerlink" title="6.4 排序"></a>6.4 排序</h2><h3 id="6-4-1-全局排序（Order-By）"><a href="#6-4-1-全局排序（Order-By）" class="headerlink" title="6.4.1 全局排序（Order By）"></a>6.4.1 全局排序（Order By）</h3><p>Order By：全局排序，只有一个Reducer</p>
<ol>
<li>使用 ORDER BY 子句排序<ul>
<li>ASC（ascend）: 升序（默认）</li>
<li>DESC（descend）: 降序</li>
</ul>
</li>
<li>ORDER BY 子句在SELECT语句的结尾</li>
<li>案例实操 <ol>
<li>查询员工信息按工资升序排列 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">order</span> <span class="keyword">by</span> sal;</span><br></pre></td></tr></table></figure></li>
<li>查询员工信息按工资降序排列 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">order</span> <span class="keyword">by</span> sal <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<h3 id="6-4-2-按照别名排序"><a href="#6-4-2-按照别名排序" class="headerlink" title="6.4.2 按照别名排序"></a>6.4.2 按照别名排序</h3></li>
</ol>
</li>
</ol>
<ul>
<li>按照员工薪水的2倍排序  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> ename, sal<span class="operator">*</span><span class="number">2</span> twosal <span class="keyword">from</span> emp <span class="keyword">order</span> <span class="keyword">by</span> twosal;</span><br></pre></td></tr></table></figure>
<h3 id="6-4-3-多个列排序"><a href="#6-4-3-多个列排序" class="headerlink" title="6.4.3 多个列排序"></a>6.4.3 多个列排序</h3></li>
<li>按照部门和工资升序排序  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> ename, deptno, sal <span class="keyword">from</span> emp <span class="keyword">order</span> <span class="keyword">by</span> deptno, sal ;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="6-4-4-Sort-By-每个Reduce内部排序"><a href="#6-4-4-Sort-By-每个Reduce内部排序" class="headerlink" title="6.4.4 Sort By 每个Reduce内部排序"></a>6.4.4 Sort By 每个Reduce内部排序</h3><ul>
<li>Sort By：对于大规模的数据集order by的效率非常低。在很多情况下，并不需要全局排序，此时可以使用sort by。</li>
<li>Sort by为每个reducer产生一个排序文件。每个Reducer内部进行排序，对全局结果集来说不是排序。</li>
</ul>
<ol>
<li>设置reduce个数 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">set</span> mapreduce.job.reduces<span class="operator">=</span><span class="number">2</span>;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.005</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">set</span> mapreduce.job.reduces;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+</span></span><br><span class="line"><span class="operator">|</span>           <span class="keyword">set</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+</span></span><br><span class="line"><span class="operator">|</span> mapreduce.job.reduces<span class="operator">=</span><span class="number">2</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.204</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>根据部门编号降序查看员工信息 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mock_data.emp sort <span class="keyword">by</span> dept_no <span class="keyword">desc</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+---------------+------------+----------+----------------+----------+-----------+--------------+</span></span><br><span class="line"><span class="operator">|</span> emp.emp_no  <span class="operator">|</span> emp.emp_name  <span class="operator">|</span>  emp.job   <span class="operator">|</span> emp.mgr  <span class="operator">|</span> emp.hire_date  <span class="operator">|</span> emp.sal  <span class="operator">|</span> emp.comm  <span class="operator">|</span> emp.dept_no  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+---------------+------------+----------+----------------+----------+-----------+--------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7521</span>        <span class="operator">|</span> WARD          <span class="operator">|</span> SALESMAN   <span class="operator">|</span> <span class="number">7698</span>     <span class="operator">|</span> <span class="number">1981</span><span class="number">-2</span><span class="number">-22</span>      <span class="operator">|</span> <span class="number">1250.0</span>   <span class="operator">|</span> <span class="number">500.0</span>     <span class="operator">|</span> <span class="number">30</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7900</span>        <span class="operator">|</span> JAMES         <span class="operator">|</span> CLERK      <span class="operator">|</span> <span class="number">7698</span>     <span class="operator">|</span> <span class="number">1981</span><span class="number">-12</span><span class="number">-3</span>      <span class="operator">|</span> <span class="number">950.0</span>    <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> <span class="number">30</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7844</span>        <span class="operator">|</span> TURNER        <span class="operator">|</span> SALESMAN   <span class="operator">|</span> <span class="number">7698</span>     <span class="operator">|</span> <span class="number">1981</span><span class="number">-9</span><span class="number">-8</span>       <span class="operator">|</span> <span class="number">1500.0</span>   <span class="operator">|</span> <span class="number">0.0</span>       <span class="operator">|</span> <span class="number">30</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7654</span>        <span class="operator">|</span> MARTIN        <span class="operator">|</span> SALESMAN   <span class="operator">|</span> <span class="number">7698</span>     <span class="operator">|</span> <span class="number">1981</span><span class="number">-9</span><span class="number">-28</span>      <span class="operator">|</span> <span class="number">1250.0</span>   <span class="operator">|</span> <span class="number">1400.0</span>    <span class="operator">|</span> <span class="number">30</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7876</span>        <span class="operator">|</span> ADAMS         <span class="operator">|</span> CLERK      <span class="operator">|</span> <span class="number">7788</span>     <span class="operator">|</span> <span class="number">1987</span><span class="number">-5</span><span class="number">-23</span>      <span class="operator">|</span> <span class="number">1100.0</span>   <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> <span class="number">20</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7902</span>        <span class="operator">|</span> FORD          <span class="operator">|</span> ANALYST    <span class="operator">|</span> <span class="number">7566</span>     <span class="operator">|</span> <span class="number">1981</span><span class="number">-12</span><span class="number">-3</span>      <span class="operator">|</span> <span class="number">3000.0</span>   <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> <span class="number">20</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7788</span>        <span class="operator">|</span> SCOTT         <span class="operator">|</span> ANALYST    <span class="operator">|</span> <span class="number">7566</span>     <span class="operator">|</span> <span class="number">1987</span><span class="number">-4</span><span class="number">-19</span>      <span class="operator">|</span> <span class="number">3000.0</span>   <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> <span class="number">20</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7369</span>        <span class="operator">|</span> SMITH         <span class="operator">|</span> CLERK      <span class="operator">|</span> <span class="number">7902</span>     <span class="operator">|</span> <span class="number">1980</span><span class="number">-12</span><span class="number">-17</span>     <span class="operator">|</span> <span class="number">800.0</span>    <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> <span class="number">20</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7566</span>        <span class="operator">|</span> JONES         <span class="operator">|</span> MANAGER    <span class="operator">|</span> <span class="number">7839</span>     <span class="operator">|</span> <span class="number">1981</span><span class="number">-4</span><span class="number">-2</span>       <span class="operator">|</span> <span class="number">2975.0</span>   <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> <span class="number">20</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7499</span>        <span class="operator">|</span> ALLEN         <span class="operator">|</span> SALESMAN   <span class="operator">|</span> <span class="number">7698</span>     <span class="operator">|</span> <span class="number">1981</span><span class="number">-2</span><span class="number">-20</span>      <span class="operator">|</span> <span class="number">1600.0</span>   <span class="operator">|</span> <span class="number">300.0</span>     <span class="operator">|</span> <span class="number">30</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7698</span>        <span class="operator">|</span> BLAKE         <span class="operator">|</span> MANAGER    <span class="operator">|</span> <span class="number">7839</span>     <span class="operator">|</span> <span class="number">1981</span><span class="number">-5</span><span class="number">-1</span>       <span class="operator">|</span> <span class="number">2850.0</span>   <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> <span class="number">30</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7934</span>        <span class="operator">|</span> MILLER        <span class="operator">|</span> CLERK      <span class="operator">|</span> <span class="number">7782</span>     <span class="operator">|</span> <span class="number">1982</span><span class="number">-1</span><span class="number">-23</span>      <span class="operator">|</span> <span class="number">1300.0</span>   <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> <span class="number">10</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7839</span>        <span class="operator">|</span> KING          <span class="operator">|</span> PRESIDENT  <span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">1981</span><span class="number">-11</span><span class="number">-17</span>     <span class="operator">|</span> <span class="number">5000.0</span>   <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> <span class="number">10</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7782</span>        <span class="operator">|</span> CLARK         <span class="operator">|</span> MANAGER    <span class="operator">|</span> <span class="number">7839</span>     <span class="operator">|</span> <span class="number">1981</span><span class="number">-6</span><span class="number">-9</span>       <span class="operator">|</span> <span class="number">2450.0</span>   <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> <span class="number">10</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+---------------+------------+----------+----------------+----------+-----------+--------------+</span></span><br><span class="line"><span class="number">14</span> <span class="keyword">rows</span> selected (<span class="number">16.877</span> seconds)</span><br></pre></td></tr></table></figure></li>
<li>将查询结果导入到文件中（按照部门编号降序排序） <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">set</span> mapreduce.job.reduces<span class="operator">=</span><span class="number">2</span>;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.037</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">insert</span> overwrite <span class="keyword">local</span> directory <span class="string">&#x27;/home/atguigu/hive/emp&#x27;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mock_data.emp sort <span class="keyword">by</span> dept_no <span class="keyword">desc</span>;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">17.73</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="operator">!</span>quit</span><br><span class="line">Closing: <span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span></span><br><span class="line">[atguigu<span class="variable">@hadoop001</span> emp]$ ls</span><br><span class="line"><span class="number">000000</span>_0  <span class="number">000001</span>_0</span><br><span class="line">[atguigu<span class="variable">@hadoop001</span> emp]$</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="6-4-5-分区（Distribute-By）"><a href="#6-4-5-分区（Distribute-By）" class="headerlink" title="6.4.5 分区（Distribute By）"></a>6.4.5 分区（Distribute By）</h3><ul>
<li>Distribute By： 在有些情况下，我们需要控制某个特定行应该到哪个reducer，通常是为了进行后续的聚集操作。distribute by 子句可以做这件事。</li>
<li>Distribute by类似MR中partition（自定义分区），进行分区，结合sort by使用。 </li>
<li>对于distribute by进行测试，一定要分配多reduce进行处理，否则无法看到distribute by的效果。</li>
</ul>
<ol>
<li>案例实操：<ol>
<li>先按照部门编号分区，再按照员工编号降序排序。 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">set</span> mapreduce.job.reduces<span class="operator">=</span><span class="number">3</span>;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.035</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">insert</span> overwrite <span class="keyword">local</span> directory <span class="string">&#x27;/home/atguigu/hive/emp/distribute&#x27;</span> <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\t&#x27;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mock_data.emp distribute <span class="keyword">by</span> dept_no sort <span class="keyword">by</span> emp_no <span class="keyword">desc</span> ;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">18.69</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="operator">!</span>quit</span><br><span class="line">Closing: <span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span></span><br><span class="line">[atguigu<span class="variable">@hadoop001</span> distribute]$ ls</span><br><span class="line"><span class="number">000000</span>_0  <span class="number">000001</span>_0  <span class="number">000002</span>_0</span><br><span class="line">[atguigu<span class="variable">@hadoop001</span> distribute]$ cat <span class="number">000000</span>_0</span><br><span class="line"><span class="number">7900</span>	JAMES	CLERK	<span class="number">7698</span>	<span class="number">1981</span><span class="number">-12</span><span class="number">-3</span>	<span class="number">950.0</span>	\N	<span class="number">30</span></span><br><span class="line"><span class="number">7844</span>	TURNER	SALESMAN	<span class="number">7698</span>	<span class="number">1981</span><span class="number">-9</span><span class="number">-8</span>	<span class="number">1500.0</span>	<span class="number">0.0</span>	<span class="number">30</span></span><br><span class="line"><span class="number">7698</span>	BLAKE	MANAGER	<span class="number">7839</span>	<span class="number">1981</span><span class="number">-5</span><span class="number">-1</span>	<span class="number">2850.0</span>	\N	<span class="number">30</span></span><br><span class="line"><span class="number">7654</span>	MARTIN	SALESMAN	<span class="number">7698</span>	<span class="number">1981</span><span class="number">-9</span><span class="number">-28</span>	<span class="number">1250.0</span>	<span class="number">1400.0</span>	<span class="number">30</span></span><br><span class="line"><span class="number">7521</span>	WARD	SALESMAN	<span class="number">7698</span>	<span class="number">1981</span><span class="number">-2</span><span class="number">-22</span>	<span class="number">1250.0</span>	<span class="number">500.0</span>	<span class="number">30</span></span><br><span class="line"><span class="number">7499</span>	ALLEN	SALESMAN	<span class="number">7698</span>	<span class="number">1981</span><span class="number">-2</span><span class="number">-20</span>	<span class="number">1600.0</span>	<span class="number">300.0</span>	<span class="number">30</span></span><br><span class="line">[atguigu<span class="variable">@hadoop001</span> distribute]$ cat <span class="number">000001</span>_0</span><br><span class="line"><span class="number">7934</span>	MILLER	CLERK	<span class="number">7782</span>	<span class="number">1982</span><span class="number">-1</span><span class="number">-23</span>	<span class="number">1300.0</span>	\N	<span class="number">10</span></span><br><span class="line"><span class="number">7839</span>	KING	PRESIDENT	\N	<span class="number">1981</span><span class="number">-11</span><span class="number">-17</span>	<span class="number">5000.0</span>	\N	<span class="number">10</span></span><br><span class="line"><span class="number">7782</span>	CLARK	MANAGER	<span class="number">7839</span>	<span class="number">1981</span><span class="number">-6</span><span class="number">-9</span>	<span class="number">2450.0</span>	\N	<span class="number">10</span></span><br><span class="line">[atguigu<span class="variable">@hadoop001</span> distribute]$ cat <span class="number">000002</span>_0</span><br><span class="line"><span class="number">7902</span>	FORD	ANALYST	<span class="number">7566</span>	<span class="number">1981</span><span class="number">-12</span><span class="number">-3</span>	<span class="number">3000.0</span>	\N	<span class="number">20</span></span><br><span class="line"><span class="number">7876</span>	ADAMS	CLERK	<span class="number">7788</span>	<span class="number">1987</span><span class="number">-5</span><span class="number">-23</span>	<span class="number">1100.0</span>	\N	<span class="number">20</span></span><br><span class="line"><span class="number">7788</span>	SCOTT	ANALYST	<span class="number">7566</span>	<span class="number">1987</span><span class="number">-4</span><span class="number">-19</span>	<span class="number">3000.0</span>	\N	<span class="number">20</span></span><br><span class="line"><span class="number">7566</span>	JONES	MANAGER	<span class="number">7839</span>	<span class="number">1981</span><span class="number">-4</span><span class="number">-2</span>	<span class="number">2975.0</span>	\N	<span class="number">20</span></span><br><span class="line"><span class="number">7369</span>	SMITH	CLERK	<span class="number">7902</span>	<span class="number">1980</span><span class="number">-12</span><span class="number">-17</span>	<span class="number">800.0</span>	\N	<span class="number">20</span></span><br><span class="line">[atguigu<span class="variable">@hadoop001</span> distribute]$</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li>注意：<ul>
<li>distribute by的分区规则是根据分区字段的hash码与reduce的个数进行模除后，余数相同的分到一个区。</li>
<li>Hive要求DISTRIBUTE BY语句要写在SORT BY语句之前。</li>
</ul>
</li>
</ol>
<h3 id="6-4-6-Cluster-By"><a href="#6-4-6-Cluster-By" class="headerlink" title="6.4.6 Cluster By"></a>6.4.6 Cluster By</h3><ul>
<li>当distribute by和sort by字段相同时，可以使用cluster by方式。</li>
<li>cluster by除了具有distribute by的功能外还兼具sort by的功能。但是排序只能是升序排序，不能指定排序规则为ASC或者DESC。</li>
<li>以下两种写法等价  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp cluster <span class="keyword">by</span> deptno;</span><br><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp distribute <span class="keyword">by</span> deptno sort <span class="keyword">by</span> deptno;</span><br></pre></td></tr></table></figure></li>
<li>注意：按照部门编号分区，不一定就是固定死的数值，可以是20号和30号部门分到一个分区里面去。</li>
</ul>
<h1 id="七、分区表和分桶表"><a href="#七、分区表和分桶表" class="headerlink" title="七、分区表和分桶表"></a>七、分区表和分桶表</h1><h2 id="7-1-分区表"><a href="#7-1-分区表" class="headerlink" title="7.1 分区表"></a>7.1 分区表</h2><ul>
<li>概念：<ol>
<li>出于对数据查询的优化，考虑Hive常规查询会进行全表扫描，效率低下。在建表的时候使用分区表规划更合理的存储结构</li>
<li>分区表实际上就是对应一个HDFS文件系统上的独立的文件夹，该文件夹下是该分区所有的数据文件。</li>
<li>Hive中的分区就是分目录，把一个大的数据集根据业务需要分割成小的数据集。在查询时通过WHERE子句中的表达式选择查询所需要的指定的分区，这样的查询效率会提高很多。</li>
</ol>
</li>
</ul>
<h3 id="7-1-1-分区表基本操作"><a href="#7-1-1-分区表基本操作" class="headerlink" title="7.1.1 分区表基本操作"></a>7.1.1 分区表基本操作</h3><ol>
<li><p>创建分区表语法</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> dept_partition (</span><br><span class="line">    deptno <span class="type">int</span>,</span><br><span class="line">    dname  string,</span><br><span class="line">    loc    string</span><br><span class="line">)</span><br><span class="line">partitioned <span class="keyword">by</span> (<span class="keyword">day</span> string)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>注意：分区字段不能是表中已经存在的数据，可以将分区字段看作表的伪列。</li>
</ul>
</li>
<li><p>加载数据到分区表中</p>
<ul>
<li>数据准备  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dept_20200401.log</span><br><span class="line">10	ACCOUNTING	1700</span><br><span class="line">20	RESEARCH	1800</span><br><span class="line"></span><br><span class="line">dept_20200402.log</span><br><span class="line">30	SALES	1900</span><br><span class="line">40	OPERATIONS	1700</span><br><span class="line"></span><br><span class="line">dept_20200403.log</span><br><span class="line">50	TEST	2000</span><br><span class="line">60	DEV	1900</span><br></pre></td></tr></table></figure></li>
<li>加载数据  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:hive2://hadoop001:10000&gt; load data local inpath &#x27;/home/atguigu/hive/emp/partitioned/dept_20200401.log&#x27; into table mock_data.dept_partition partition(day=&#x27;20200401&#x27;);</span><br><span class="line">No rows affected (1.197 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt; load data local inpath &#x27;/home/atguigu/hive/emp/partitioned/dept_20200402.log&#x27; into table mock_data.dept_partition partition(day=&#x27;20200402&#x27;);</span><br><span class="line">No rows affected (0.363 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt; load data local inpath &#x27;/home/atguigu/hive/emp/partitioned/dept_20200403.log&#x27; into table mock_data.dept_partition partition(day=&#x27;20200403&#x27;);</span><br><span class="line">No rows affected (0.307 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt; dfs -ls /user/hive/warehouse/mock_data.db/dept_partition;</span><br><span class="line">+----------------------------------------------------+</span><br><span class="line">|                     DFS Output                     |</span><br><span class="line">+----------------------------------------------------+</span><br><span class="line">| Found 3 items                                      |</span><br><span class="line">| drwxr-xr-x   - atguigu supergroup          0 2021-10-26 14:18 /user/hive/warehouse/mock_data.db/dept_partition/day=20200401 |</span><br><span class="line">| drwxr-xr-x   - atguigu supergroup          0 2021-10-26 14:18 /user/hive/warehouse/mock_data.db/dept_partition/day=20200402 |</span><br><span class="line">| drwxr-xr-x   - atguigu supergroup          0 2021-10-26 14:18 /user/hive/warehouse/mock_data.db/dept_partition/day=20200403 |</span><br><span class="line">+----------------------------------------------------+</span><br><span class="line">4 rows selected (0.01 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt;</span><br></pre></td></tr></table></figure></li>
<li>注意：分区表加载数据时，必须指定分区</li>
</ul>
</li>
<li><p>查询分区表中数据</p>
<ul>
<li>单分区查询  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dept_partition <span class="keyword">where</span> <span class="keyword">day</span><span class="operator">=</span><span class="string">&#x27;20200401&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li>多分区联合查询  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dept_partition <span class="keyword">where</span> <span class="keyword">day</span><span class="operator">=</span><span class="string">&#x27;20200401&#x27;</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dept_partition <span class="keyword">where</span> <span class="keyword">day</span><span class="operator">=</span><span class="string">&#x27;20200402&#x27;</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dept_partition <span class="keyword">where</span> <span class="keyword">day</span><span class="operator">=</span><span class="string">&#x27;20200403&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dept_partition <span class="keyword">where</span> <span class="keyword">day</span> <span class="keyword">in</span> (<span class="string">&#x27;20200401&#x27;</span>,<span class="string">&#x27;20200402&#x27;</span>,<span class="string">&#x27;20200403&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dept_partition <span class="keyword">where</span> <span class="keyword">day</span> <span class="keyword">between</span> <span class="number">20200401</span> <span class="keyword">and</span> <span class="number">20200403</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dept_partition <span class="keyword">where</span> (<span class="keyword">day</span> <span class="operator">=</span> <span class="string">&#x27;20200401&#x27;</span> <span class="keyword">or</span> <span class="keyword">day</span> <span class="operator">=</span><span class="string">&#x27;20200402&#x27;</span> <span class="keyword">or</span> <span class="keyword">day</span> <span class="operator">=</span> <span class="string">&#x27;20200403&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>增加分区</p>
<ul>
<li>创建单个分区  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> mock_data.dept_partition <span class="keyword">add</span> <span class="keyword">partition</span>(<span class="keyword">day</span><span class="operator">=</span><span class="string">&#x27;20200404&#x27;</span>) ;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.099</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> partitions mock_data.dept_partition;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="keyword">partition</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200401</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200402</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200403</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200404</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> selected (<span class="number">0.075</span> seconds)</span><br></pre></td></tr></table></figure></li>
<li>同时创建多个分区  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> mock_data.dept_partition <span class="keyword">add</span> <span class="keyword">partition</span>(<span class="keyword">day</span><span class="operator">=</span><span class="string">&#x27;20200405&#x27;</span>) <span class="keyword">partition</span>(<span class="keyword">day</span><span class="operator">=</span><span class="string">&#x27;20200406&#x27;</span>);</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.135</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> partitions mock_data.dept_partition;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="keyword">partition</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200401</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200402</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200403</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200404</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200405</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200406</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> selected (<span class="number">0.094</span> seconds)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>删除分区</p>
<ul>
<li>删除单个分区  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> mock_data.dept_partition <span class="keyword">drop</span> <span class="keyword">partition</span>(<span class="keyword">day</span><span class="operator">=</span><span class="string">&#x27;20200404&#x27;</span>) ;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.154</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> partitions mock_data.dept_partition;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="keyword">partition</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200401</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200402</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200403</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200405</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200406</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> selected (<span class="number">0.065</span> seconds)</span><br></pre></td></tr></table></figure></li>
<li>同时删除多个分区  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> mock_data.dept_partition <span class="keyword">drop</span> <span class="keyword">partition</span>(<span class="keyword">day</span><span class="operator">=</span><span class="string">&#x27;20200405&#x27;</span>), <span class="keyword">partition</span>(<span class="keyword">day</span><span class="operator">=</span><span class="string">&#x27;20200406&#x27;</span>);</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.223</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> partitions mock_data.dept_partition;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="keyword">partition</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200401</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200402</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200403</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> selected (<span class="number">0.068</span> seconds)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>查看分区表有多少分区</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> partitions mock_data.dept_partition;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span>   <span class="keyword">partition</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200401</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200402</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span><span class="operator">=</span><span class="number">20200403</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> selected (<span class="number">0.068</span> seconds)</span><br></pre></td></tr></table></figure></li>
<li><p>查看分区表结构(关注Partition Information.numPartitions)</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">desc</span> formatted mock_data.dept_partition;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+----------------------------------------------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span>           col_name            <span class="operator">|</span>                     data_type                      <span class="operator">|</span>        comment        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+----------------------------------------------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> # col_name                    <span class="operator">|</span> data_type                                          <span class="operator">|</span> comment               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> deptno                        <span class="operator">|</span> <span class="type">int</span>                                                <span class="operator">|</span>                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> dname                         <span class="operator">|</span> string                                             <span class="operator">|</span>                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> loc                           <span class="operator">|</span> string                                             <span class="operator">|</span>                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                               <span class="operator">|</span> <span class="keyword">NULL</span>                                               <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> # <span class="keyword">Partition</span> Information       <span class="operator">|</span> <span class="keyword">NULL</span>                                               <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> # col_name                    <span class="operator">|</span> data_type                                          <span class="operator">|</span> comment               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">day</span>                           <span class="operator">|</span> string                                             <span class="operator">|</span>                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                               <span class="operator">|</span> <span class="keyword">NULL</span>                                               <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> # Detailed <span class="keyword">Table</span> Information  <span class="operator">|</span> <span class="keyword">NULL</span>                                               <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Database:                     <span class="operator">|</span> mock_data                                          <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> OwnerType:                    <span class="operator">|</span> <span class="keyword">USER</span>                                               <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Owner:                        <span class="operator">|</span> atguigu                                            <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CreateTime:                   <span class="operator">|</span> Tue Oct <span class="number">26</span> <span class="number">14</span>:<span class="number">10</span>:<span class="number">53</span> CST <span class="number">2021</span>                       <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> LastAccessTime:               <span class="operator">|</span> <span class="literal">UNKNOWN</span>                                            <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Retention:                    <span class="operator">|</span> <span class="number">0</span>                                                  <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Location:                     <span class="operator">|</span> hdfs:<span class="operator">/</span><span class="operator">/</span>mycluster<span class="operator">/</span><span class="keyword">user</span><span class="operator">/</span>hive<span class="operator">/</span>warehouse<span class="operator">/</span>mock_data.db<span class="operator">/</span>dept_partition <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Table</span> Type:                   <span class="operator">|</span> MANAGED_TABLE                                      <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Table</span> Parameters:             <span class="operator">|</span> <span class="keyword">NULL</span>                                               <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                               <span class="operator">|</span> bucketing_version                                  <span class="operator">|</span> <span class="number">2</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                               <span class="operator">|</span> numFiles                                           <span class="operator">|</span> <span class="number">3</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                               <span class="operator">|</span> numPartitions                                      <span class="operator">|</span> <span class="number">3</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                               <span class="operator">|</span> numRows                                            <span class="operator">|</span> <span class="number">0</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                               <span class="operator">|</span> rawDataSize                                        <span class="operator">|</span> <span class="number">0</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                               <span class="operator">|</span> totalSize                                          <span class="operator">|</span> <span class="number">95</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                               <span class="operator">|</span> transient_lastDdlTime                              <span class="operator">|</span> <span class="number">1635228653</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                               <span class="operator">|</span> <span class="keyword">NULL</span>                                               <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> # Storage Information         <span class="operator">|</span> <span class="keyword">NULL</span>                                               <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> SerDe Library:                <span class="operator">|</span> org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> InputFormat:                  <span class="operator">|</span> org.apache.hadoop.mapred.TextInputFormat           <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> OutputFormat:                 <span class="operator">|</span> org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Compressed:                   <span class="operator">|</span> <span class="keyword">No</span>                                                 <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Num Buckets:                  <span class="operator">|</span> <span class="number">-1</span>                                                 <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Bucket Columns:               <span class="operator">|</span> []                                                 <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Sort Columns:                 <span class="operator">|</span> []                                                 <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Storage <span class="keyword">Desc</span> Params:          <span class="operator">|</span> <span class="keyword">NULL</span>                                               <span class="operator">|</span> <span class="keyword">NULL</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                               <span class="operator">|</span> field.delim                                        <span class="operator">|</span> \t                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                               <span class="operator">|</span> serialization.format                               <span class="operator">|</span> \t                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+----------------------------------------------------+-----------------------+</span></span><br><span class="line"><span class="number">38</span> <span class="keyword">rows</span> selected (<span class="number">0.151</span> seconds)</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="7-1-2-二级分区"><a href="#7-1-2-二级分区" class="headerlink" title="7.1.2 二级分区"></a>7.1.2 二级分区</h3><p>思考: 如何一天的日志数据量也很大，如何再将数据拆分?</p>
<ol>
<li>创建多级级分区表 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> dept_partition_level (</span><br><span class="line">    deptno <span class="type">int</span>,</span><br><span class="line">    dname  string,</span><br><span class="line">    loc    string</span><br><span class="line">)</span><br><span class="line">partitioned <span class="keyword">by</span> (<span class="keyword">year</span> string,<span class="keyword">month</span> string, <span class="keyword">day</span> string)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li>正常的加载数据<ul>
<li>加载数据到分区表中  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> load data <span class="keyword">local</span> inpath <span class="string">&#x27;/home/atguigu/hive/emp/partitioned/dept_20200401.log&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> mock_data.dept_partition_level <span class="keyword">partition</span>(<span class="keyword">year</span><span class="operator">=</span><span class="string">&#x27;2020&#x27;</span>, <span class="keyword">month</span><span class="operator">=</span><span class="string">&#x27;04&#x27;</span>,<span class="keyword">day</span><span class="operator">=</span><span class="string">&#x27;01&#x27;</span>);</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.292</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> load data <span class="keyword">local</span> inpath <span class="string">&#x27;/home/atguigu/hive/emp/partitioned/dept_20200402.log&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> mock_data.dept_partition_level <span class="keyword">partition</span>(<span class="keyword">year</span><span class="operator">=</span><span class="string">&#x27;2020&#x27;</span>, <span class="keyword">month</span><span class="operator">=</span><span class="string">&#x27;04&#x27;</span>,<span class="keyword">day</span><span class="operator">=</span><span class="string">&#x27;02&#x27;</span>);</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.295</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> load data <span class="keyword">local</span> inpath <span class="string">&#x27;/home/atguigu/hive/emp/partitioned/dept_20200403.log&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> mock_data.dept_partition_level <span class="keyword">partition</span>(<span class="keyword">year</span><span class="operator">=</span><span class="string">&#x27;2020&#x27;</span>, <span class="keyword">month</span><span class="operator">=</span><span class="string">&#x27;04&#x27;</span>,<span class="keyword">day</span><span class="operator">=</span><span class="string">&#x27;03&#x27;</span>);</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.279</span> seconds)</span><br></pre></td></tr></table></figure></li>
<li>查询分区数据  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> dept_partition_level</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">year</span> <span class="operator">=</span> <span class="number">2020</span></span><br><span class="line">  <span class="keyword">and</span> <span class="keyword">month</span> <span class="operator">=</span> <span class="number">04</span></span><br><span class="line">  <span class="keyword">and</span> <span class="keyword">day</span> <span class="operator">=</span> <span class="number">01</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>把数据直接上传到分区目录上，让分区表和数据产生关联的三种方式<ul>
<li>方式一：上传数据后修复<ul>
<li>上传数据  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 partitioned]$ hadoop fs -mkdir -p /user/hive/warehouse/mock_data.db/dept_partition_level/year=2021/month=06/day=09</span><br><span class="line">[atguigu@hadoop001 partitioned]$ hadoop fs -put dept_20210609.log /user/hive/warehouse/mock_data.db/dept_partition_level/year=2021/month=06/day=09</span><br><span class="line">2021-10-26 15:36:57,908 INFO sasl.SaslDataTransferClient: SASL encryption trust check: localHostTrusted = <span class="literal">false</span>, remoteHostTrusted = <span class="literal">false</span></span><br><span class="line">[atguigu@hadoop001 partitioned]$</span><br></pre></td></tr></table></figure></li>
<li>查询数据（查询不到刚上传的数据）  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:hive2://hadoop001:10000&gt; select *</span><br><span class="line"> from mock_data.dept_partition_level</span><br><span class="line"> <span class="built_in">where</span> year = 2021;</span><br><span class="line">+------------------------------+-----------------------------+---------------------------+----------------------------+-----------------------------+---------------------------+</span><br><span class="line">| dept_partition_level.deptno  | dept_partition_level.dname  | dept_partition_level.loc  | dept_partition_level.year  | dept_partition_level.month  | dept_partition_level.day  |</span><br><span class="line">+------------------------------+-----------------------------+---------------------------+----------------------------+-----------------------------+---------------------------+</span><br><span class="line">| 60                           | ACCOUNTING                  | 1700                      | 2021                       | 04                          | 01                        |</span><br><span class="line">+------------------------------+-----------------------------+---------------------------+----------------------------+-----------------------------+---------------------------+</span><br><span class="line">1 row selected (0.118 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt;</span><br></pre></td></tr></table></figure></li>
<li>执行修复命令再次查询数据  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> msck repair <span class="keyword">table</span> mock_data.dept_partition_level;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.139</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"> <span class="keyword">from</span> mock_data.dept_partition_level</span><br><span class="line"> <span class="keyword">where</span> <span class="keyword">year</span> <span class="operator">=</span> <span class="number">2021</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+-----------------------------+---------------------------+----------------------------+-----------------------------+---------------------------+</span></span><br><span class="line"><span class="operator">|</span> dept_partition_level.deptno  <span class="operator">|</span> dept_partition_level.dname  <span class="operator">|</span> dept_partition_level.loc  <span class="operator">|</span> dept_partition_level.year  <span class="operator">|</span> dept_partition_level.month  <span class="operator">|</span> dept_partition_level.day  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+-----------------------------+---------------------------+----------------------------+-----------------------------+---------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">60</span>                           <span class="operator">|</span> ACCOUNTING                  <span class="operator">|</span> <span class="number">1700</span>                      <span class="operator">|</span> <span class="number">2021</span>                       <span class="operator">|</span> <span class="number">04</span>                          <span class="operator">|</span> <span class="number">01</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span>                           <span class="operator">|</span> ACCOUNTING                  <span class="operator">|</span> <span class="number">1700</span>                      <span class="operator">|</span> <span class="number">2021</span>                       <span class="operator">|</span> <span class="number">06</span>                          <span class="operator">|</span> <span class="number">09</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span>                           <span class="operator">|</span> RESEARCH                    <span class="operator">|</span> <span class="number">1800</span>                      <span class="operator">|</span> <span class="number">2021</span>                       <span class="operator">|</span> <span class="number">06</span>                          <span class="operator">|</span> <span class="number">09</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+-----------------------------+---------------------------+----------------------------+-----------------------------+---------------------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> selected (<span class="number">0.114</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>方式二：上传数据后添加分区<ul>
<li>上传数据  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop001 partitioned]$ hadoop fs -mkdir -p /user/hive/warehouse/mock_data.db/dept_partition_level/year=2021/month=10/day=26</span><br><span class="line">[atguigu@hadoop001 partitioned]$ hadoop fs -put dept_20211026.log /user/hive/warehouse/mock_data.db/dept_partition_level/year=2021/month=10/day=26</span><br><span class="line">2021-10-26 15:51:40,926 INFO sasl.SaslDataTransferClient: SASL encryption trust check: localHostTrusted = <span class="literal">false</span>, remoteHostTrusted = <span class="literal">false</span></span><br></pre></td></tr></table></figure></li>
<li>执行添加分区  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> mock_data.dept_partition_level <span class="keyword">add</span> <span class="keyword">partition</span>(<span class="keyword">year</span><span class="operator">=</span><span class="string">&#x27;2021&#x27;</span>, <span class="keyword">month</span><span class="operator">=</span><span class="string">&#x27;10&#x27;</span>, <span class="keyword">day</span><span class="operator">=</span><span class="string">&#x27;26&#x27;</span>) ;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.062</span> seconds)</span><br></pre></td></tr></table></figure></li>
<li>查询数据  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"> <span class="keyword">from</span> mock_data.dept_partition_level</span><br><span class="line"> <span class="keyword">where</span> <span class="keyword">year</span> <span class="operator">=</span> <span class="number">2021</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+-----------------------------+---------------------------+----------------------------+-----------------------------+---------------------------+</span></span><br><span class="line"><span class="operator">|</span> dept_partition_level.deptno  <span class="operator">|</span> dept_partition_level.dname  <span class="operator">|</span> dept_partition_level.loc  <span class="operator">|</span> dept_partition_level.year  <span class="operator">|</span> dept_partition_level.month  <span class="operator">|</span> dept_partition_level.day  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+-----------------------------+---------------------------+----------------------------+-----------------------------+---------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">60</span>                           <span class="operator">|</span> ACCOUNTING                  <span class="operator">|</span> <span class="number">1700</span>                      <span class="operator">|</span> <span class="number">2021</span>                       <span class="operator">|</span> <span class="number">04</span>                          <span class="operator">|</span> <span class="number">01</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span>                           <span class="operator">|</span> ACCOUNTING                  <span class="operator">|</span> <span class="number">1700</span>                      <span class="operator">|</span> <span class="number">2021</span>                       <span class="operator">|</span> <span class="number">06</span>                          <span class="operator">|</span> <span class="number">09</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span>                           <span class="operator">|</span> RESEARCH                    <span class="operator">|</span> <span class="number">1800</span>                      <span class="operator">|</span> <span class="number">2021</span>                       <span class="operator">|</span> <span class="number">06</span>                          <span class="operator">|</span> <span class="number">09</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span>                           <span class="operator">|</span> ACCOUNTING                  <span class="operator">|</span> <span class="number">1700</span>                      <span class="operator">|</span> <span class="number">2021</span>                       <span class="operator">|</span> <span class="number">10</span>                          <span class="operator">|</span> <span class="number">26</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span>                           <span class="operator">|</span> RESEARCH                    <span class="operator">|</span> <span class="number">1800</span>                      <span class="operator">|</span> <span class="number">2021</span>                       <span class="operator">|</span> <span class="number">10</span>                          <span class="operator">|</span> <span class="number">26</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+-----------------------------+---------------------------+----------------------------+-----------------------------+---------------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> selected (<span class="number">0.094</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>方式三：创建文件夹后load数据到分区<ul>
<li>创建目录  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> dfs <span class="operator">-</span>mkdir <span class="operator">-</span>p <span class="operator">/</span><span class="keyword">user</span><span class="operator">/</span>hive<span class="operator">/</span>warehouse<span class="operator">/</span>mock_data.db<span class="operator">/</span>dept_partition_level<span class="operator">/</span><span class="keyword">year</span><span class="operator">=</span><span class="number">2021</span><span class="operator">/</span><span class="keyword">month</span><span class="operator">=</span><span class="number">12</span><span class="operator">/</span><span class="keyword">day</span><span class="operator">=</span><span class="number">28</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span> DFS Output  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> selected (<span class="number">0.017</span> seconds)</span><br></pre></td></tr></table></figure></li>
<li>上传数据  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> load data <span class="keyword">local</span> inpath <span class="string">&#x27;/home/atguigu/hive/emp/partitioned/dept_20210609.log&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> mock_data.dept_partition_level <span class="keyword">partition</span>(<span class="keyword">year</span><span class="operator">=</span><span class="string">&#x27;2021&#x27;</span>, <span class="keyword">month</span><span class="operator">=</span><span class="string">&#x27;12&#x27;</span>,<span class="keyword">day</span><span class="operator">=</span><span class="string">&#x27;28&#x27;</span>);</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.275</span> seconds)</span><br></pre></td></tr></table></figure></li>
<li>查询数据  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"> <span class="keyword">from</span> mock_data.dept_partition_level</span><br><span class="line"> <span class="keyword">where</span> <span class="keyword">year</span> <span class="operator">=</span> <span class="number">2021</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+-----------------------------+---------------------------+----------------------------+-----------------------------+---------------------------+</span></span><br><span class="line"><span class="operator">|</span> dept_partition_level.deptno  <span class="operator">|</span> dept_partition_level.dname  <span class="operator">|</span> dept_partition_level.loc  <span class="operator">|</span> dept_partition_level.year  <span class="operator">|</span> dept_partition_level.month  <span class="operator">|</span> dept_partition_level.day  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+-----------------------------+---------------------------+----------------------------+-----------------------------+---------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">60</span>                           <span class="operator">|</span> ACCOUNTING                  <span class="operator">|</span> <span class="number">1700</span>                      <span class="operator">|</span> <span class="number">2021</span>                       <span class="operator">|</span> <span class="number">04</span>                          <span class="operator">|</span> <span class="number">01</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span>                           <span class="operator">|</span> ACCOUNTING                  <span class="operator">|</span> <span class="number">1700</span>                      <span class="operator">|</span> <span class="number">2021</span>                       <span class="operator">|</span> <span class="number">06</span>                          <span class="operator">|</span> <span class="number">09</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span>                           <span class="operator">|</span> RESEARCH                    <span class="operator">|</span> <span class="number">1800</span>                      <span class="operator">|</span> <span class="number">2021</span>                       <span class="operator">|</span> <span class="number">06</span>                          <span class="operator">|</span> <span class="number">09</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span>                           <span class="operator">|</span> ACCOUNTING                  <span class="operator">|</span> <span class="number">1700</span>                      <span class="operator">|</span> <span class="number">2021</span>                       <span class="operator">|</span> <span class="number">10</span>                          <span class="operator">|</span> <span class="number">26</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span>                           <span class="operator">|</span> RESEARCH                    <span class="operator">|</span> <span class="number">1800</span>                      <span class="operator">|</span> <span class="number">2021</span>                       <span class="operator">|</span> <span class="number">10</span>                          <span class="operator">|</span> <span class="number">26</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span>                           <span class="operator">|</span> ACCOUNTING                  <span class="operator">|</span> <span class="number">1700</span>                      <span class="operator">|</span> <span class="number">2021</span>                       <span class="operator">|</span> <span class="number">12</span>                          <span class="operator">|</span> <span class="number">28</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span>                           <span class="operator">|</span> RESEARCH                    <span class="operator">|</span> <span class="number">1800</span>                      <span class="operator">|</span> <span class="number">2021</span>                       <span class="operator">|</span> <span class="number">12</span>                          <span class="operator">|</span> <span class="number">28</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+-----------------------------+---------------------------+----------------------------+-----------------------------+---------------------------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> selected (<span class="number">0.107</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="7-1-3-动态分区"><a href="#7-1-3-动态分区" class="headerlink" title="7.1.3 动态分区"></a>7.1.3 动态分区</h3></li>
</ul>
</li>
</ul>
</li>
</ol>
<ul>
<li>关系型数据库中，对分区表Insert数据时候，数据库自动会根据分区字段的值，将数据插入到相应的分区中，Hive中也提供了类似的机制，即动态分区(Dynamic Partition)，只不过，使用Hive的动态分区，需要进行相应的配置。<ol>
<li>开启动态分区参数设置<ol>
<li>开启动态分区功能（默认true，开启） <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive.exec.dynamic.partition=true</span><br></pre></td></tr></table></figure></li>
<li>设置为非严格模式（动态分区的模式，默认strict，表示必须指定至少一个分区为静态分区，nonstrict模式表示允许所有的分区字段都可以使用动态分区。） <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive.exec.dynamic.partition.mode=nonstrict</span><br></pre></td></tr></table></figure></li>
<li>在所有执行MR的节点上，最大一共可以创建多少个动态分区。默认1000 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive.exec.max.dynamic.partitions=1000</span><br></pre></td></tr></table></figure></li>
<li>在每个执行MR的节点上，最大可以创建多少个动态分区。该参数需要根据实际的数据来设定。比如：源数据中包含了一年的数据，即day字段有365个值，那么该参数就需要设置成大于365，如果使用默认值100，则会报错。 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive.exec.max.dynamic.partitions.pernode=100</span><br></pre></td></tr></table></figure></li>
<li>整个MR Job中，最大可以创建多少个HDFS文件。默认100000 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive.exec.max.created.files=100000</span><br></pre></td></tr></table></figure></li>
<li>当有空分区生成时，是否抛出异常。一般不需要设置。默认false <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive.error.on.empty.partition=false</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li>案例实操</li>
</ol>
<ul>
<li>需求：将dept表中的数据按照地区（loc字段），插入到目标表dept_partition的相应分区中。<ol>
<li>创建目标分区表 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> dept_partition_dynamic (</span><br><span class="line">    deptno <span class="type">int</span>,</span><br><span class="line">    dname  string</span><br><span class="line">)</span><br><span class="line">partitioned <span class="keyword">by</span> (loc string)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li>设置动态分区，插入数据 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">set</span> hive.exec.dynamic.partition.mode <span class="operator">=</span> nonstrict;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.005</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> mock_data.dept_partition_dynamic <span class="keyword">partition</span>(loc)</span><br><span class="line"> <span class="keyword">select</span> deptno,dname,loc</span><br><span class="line"> <span class="keyword">from</span> mock_data.dept_partition_level;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">30.709</span> seconds)</span><br></pre></td></tr></table></figure></li>
<li>查看目标分区表的分区情况 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> partitions mock_data.dept_partition_dynamic;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+</span></span><br><span class="line"><span class="operator">|</span>            <span class="keyword">partition</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+</span></span><br><span class="line"><span class="operator">|</span> loc<span class="operator">=</span><span class="number">1700</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> loc<span class="operator">=</span><span class="number">1800</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> loc<span class="operator">=</span><span class="number">1900</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> loc<span class="operator">=</span><span class="number">2000</span>                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> loc<span class="operator">=</span>__HIVE_DEFAULT_PARTITION__  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> selected (<span class="number">0.096</span> seconds)</span><br></pre></td></tr></table></figure></li>
<li>思考：目标分区表是如何匹配到分区字段的？<ul>
<li>通过元数据获取分区表和分区字段</li>
<li>通过分区字段匹配查询结果中的字段</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<h2 id="7-2-分桶表"><a href="#7-2-分桶表" class="headerlink" title="7.2 分桶表"></a>7.2 分桶表</h2><ul>
<li>分区提供一个隔离数据和优化查询的便利方式。不过，并非所有的数据集都可形成合理的分区。对于一张表或者分区，Hive 可以进一步组织成桶，也就是更为细粒度的数据范围划分。</li>
<li>分桶是将数据集分解成更容易管理的若干部分的另一个技术。</li>
<li>分区针对的是数据的存储路径；分桶针对的是数据文件。</li>
</ul>
<ol>
<li>先创建分桶表<ol>
<li>数据准备 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1001	ss1</span><br><span class="line">1002	ss2</span><br><span class="line">1003	ss3</span><br><span class="line">1004	ss4</span><br><span class="line">1005	ss5</span><br><span class="line">1006	ss6</span><br><span class="line">1007	ss7</span><br><span class="line">1008	ss8</span><br><span class="line">1009	ss9</span><br><span class="line">1010	ss10</span><br><span class="line">1011	ss11</span><br><span class="line">1012	ss12</span><br><span class="line">1013	ss13</span><br><span class="line">1014	ss14</span><br><span class="line">1015	ss15</span><br><span class="line">1016	ss16</span><br></pre></td></tr></table></figure></li>
<li>创建分桶表 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> stu_bucket(</span><br><span class="line">    id   <span class="type">int</span>,</span><br><span class="line">    name string</span><br><span class="line">)</span><br><span class="line">clustered <span class="keyword">by</span> (id) <span class="keyword">into</span> <span class="number">4</span> buckets</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> &quot;\t&quot;;</span><br></pre></td></tr></table></figure></li>
<li>查看表结构   <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">desc</span> formatted stu_bucket;</span><br><span class="line">Num Buckets:            <span class="number">4</span>   </span><br></pre></td></tr></table></figure></li>
<li>导入数据到分桶表中，load的方式 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/home/atguigu/hive/bucket/stu_bucket.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> stu_bucket;</span><br></pre></td></tr></table></figure></li>
<li>查看创建的分桶表中是否分成4个桶 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> dfs <span class="operator">-</span>ls <span class="operator">/</span><span class="keyword">user</span><span class="operator">/</span>hive<span class="operator">/</span>warehouse<span class="operator">/</span>mock_data.db<span class="operator">/</span>stu_bucket;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                     DFS Output                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Found <span class="number">4</span> items                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--   3 atguigu supergroup         38 2021-10-26 18:44 /user/hive/warehouse/mock_data.db/stu_bucket/000000_0 |</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--   3 atguigu supergroup         37 2021-10-26 18:44 /user/hive/warehouse/mock_data.db/stu_bucket/000001_0 |</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--   3 atguigu supergroup         38 2021-10-26 18:44 /user/hive/warehouse/mock_data.db/stu_bucket/000002_0 |</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--   3 atguigu supergroup         38 2021-10-26 18:44 /user/hive/warehouse/mock_data.db/stu_bucket/000003_0 |</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> selected (<span class="number">0.01</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>分桶规则：<ul>
<li>根据结果可知：Hive的分桶采用对分桶字段的值进行哈希，然后除以桶的个数求余的方式决定该条记录存放在哪个桶当中</li>
</ul>
</li>
</ol>
</li>
<li>分桶表操作需要注意的事项:<ol>
<li>reduce的个数设置为-1,让Job自行决定需要用多少个reduce或者将reduce的个数设置为大于等于分桶表的桶数</li>
<li>从hdfs中load数据到分桶表中，避免本地文件找不到问题</li>
<li>不要使用本地模式(考虑到资源问题，防止MR执行失败，yarn会分配任务到不同节点)</li>
</ol>
</li>
<li>insert方式将数据导入分桶表 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stu_bucket <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student;</span><br></pre></td></tr></table></figure>
<h2 id="7-3-抽样查询"><a href="#7-3-抽样查询" class="headerlink" title="7.3 抽样查询"></a>7.3 抽样查询</h2></li>
</ol>
<ul>
<li>对于非常大的数据集，有时用户需要使用的是一个具有代表性的查询结果而不是全部结果。Hive可以通过对表进行抽样来满足这个需求。</li>
<li>语法: TABLESAMPLE(BUCKET x OUT OF y ON 分桶字段) </li>
<li>查询表stu_buck中的数据。  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu_buck <span class="keyword">tablesample</span>(bucket <span class="number">1</span> <span class="keyword">out</span> <span class="keyword">of</span> <span class="number">4</span> <span class="keyword">on</span> id);</span><br></pre></td></tr></table></figure></li>
<li>注意：x的值必须小于等于y的值，否则</li>
</ul>
<h1 id="八、函数"><a href="#八、函数" class="headerlink" title="八、函数"></a>八、函数</h1><h2 id="8-1-系统内置函数"><a href="#8-1-系统内置函数" class="headerlink" title="8.1 系统内置函数"></a>8.1 系统内置函数</h2><ol>
<li>查看系统自带的函数 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">show</span> functions <span class="keyword">like</span> count;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> tab_name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> count     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.019</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>显示自带的函数的用法 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">desc</span> <span class="keyword">function</span> upper;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                      tab_name                      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">upper</span>(str) <span class="operator">-</span> <span class="keyword">Returns</span> str <span class="keyword">with</span> <span class="keyword">all</span> characters changed <span class="keyword">to</span> uppercase <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">0.019</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>详细显示自带的函数的用法 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">desc</span> <span class="keyword">function</span> extended upper;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                      tab_name                      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">upper</span>(str) <span class="operator">-</span> <span class="keyword">Returns</span> str <span class="keyword">with</span> <span class="keyword">all</span> characters changed <span class="keyword">to</span> uppercase <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Synonyms: ucase                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Example:                                           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="built_in">upper</span>(<span class="string">&#x27;Facebook&#x27;</span>) <span class="keyword">FROM</span> src LIMIT <span class="number">1</span>;     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="string">&#x27;FACEBOOK&#x27;</span>                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Function</span> class:org.apache.hadoop.hive.ql.udf.generic.GenericUDFUpper <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Function</span> type:BUILTIN                              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> selected (<span class="number">0.079</span> seconds)</span><br></pre></td></tr></table></figure>
<h2 id="8-2-常用内置函数"><a href="#8-2-常用内置函数" class="headerlink" title="8.2 常用内置函数"></a>8.2 常用内置函数</h2><h3 id="8-2-1-空字段赋值"><a href="#8-2-1-空字段赋值" class="headerlink" title="8.2.1 空字段赋值"></a>8.2.1 空字段赋值</h3></li>
<li>函数说明</li>
</ol>
<ul>
<li>NVL：给值为NULL的数据赋值，它的格式是NVL( value，default_value)。它的功能是如果value为NULL，则NVL函数返回default_value的值，否则返回value的值，如果两个参数都为NULL ，则返回NULL。<ul>
<li>示例  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dept;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+-----------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> dept.dept_no  <span class="operator">|</span> dept.dept_name  <span class="operator">|</span> dept.loc  <span class="operator">|</span> dept.dept_desc  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+-----------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span>            <span class="operator">|</span> CEO             <span class="operator">|</span> <span class="number">1700</span>      <span class="operator">|</span> 这是老板            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span>            <span class="operator">|</span> ACCOUNTING      <span class="operator">|</span> <span class="number">1700</span>      <span class="operator">|</span> <span class="keyword">NULL</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span>            <span class="operator">|</span> RESEARCH        <span class="operator">|</span> <span class="number">1800</span>      <span class="operator">|</span> <span class="keyword">NULL</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">30</span>            <span class="operator">|</span> SALES           <span class="operator">|</span> <span class="number">1900</span>      <span class="operator">|</span> <span class="keyword">NULL</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">40</span>            <span class="operator">|</span> OPERATIONS      <span class="operator">|</span> <span class="number">1700</span>      <span class="operator">|</span> <span class="keyword">NULL</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+-----------+-----------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> selected (<span class="number">0.058</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> dept_no, dept_name, loc, nvl(dept_desc,&quot;无描述&quot;) <span class="keyword">from</span> dept;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-------------+-------+-------+</span></span><br><span class="line"><span class="operator">|</span> dept_no  <span class="operator">|</span>  dept_name  <span class="operator">|</span>  loc  <span class="operator">|</span>  _c3  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-------------+-------+-------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span>       <span class="operator">|</span> CEO         <span class="operator">|</span> <span class="number">1700</span>  <span class="operator">|</span> 这是老板  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span>       <span class="operator">|</span> ACCOUNTING  <span class="operator">|</span> <span class="number">1700</span>  <span class="operator">|</span> 无描述   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span>       <span class="operator">|</span> RESEARCH    <span class="operator">|</span> <span class="number">1800</span>  <span class="operator">|</span> 无描述   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">30</span>       <span class="operator">|</span> SALES       <span class="operator">|</span> <span class="number">1900</span>  <span class="operator">|</span> 无描述   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">40</span>       <span class="operator">|</span> OPERATIONS  <span class="operator">|</span> <span class="number">1700</span>  <span class="operator">|</span> 无描述   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-------------+-------+-------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> selected (<span class="number">0.06</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="8-2-2-CASE-WHEN-THEN-ELSE-END"><a href="#8-2-2-CASE-WHEN-THEN-ELSE-END" class="headerlink" title="8.2.2 CASE WHEN THEN ELSE END"></a>8.2.2 CASE WHEN THEN ELSE END</h3><ul>
<li>示例1  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span></span><br><span class="line">        emp_name,</span><br><span class="line">         <span class="keyword">case</span> emp_name</span><br><span class="line">             <span class="keyword">when</span> <span class="string">&#x27;SMITH&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;史密斯&#x27;</span></span><br><span class="line">             <span class="keyword">when</span> <span class="string">&#x27;ALLEN&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;艾伦&#x27;</span></span><br><span class="line">             <span class="keyword">when</span> <span class="string">&#x27;WARD&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;沃德&#x27;</span></span><br><span class="line">             <span class="keyword">when</span> <span class="string">&#x27;JONES&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;琼斯&#x27;</span></span><br><span class="line">             <span class="keyword">when</span> <span class="string">&#x27;MARTIN&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;马丁&#x27;</span></span><br><span class="line">             <span class="keyword">when</span> <span class="string">&#x27;BLAKE&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;布莱克&#x27;</span></span><br><span class="line">             <span class="keyword">when</span> <span class="string">&#x27;CLARK&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;克拉克&#x27;</span></span><br><span class="line">             <span class="keyword">when</span> <span class="string">&#x27;SCOTT&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;斯科特&#x27;</span></span><br><span class="line">             <span class="keyword">when</span> <span class="string">&#x27;KING&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;肯&#x27;</span></span><br><span class="line">             <span class="keyword">when</span> <span class="string">&#x27;TURNER&#x27;</span> <span class="keyword">then</span> <span class="string">&#x27;特纳&#x27;</span></span><br><span class="line">             <span class="keyword">else</span> <span class="string">&#x27;爱啥啥&#x27;</span> <span class="keyword">end</span> chinese_name</span><br><span class="line"> <span class="keyword">from</span> emp;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> emp_name  <span class="operator">|</span> chinese_name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> SMITH     <span class="operator">|</span> 史密斯           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ALLEN     <span class="operator">|</span> 艾伦            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> WARD      <span class="operator">|</span> 沃德            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> JONES     <span class="operator">|</span> 琼斯            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> MARTIN    <span class="operator">|</span> 马丁            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> BLAKE     <span class="operator">|</span> 布莱克           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CLARK     <span class="operator">|</span> 克拉克           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> SCOTT     <span class="operator">|</span> 斯科特           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> KING      <span class="operator">|</span> 肯             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> TURNER    <span class="operator">|</span> 特纳            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ADAMS     <span class="operator">|</span> 爱啥啥           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> JAMES     <span class="operator">|</span> 爱啥啥           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> FORD      <span class="operator">|</span> 爱啥啥           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> MILLER    <span class="operator">|</span> 爱啥啥           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="number">14</span> <span class="keyword">rows</span> selected (<span class="number">0.09</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>示例2  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    dept_no,</span><br><span class="line">       <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> sal <span class="keyword">between</span> <span class="number">3000</span> <span class="keyword">and</span> <span class="number">8000</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span> ) <span class="keyword">as</span> `<span class="number">3000</span>到<span class="number">8000</span>`,</span><br><span class="line">       <span class="built_in">sum</span>(if(sal <span class="operator">&lt;</span> <span class="number">3000</span>, <span class="number">1</span>, <span class="number">0</span>)) <span class="keyword">as</span> `小于<span class="number">3000</span>`</span><br><span class="line"><span class="keyword">from</span> emp</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> dept_no;</span><br></pre></td></tr></table></figure>
<h3 id="8-2-3-行转列"><a href="#8-2-3-行转列" class="headerlink" title="8.2.3 行转列"></a>8.2.3 行转列</h3></li>
</ul>
<ol>
<li>相关函数说明<ol>
<li>CONCAT(string A/col, string B/col…)：返回输入字符串连接后的结果，支持任意个输入字符串;</li>
<li>CONCAT_WS(separator, str1, str2,…)：它是一个特殊形式的 CONCAT()。第一个参数剩余参数间的分隔符。分隔符可以是与剩余参数一样的字符串。如果分隔符是 NULL，返回值也将为 NULL。这个函数会跳过分隔符参数后的任何 NULL 和空字符串。分隔符将被加到被连接的字符串之间;<ul>
<li>注意: CONCAT_WS must be “string or array<string>”</li>
</ul>
</li>
<li>COLLECT_SET(col)：函数只接受基本数据类型，它的主要作用是将某字段的值进行去重汇总，产生array类型字段。 </li>
</ol>
</li>
<li>数据准备  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">name	constellation	blood_type</span><br><span class="line">孙悟空	白羊座	A</span><br><span class="line">大海	射手座	A</span><br><span class="line">宋宋	白羊座	B</span><br><span class="line">猪八戒	白羊座	A</span><br><span class="line">凤姐	射手座	A</span><br><span class="line">苍老师	白羊座	B</span><br></pre></td></tr></table></figure></li>
<li>需求：把星座和血型一样的人归类到一起。结果如下： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">射手座,A            大海|凤姐</span><br><span class="line">白羊座,A            孙悟空|猪八戒</span><br><span class="line">白羊座,B            宋宋|苍老师</span><br></pre></td></tr></table></figure></li>
<li>创建hive表并导入数据 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:hive2://hadoop001:10000&gt; create table person_constellation_blood</span><br><span class="line"> (</span><br><span class="line">     name          string,</span><br><span class="line">     constellation string,</span><br><span class="line">     blood_type    string</span><br><span class="line"> )</span><br><span class="line"> row format delimited fields terminated by <span class="string">&quot;\t&quot;</span>;</span><br><span class="line">No rows affected (5.123 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt; load data <span class="built_in">local</span> inpath <span class="string">&quot;/home/atguigu/hive/person_constellation_blood/person_constellation_blood.txt&quot;</span> into table person_constellation_blood;</span><br><span class="line">No rows affected (0.111 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop001:10000&gt;</span><br></pre></td></tr></table></figure></li>
<li>按需求查询数据 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> t1.cb,</span><br><span class="line">        concat_ws(&quot;|&quot;, collect_set(t1.name))</span><br><span class="line"> <span class="keyword">from</span> (<span class="keyword">select</span> name,</span><br><span class="line">              concat_ws(&quot;,&quot;, constellation, blood_type) cb</span><br><span class="line">       <span class="keyword">from</span> person_constellation_blood) t1</span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> t1.cb;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+----------+</span></span><br><span class="line"><span class="operator">|</span> t1.cb  <span class="operator">|</span>   _c1    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+----------+</span></span><br><span class="line"><span class="operator">|</span> 射手座,A  <span class="operator">|</span> 大海<span class="operator">|</span>凤姐    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 白羊座,A  <span class="operator">|</span> 孙悟空<span class="operator">|</span>猪八戒  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 白羊座,B  <span class="operator">|</span> 宋宋<span class="operator">|</span>苍老师   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+----------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> selected (<span class="number">14.797</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="8-2-4-列转行"><a href="#8-2-4-列转行" class="headerlink" title="8.2.4 列转行"></a>8.2.4 列转行</h3><ol>
<li>函数说明<ul>
<li>EXPLODE(col)：炸裂函数，将hive一列中复杂的array或者map结构拆分成多行。  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> explode(split(&quot;1,2,3,4,5&quot;,&quot;,&quot;));</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> col  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">3</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">4</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">5</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> selected (<span class="number">0.057</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>LATERAL VIEW<ul>
<li>用法：LATERAL VIEW udtf(expression) tableAlias AS columnAlias</li>
<li>解释：用于和split, explode等UDTF一起使用，它能够将一列数据拆成多行数据，在此基础上可以对拆分后的数据进行聚合。</li>
</ul>
</li>
</ul>
</li>
<li>数据准备<table>
<thead>
<tr>
<th>movie</th>
<th>category</th>
</tr>
</thead>
<tbody><tr>
<td>《疑犯追踪》</td>
<td>悬疑,动作,科幻,剧情</td>
</tr>
<tr>
<td>《Lie to me》</td>
<td>悬疑,警匪,动作,心理,剧情</td>
</tr>
<tr>
<td>《战狼2》</td>
<td>战争,动作,灾难</td>
</tr>
</tbody></table>
</li>
<li>需求：将电影分类中的数组数据展开。结果如下： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">《疑犯追踪》	悬疑</span><br><span class="line">《疑犯追踪》	动作</span><br><span class="line">《疑犯追踪》	科幻</span><br><span class="line">《疑犯追踪》	剧情</span><br><span class="line">《Lie to me》	悬疑</span><br><span class="line">《Lie to me》	警匪</span><br><span class="line">《Lie to me》	动作</span><br><span class="line">《Lie to me》	心理</span><br><span class="line">《Lie to me》	剧情</span><br><span class="line">《战狼2》	战争</span><br><span class="line">《战狼2》	动作</span><br><span class="line">《战狼2》	灾难</span><br></pre></td></tr></table></figure></li>
<li>创建hive表并导入数据 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> movie_info(</span><br><span class="line">     movie string,</span><br><span class="line">     category string)</span><br><span class="line"> <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> &quot;\t&quot;;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.065</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> load data <span class="keyword">local</span> inpath <span class="string">&#x27;/home/atguigu/hive/movie_info/movie_info.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> mock_data.movie_info;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.113</span> seconds)</span><br></pre></td></tr></table></figure></li>
<li>按需求查询数据 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span></span><br><span class="line">        movie, category_name</span><br><span class="line"> <span class="keyword">from</span> movie_info</span><br><span class="line"> <span class="keyword">lateral</span> <span class="keyword">view</span></span><br><span class="line">     explode(split(category,<span class="string">&#x27;,&#x27;</span>)) movie_info_tmp <span class="keyword">as</span> category_name;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+----------------+</span></span><br><span class="line"><span class="operator">|</span>    movie     <span class="operator">|</span> category_name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> 《疑犯追踪》       <span class="operator">|</span> 悬疑             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 《疑犯追踪》       <span class="operator">|</span> 动作             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 《疑犯追踪》       <span class="operator">|</span> 科幻             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 《疑犯追踪》       <span class="operator">|</span> 剧情             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 《Lie <span class="keyword">to</span> me》  <span class="operator">|</span> 悬疑             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 《Lie <span class="keyword">to</span> me》  <span class="operator">|</span> 警匪             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 《Lie <span class="keyword">to</span> me》  <span class="operator">|</span> 动作             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 《Lie <span class="keyword">to</span> me》  <span class="operator">|</span> 心理             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 《Lie <span class="keyword">to</span> me》  <span class="operator">|</span> 剧情             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 《战狼<span class="number">2</span>》        <span class="operator">|</span> 战争             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 《战狼<span class="number">2</span>》        <span class="operator">|</span> 动作             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 《战狼<span class="number">2</span>》        <span class="operator">|</span> 灾难             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------+----------------+</span></span><br><span class="line"><span class="number">12</span> <span class="keyword">rows</span> selected (<span class="number">0.105</span> seconds)</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="8-2-5-窗口函数（开窗函数）"><a href="#8-2-5-窗口函数（开窗函数）" class="headerlink" title="8.2.5 窗口函数（开窗函数）"></a>8.2.5 窗口函数（开窗函数）</h3><h4 id="8-2-5-1-窗口函数基本使用"><a href="#8-2-5-1-窗口函数基本使用" class="headerlink" title="8.2.5.1 窗口函数基本使用"></a>8.2.5.1 窗口函数基本使用</h4><ol>
<li>介绍：<ul>
<li>普通聚合函数聚合的行集是组，开窗函数聚合的行集是窗口。因此，普通聚合函数每组（Group by）只有一个返回值，而<font color ='red' >开窗函数则可以为窗口中的每行都返回一个值</font>。</li>
</ul>
</li>
<li>基本结构 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">分析函数(如：sum(), max(), row_number()...) 窗口子句over(partition by 列名 order by 列名 rows between 开始位置 and 结束位置)</span><br></pre></td></tr></table></figure></li>
<li>over函数<ul>
<li>语法结构  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">over(partition by [column_n] order by [column_m])</span><br></pre></td></tr></table></figure>
<ul>
<li>先按照column_n分区，相同的column_n分为一区，每个分区根据column_m排序（默认升序）。</li>
</ul>
</li>
</ul>
</li>
<li>测试数据<ul>
<li>建表并插入数据  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> student_scores <span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> stack(<span class="number">20</span>,</span><br><span class="line">   <span class="number">1</span>, <span class="number">111</span>, <span class="number">68</span>, <span class="number">69</span>, <span class="number">90</span>, <span class="string">&#x27;class1&#x27;</span>, <span class="string">&#x27;department1&#x27;</span>,</span><br><span class="line">   <span class="number">2</span>, <span class="number">112</span>, <span class="number">73</span>, <span class="number">80</span>, <span class="number">96</span>, <span class="string">&#x27;class1&#x27;</span>, <span class="string">&#x27;department1&#x27;</span>,</span><br><span class="line">   <span class="number">3</span>, <span class="number">113</span>, <span class="number">90</span>, <span class="number">74</span>, <span class="number">75</span>, <span class="string">&#x27;class1&#x27;</span>, <span class="string">&#x27;department1&#x27;</span>,</span><br><span class="line">   <span class="number">4</span>, <span class="number">114</span>, <span class="number">89</span>, <span class="number">94</span>, <span class="number">93</span>, <span class="string">&#x27;class1&#x27;</span>, <span class="string">&#x27;department1&#x27;</span>,</span><br><span class="line">   <span class="number">5</span>, <span class="number">115</span>, <span class="number">99</span>, <span class="number">93</span>, <span class="number">89</span>, <span class="string">&#x27;class1&#x27;</span>, <span class="string">&#x27;department1&#x27;</span>,</span><br><span class="line">   <span class="number">6</span>, <span class="number">121</span>, <span class="number">96</span>, <span class="number">74</span>, <span class="number">79</span>, <span class="string">&#x27;class2&#x27;</span>, <span class="string">&#x27;department1&#x27;</span>,</span><br><span class="line">   <span class="number">7</span>, <span class="number">122</span>, <span class="number">89</span>, <span class="number">86</span>, <span class="number">85</span>, <span class="string">&#x27;class2&#x27;</span>, <span class="string">&#x27;department1&#x27;</span>,</span><br><span class="line">   <span class="number">8</span>, <span class="number">123</span>, <span class="number">70</span>, <span class="number">78</span>, <span class="number">61</span>, <span class="string">&#x27;class2&#x27;</span>, <span class="string">&#x27;department1&#x27;</span>,</span><br><span class="line">   <span class="number">9</span>, <span class="number">124</span>, <span class="number">76</span>, <span class="number">70</span>, <span class="number">76</span>, <span class="string">&#x27;class2&#x27;</span>, <span class="string">&#x27;department1&#x27;</span>,</span><br><span class="line">   <span class="number">10</span>, <span class="number">211</span>, <span class="number">89</span>, <span class="number">93</span>, <span class="number">60</span>, <span class="string">&#x27;class1&#x27;</span>, <span class="string">&#x27;department2&#x27;</span>,</span><br><span class="line">   <span class="number">11</span>, <span class="number">212</span>, <span class="number">76</span>, <span class="number">83</span>, <span class="number">75</span>, <span class="string">&#x27;class1&#x27;</span>, <span class="string">&#x27;department2&#x27;</span>,</span><br><span class="line">   <span class="number">12</span>, <span class="number">213</span>, <span class="number">71</span>, <span class="number">94</span>, <span class="number">90</span>, <span class="string">&#x27;class1&#x27;</span>, <span class="string">&#x27;department2&#x27;</span>,</span><br><span class="line">   <span class="number">13</span>, <span class="number">214</span>, <span class="number">94</span>, <span class="number">94</span>, <span class="number">66</span>, <span class="string">&#x27;class1&#x27;</span>, <span class="string">&#x27;department2&#x27;</span>,</span><br><span class="line">   <span class="number">14</span>, <span class="number">215</span>, <span class="number">84</span>, <span class="number">82</span>, <span class="number">73</span>, <span class="string">&#x27;class1&#x27;</span>, <span class="string">&#x27;department2&#x27;</span>,</span><br><span class="line">   <span class="number">15</span>, <span class="number">216</span>, <span class="number">85</span>, <span class="number">74</span>, <span class="number">93</span>, <span class="string">&#x27;class1&#x27;</span>, <span class="string">&#x27;department2&#x27;</span>,</span><br><span class="line">   <span class="number">16</span>, <span class="number">221</span>, <span class="number">77</span>, <span class="number">99</span>, <span class="number">61</span>, <span class="string">&#x27;class2&#x27;</span>, <span class="string">&#x27;department2&#x27;</span>,</span><br><span class="line">   <span class="number">17</span>, <span class="number">222</span>, <span class="number">80</span>, <span class="number">78</span>, <span class="number">96</span>, <span class="string">&#x27;class2&#x27;</span>, <span class="string">&#x27;department2&#x27;</span>,</span><br><span class="line">   <span class="number">18</span>, <span class="number">223</span>, <span class="number">79</span>, <span class="number">74</span>, <span class="number">96</span>, <span class="string">&#x27;class2&#x27;</span>, <span class="string">&#x27;department2&#x27;</span>,</span><br><span class="line">   <span class="number">19</span>, <span class="number">224</span>, <span class="number">75</span>, <span class="number">80</span>, <span class="number">78</span>, <span class="string">&#x27;class2&#x27;</span>, <span class="string">&#x27;department2&#x27;</span>,</span><br><span class="line">   <span class="number">20</span>, <span class="number">225</span>, <span class="number">82</span>, <span class="number">85</span>, <span class="number">63</span>, <span class="string">&#x27;class2&#x27;</span>, <span class="string">&#x27;department2&#x27;</span></span><br><span class="line">) <span class="keyword">as</span> (id,studentId,<span class="keyword">language</span>,math,english,classId,departmentId);</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>窗口示例<ul>
<li>运行sql  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> studentId,</span><br><span class="line">       math,</span><br><span class="line">       departmentId,</span><br><span class="line">       classId,</span><br><span class="line">       <span class="comment">-- 符合所有条件的行作为窗口聚合的行集，这里符合department1的有9个</span></span><br><span class="line">       <span class="built_in">count</span>(math) <span class="keyword">over</span> ()                                                                                    <span class="keyword">as</span> count1,</span><br><span class="line">       <span class="comment">-- 符合条件的行，按照classId分组，每组数据作为窗口聚合的行集</span></span><br><span class="line">       <span class="built_in">count</span>(math) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId)                                                                <span class="keyword">as</span> count2,</span><br><span class="line">       <span class="comment">-- 符合条件的行，按照classId分组，每组数据按照math升序排列后作为窗口聚合的行集</span></span><br><span class="line">       <span class="built_in">count</span>(math) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId <span class="keyword">order</span> <span class="keyword">by</span> math)                                                  <span class="keyword">as</span> count3,</span><br><span class="line">       <span class="comment">-- 符合条件的行，按照classId分组，每组数据按照math升序排列后，当前行向前1行，向后2行（n-1,n,n+1,n+2共四行数据）作为窗口聚合的行集</span></span><br><span class="line">       <span class="built_in">count</span>(math) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId <span class="keyword">order</span> <span class="keyword">by</span> math <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">1</span> preceding <span class="keyword">and</span> <span class="number">2</span> following)         <span class="keyword">as</span> count4,</span><br><span class="line">       <span class="comment">-- 符合条件的行，按照classId分组，每组数据按照math升序排列后，当前行向后到结束行作为窗口聚合的行集</span></span><br><span class="line">       <span class="built_in">count</span>(math) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId <span class="keyword">order</span> <span class="keyword">by</span> math <span class="keyword">rows</span> <span class="keyword">between</span> <span class="keyword">current</span> <span class="type">row</span> <span class="keyword">and</span> unbounded following) <span class="keyword">as</span> count5,</span><br><span class="line">       <span class="comment">-- 符合条件的行，按照classId分组，每组数据按照math升序排列后，从起点行到当前行作为窗口聚合的行集</span></span><br><span class="line">       <span class="built_in">count</span>(math) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId <span class="keyword">order</span> <span class="keyword">by</span> math <span class="keyword">rows</span> <span class="keyword">between</span> unbounded preceding <span class="keyword">and</span> <span class="keyword">current</span> <span class="type">row</span> ) <span class="keyword">as</span> count6</span><br><span class="line"><span class="keyword">from</span> student_scores</span><br><span class="line"><span class="keyword">where</span> departmentId <span class="operator">=</span> <span class="string">&#x27;department1&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li>结果  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+---------+---------+---------+---------+---------+---------+</span></span><br><span class="line"><span class="operator">|</span> studentid  <span class="operator">|</span> math  <span class="operator">|</span> departmentid  <span class="operator">|</span> classid  <span class="operator">|</span> count1  <span class="operator">|</span> count2  <span class="operator">|</span> count3  <span class="operator">|</span> count4  <span class="operator">|</span> count5  <span class="operator">|</span> count6  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+---------+---------+---------+---------+---------+---------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">111</span>        <span class="operator">|</span> <span class="number">69</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">9</span>       <span class="operator">|</span> <span class="number">5</span>       <span class="operator">|</span> <span class="number">1</span>       <span class="operator">|</span> <span class="number">3</span>       <span class="operator">|</span> <span class="number">5</span>       <span class="operator">|</span> <span class="number">1</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">113</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">9</span>       <span class="operator">|</span> <span class="number">5</span>       <span class="operator">|</span> <span class="number">2</span>       <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> <span class="number">2</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">112</span>        <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">9</span>       <span class="operator">|</span> <span class="number">5</span>       <span class="operator">|</span> <span class="number">3</span>       <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> <span class="number">3</span>       <span class="operator">|</span> <span class="number">3</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">115</span>        <span class="operator">|</span> <span class="number">93</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">9</span>       <span class="operator">|</span> <span class="number">5</span>       <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> <span class="number">3</span>       <span class="operator">|</span> <span class="number">2</span>       <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">114</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">9</span>       <span class="operator">|</span> <span class="number">5</span>       <span class="operator">|</span> <span class="number">5</span>       <span class="operator">|</span> <span class="number">2</span>       <span class="operator">|</span> <span class="number">1</span>       <span class="operator">|</span> <span class="number">5</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">124</span>        <span class="operator">|</span> <span class="number">70</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">9</span>       <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> <span class="number">1</span>       <span class="operator">|</span> <span class="number">3</span>       <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> <span class="number">1</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">121</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">9</span>       <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> <span class="number">2</span>       <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> <span class="number">3</span>       <span class="operator">|</span> <span class="number">2</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">123</span>        <span class="operator">|</span> <span class="number">78</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">9</span>       <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> <span class="number">3</span>       <span class="operator">|</span> <span class="number">3</span>       <span class="operator">|</span> <span class="number">2</span>       <span class="operator">|</span> <span class="number">3</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">122</span>        <span class="operator">|</span> <span class="number">86</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">9</span>       <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span> <span class="number">2</span>       <span class="operator">|</span> <span class="number">1</span>       <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+---------+---------+---------+---------+---------+---------+</span></span><br></pre></td></tr></table></figure></li>
<li>结果解析：  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">studentid=114 为例</span><br><span class="line">count1: 为departmentId=department1的行数为9，</span><br><span class="line">count2: 为分区class1中的行数5，</span><br><span class="line">count3: 为分区class1中math升序排列到当前行94 match&lt;=94行数5</span><br><span class="line">count4: 为分区class1中math升序排列后取，当前行-1=115，114，当前行+1=不存在，当前行+2=不存在，行数2</span><br><span class="line">count5: 为分区class1中math升序排列后取，当前行到结束行，114为当前分区最后一行，行数1</span><br><span class="line">count6: 为分区class1中math升序排列后取，开始行到当前行，行数5</span><br></pre></td></tr></table></figure>
<ul>
<li>如果不指定ROWS BETWEEN，默认统计窗口是从起点到当前行</li>
<li>ROWS BETWEEN，也叫做window子句。<ul>
<li>PRECEDING：往前<ul>
<li>n PRECEDING：往前n行数据</li>
</ul>
</li>
<li>FOLLOWING：往后<ul>
<li>n FOLLOWING：往后n行数据</li>
</ul>
</li>
<li>CURRENT ROW：当前行</li>
<li>UNBOUNDED：无边界（一般结合PRECEDING，FOLLOWING使用）</li>
<li>UNBOUNDED PRECEDING 表示该窗口最前面的行（起点）</li>
<li>UNBOUNDED FOLLOWING：表示该窗口最后面的行（终点）</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="8-2-5-2-聚合开窗函数"><a href="#8-2-5-2-聚合开窗函数" class="headerlink" title="8.2.5.2 聚合开窗函数"></a>8.2.5.2 聚合开窗函数</h4><ol>
<li>sum()，min()，max()，avg()都与count()类似<ul>
<li>示例  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> studentId,</span><br><span class="line">       math,</span><br><span class="line">       departmentId,</span><br><span class="line">       classId,</span><br><span class="line">       <span class="comment">-- 符合所有条件的行作为窗口聚合的行集，这里符合department1的有9个</span></span><br><span class="line">       <span class="built_in">avg</span>(math) <span class="keyword">over</span> ()                                                                                    <span class="keyword">as</span> avg1,</span><br><span class="line">       <span class="comment">-- 符合条件的行，按照classId分组，每组数据作为窗口聚合的行集</span></span><br><span class="line">       <span class="built_in">avg</span>(math) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId)                                                                <span class="keyword">as</span> avg2,</span><br><span class="line">       <span class="comment">-- 符合条件的行，按照classId分组，每组数据按照math升序排列后到当前行截止，作为窗口聚合的行集</span></span><br><span class="line">       <span class="built_in">avg</span>(math) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId <span class="keyword">order</span> <span class="keyword">by</span> math)                                                  <span class="keyword">as</span> avg3,</span><br><span class="line">       <span class="comment">-- 符合条件的行，按照classId分组，每组数据按照math升序排列后，当前行向前1行，向后2行（n-1,n,n+1,n+2共四行数据）作为窗口聚合的行集</span></span><br><span class="line">       <span class="built_in">avg</span>(math) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId <span class="keyword">order</span> <span class="keyword">by</span> math <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">1</span> preceding <span class="keyword">and</span> <span class="number">2</span> following)         <span class="keyword">as</span> avg4,</span><br><span class="line">       <span class="comment">-- 符合条件的行，按照classId分组，每组数据按照math升序排列后，当前行向后到结束行作为窗口聚合的行集</span></span><br><span class="line">       <span class="built_in">avg</span>(math) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId <span class="keyword">order</span> <span class="keyword">by</span> math <span class="keyword">rows</span> <span class="keyword">between</span> <span class="keyword">current</span> <span class="type">row</span> <span class="keyword">and</span> unbounded following) <span class="keyword">as</span> avg5,</span><br><span class="line">       <span class="comment">-- 符合条件的行，按照classId分组，每组数据按照math升序排列后，从起点行到当前行作为窗口聚合的行集</span></span><br><span class="line">       <span class="built_in">avg</span>(math) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId <span class="keyword">order</span> <span class="keyword">by</span> math <span class="keyword">rows</span> <span class="keyword">between</span> unbounded preceding <span class="keyword">and</span> <span class="keyword">current</span> <span class="type">row</span> ) <span class="keyword">as</span> avg6</span><br><span class="line"><span class="keyword">from</span> student_scores</span><br><span class="line"><span class="keyword">where</span> departmentId <span class="operator">=</span> <span class="string">&#x27;department1&#x27;</span>;</span><br><span class="line">       </span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+--------------------+-------+--------------------+--------------------+--------------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> studentid  <span class="operator">|</span> math  <span class="operator">|</span> departmentid  <span class="operator">|</span> classid  <span class="operator">|</span>        avg1        <span class="operator">|</span> avg2  <span class="operator">|</span>        avg3        <span class="operator">|</span>        avg4        <span class="operator">|</span>        avg5        <span class="operator">|</span>        avg6        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+--------------------+-------+--------------------+--------------------+--------------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">111</span>        <span class="operator">|</span> <span class="number">69</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">79.77777777777777</span>  <span class="operator">|</span> <span class="number">82.0</span>  <span class="operator">|</span> <span class="number">69.0</span>               <span class="operator">|</span> <span class="number">74.33333333333333</span>  <span class="operator">|</span> <span class="number">82.0</span>               <span class="operator">|</span> <span class="number">69.0</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">113</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">79.77777777777777</span>  <span class="operator">|</span> <span class="number">82.0</span>  <span class="operator">|</span> <span class="number">71.5</span>               <span class="operator">|</span> <span class="number">79.0</span>               <span class="operator">|</span> <span class="number">85.25</span>              <span class="operator">|</span> <span class="number">71.5</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">112</span>        <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">79.77777777777777</span>  <span class="operator">|</span> <span class="number">82.0</span>  <span class="operator">|</span> <span class="number">74.33333333333333</span>  <span class="operator">|</span> <span class="number">85.25</span>              <span class="operator">|</span> <span class="number">89.0</span>               <span class="operator">|</span> <span class="number">74.33333333333333</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">115</span>        <span class="operator">|</span> <span class="number">93</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">79.77777777777777</span>  <span class="operator">|</span> <span class="number">82.0</span>  <span class="operator">|</span> <span class="number">79.0</span>               <span class="operator">|</span> <span class="number">89.0</span>               <span class="operator">|</span> <span class="number">93.5</span>               <span class="operator">|</span> <span class="number">79.0</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">114</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">79.77777777777777</span>  <span class="operator">|</span> <span class="number">82.0</span>  <span class="operator">|</span> <span class="number">82.0</span>               <span class="operator">|</span> <span class="number">93.5</span>               <span class="operator">|</span> <span class="number">94.0</span>               <span class="operator">|</span> <span class="number">82.0</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">124</span>        <span class="operator">|</span> <span class="number">70</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">79.77777777777777</span>  <span class="operator">|</span> <span class="number">77.0</span>  <span class="operator">|</span> <span class="number">70.0</span>               <span class="operator">|</span> <span class="number">74.0</span>               <span class="operator">|</span> <span class="number">77.0</span>               <span class="operator">|</span> <span class="number">70.0</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">121</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">79.77777777777777</span>  <span class="operator">|</span> <span class="number">77.0</span>  <span class="operator">|</span> <span class="number">72.0</span>               <span class="operator">|</span> <span class="number">77.0</span>               <span class="operator">|</span> <span class="number">79.33333333333333</span>  <span class="operator">|</span> <span class="number">72.0</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">123</span>        <span class="operator">|</span> <span class="number">78</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">79.77777777777777</span>  <span class="operator">|</span> <span class="number">77.0</span>  <span class="operator">|</span> <span class="number">74.0</span>               <span class="operator">|</span> <span class="number">79.33333333333333</span>  <span class="operator">|</span> <span class="number">82.0</span>               <span class="operator">|</span> <span class="number">74.0</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">122</span>        <span class="operator">|</span> <span class="number">86</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">79.77777777777777</span>  <span class="operator">|</span> <span class="number">77.0</span>  <span class="operator">|</span> <span class="number">77.0</span>               <span class="operator">|</span> <span class="number">82.0</span>               <span class="operator">|</span> <span class="number">86.0</span>               <span class="operator">|</span> <span class="number">77.0</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+--------------------+-------+--------------------+--------------------+--------------------+--------------------+</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>first_value <ul>
<li>作用：返回分区中的第一个值</li>
<li>sql示例  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> studentId,</span><br><span class="line">       math,</span><br><span class="line">       departmentId,</span><br><span class="line">       classId,</span><br><span class="line">       <span class="built_in">first_value</span>(math) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId <span class="keyword">order</span> <span class="keyword">by</span> math) first_value_1,</span><br><span class="line">       <span class="built_in">first_value</span>(math) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId <span class="keyword">order</span> <span class="keyword">by</span> math <span class="keyword">rows</span> <span class="keyword">between</span> <span class="number">1</span> preceding <span class="keyword">and</span> <span class="number">2</span> following) first_value_2</span><br><span class="line"><span class="keyword">from</span> student_scores</span><br><span class="line"><span class="keyword">where</span> departmentId <span class="operator">=</span> <span class="string">&#x27;department1&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+----------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> studentid  <span class="operator">|</span> math  <span class="operator">|</span> departmentid  <span class="operator">|</span> classid  <span class="operator">|</span> first_value_1  <span class="operator">|</span> first_value_2  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+----------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">111</span>        <span class="operator">|</span> <span class="number">69</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">69</span>             <span class="operator">|</span> <span class="number">69</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">113</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">69</span>             <span class="operator">|</span> <span class="number">69</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">112</span>        <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">69</span>             <span class="operator">|</span> <span class="number">74</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">115</span>        <span class="operator">|</span> <span class="number">93</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">69</span>             <span class="operator">|</span> <span class="number">80</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">114</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">69</span>             <span class="operator">|</span> <span class="number">93</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">124</span>        <span class="operator">|</span> <span class="number">70</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">70</span>             <span class="operator">|</span> <span class="number">70</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">121</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">70</span>             <span class="operator">|</span> <span class="number">70</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">123</span>        <span class="operator">|</span> <span class="number">78</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">70</span>             <span class="operator">|</span> <span class="number">74</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">122</span>        <span class="operator">|</span> <span class="number">86</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">70</span>             <span class="operator">|</span> <span class="number">78</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+----------------+----------------+</span></span><br></pre></td></tr></table></figure></li>
<li>解析  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">studentId=115为例</span><br><span class="line">first_value1：为分区class1中按照math排序的第一个值69(rows between未指定为第一行到当前行)，</span><br><span class="line">first_value2：为分区class2中按照math排序后当前行向前1行向后2行区间的第一个值80。</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>last_vlaue <ul>
<li>作用：返回分区最后一个值</li>
<li>示例sql  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+---------------+---------------+</span></span><br><span class="line"><span class="operator">|</span> studentid  <span class="operator">|</span> math  <span class="operator">|</span> departmentid  <span class="operator">|</span> classid  <span class="operator">|</span> last_value_1  <span class="operator">|</span> last_value_2  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+---------------+---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">111</span>        <span class="operator">|</span> <span class="number">69</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">69</span>            <span class="operator">|</span> <span class="number">80</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">113</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">74</span>            <span class="operator">|</span> <span class="number">93</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">112</span>        <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">80</span>            <span class="operator">|</span> <span class="number">94</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">115</span>        <span class="operator">|</span> <span class="number">93</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">93</span>            <span class="operator">|</span> <span class="number">94</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">114</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">94</span>            <span class="operator">|</span> <span class="number">94</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">124</span>        <span class="operator">|</span> <span class="number">70</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">70</span>            <span class="operator">|</span> <span class="number">78</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">121</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">74</span>            <span class="operator">|</span> <span class="number">86</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">123</span>        <span class="operator">|</span> <span class="number">78</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">78</span>            <span class="operator">|</span> <span class="number">86</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">122</span>        <span class="operator">|</span> <span class="number">86</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">86</span>            <span class="operator">|</span> <span class="number">86</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+---------------+---------------+</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>lag <ul>
<li>作用：LAG(col, n, DEFAULT)用于统计窗口内向上第n行的值<ul>
<li>col：列名</li>
<li>n：向上n行，[可选，默认为1]</li>
<li>DEFAULT：当向上n行为NULL时，取默认值；如果不指定，则为NULL</li>
</ul>
</li>
<li>示例sql:  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> studentId,</span><br><span class="line">       math,</span><br><span class="line">       departmentId,</span><br><span class="line">       classId,</span><br><span class="line">       <span class="built_in">lag</span>(math,<span class="number">1</span>,<span class="number">60</span>) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId <span class="keyword">order</span> <span class="keyword">by</span> math) lag_1,</span><br><span class="line">       <span class="built_in">lag</span>(math,<span class="number">2</span>) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId <span class="keyword">order</span> <span class="keyword">by</span> math) lag_1</span><br><span class="line"><span class="keyword">from</span> student_scores</span><br><span class="line"><span class="keyword">where</span> departmentId <span class="operator">=</span> <span class="string">&#x27;department1&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+--------+--------+</span></span><br><span class="line"><span class="operator">|</span> studentid  <span class="operator">|</span> math  <span class="operator">|</span> departmentid  <span class="operator">|</span> classid  <span class="operator">|</span> lag_1  <span class="operator">|</span> lag_1  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+--------+--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">111</span>        <span class="operator">|</span> <span class="number">69</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">60</span>     <span class="operator">|</span> <span class="keyword">NULL</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">113</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">69</span>     <span class="operator">|</span> <span class="keyword">NULL</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">112</span>        <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">74</span>     <span class="operator">|</span> <span class="number">69</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">115</span>        <span class="operator">|</span> <span class="number">93</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">80</span>     <span class="operator">|</span> <span class="number">74</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">114</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">93</span>     <span class="operator">|</span> <span class="number">80</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">124</span>        <span class="operator">|</span> <span class="number">70</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">60</span>     <span class="operator">|</span> <span class="keyword">NULL</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">121</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">70</span>     <span class="operator">|</span> <span class="keyword">NULL</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">123</span>        <span class="operator">|</span> <span class="number">78</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">74</span>     <span class="operator">|</span> <span class="number">70</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">122</span>        <span class="operator">|</span> <span class="number">86</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">78</span>     <span class="operator">|</span> <span class="number">74</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+--------+--------+</span></span><br></pre></td></tr></table></figure></li>
<li>解析  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">studentId=113，</span><br><span class="line">lag1为分区class1按照math排序后当前行向上2行的值NULL，但是设置了DEFUALT，所以为60，</span><br><span class="line">lag2因为没有设置DEFAULT，所以为NULL。</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>lead<ul>
<li>作用：LEAD(col, n, DEFAULT)与LAG相反，用于统计窗口内向下n行的值<ul>
<li>col：列名</li>
<li>n：向下n行，[可选，默认为1]</li>
<li>DEFAULT：当向下n行为NULL时，取默认值；如果不指定，则为NULL</li>
</ul>
</li>
<li>sql示例  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> studentId,</span><br><span class="line">       math,</span><br><span class="line">       departmentId,</span><br><span class="line">       classId,</span><br><span class="line">       <span class="built_in">lead</span>(math,<span class="number">1</span>,<span class="number">60</span>) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId <span class="keyword">order</span> <span class="keyword">by</span> math) lead_1,</span><br><span class="line">       <span class="built_in">lead</span>(math,<span class="number">2</span>) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId <span class="keyword">order</span> <span class="keyword">by</span> math) lead_1</span><br><span class="line"><span class="keyword">from</span> student_scores</span><br><span class="line"><span class="keyword">where</span> departmentId <span class="operator">=</span> <span class="string">&#x27;department1&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+--------+--------+</span></span><br><span class="line"><span class="operator">|</span> studentid  <span class="operator">|</span> math  <span class="operator">|</span> departmentid  <span class="operator">|</span> classid  <span class="operator">|</span> lead_1  <span class="operator">|</span> lead_1  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+--------+--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">111</span>        <span class="operator">|</span> <span class="number">69</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">74</span>     <span class="operator">|</span> <span class="number">80</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">113</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">80</span>     <span class="operator">|</span> <span class="number">93</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">112</span>        <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">93</span>     <span class="operator">|</span> <span class="number">94</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">115</span>        <span class="operator">|</span> <span class="number">93</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">94</span>     <span class="operator">|</span> <span class="keyword">NULL</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">114</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">60</span>     <span class="operator">|</span> <span class="keyword">NULL</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">124</span>        <span class="operator">|</span> <span class="number">70</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">74</span>     <span class="operator">|</span> <span class="number">78</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">121</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">78</span>     <span class="operator">|</span> <span class="number">86</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">123</span>        <span class="operator">|</span> <span class="number">78</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">86</span>     <span class="operator">|</span> <span class="keyword">NULL</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">122</span>        <span class="operator">|</span> <span class="number">86</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">60</span>     <span class="operator">|</span> <span class="keyword">NULL</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+--------+--------+</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>cume_dist<ul>
<li>作用：计算某个窗口或分区中某个值的累积分布。假定升序排序，则使用以下公式确定累积分布：(小于等于当前值的行数) / (分区内总行数)</li>
<li>sql示例  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> studentId,</span><br><span class="line">       math,</span><br><span class="line">       departmentId,</span><br><span class="line">       classId,</span><br><span class="line">       <span class="built_in">cume_dist</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> math)                      <span class="keyword">as</span> cume_dist1,</span><br><span class="line">       <span class="built_in">cume_dist</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> math <span class="keyword">desc</span>)                 <span class="keyword">as</span> cume_dist2,</span><br><span class="line">       <span class="built_in">cume_dist</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId <span class="keyword">order</span> <span class="keyword">by</span> math) <span class="keyword">as</span> cume_dist3</span><br><span class="line"><span class="keyword">from</span> student_scores</span><br><span class="line"><span class="keyword">where</span> departmentId <span class="operator">=</span> <span class="string">&#x27;department1&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+---------------------+---------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> studentid  <span class="operator">|</span> math  <span class="operator">|</span> departmentid  <span class="operator">|</span> classid  <span class="operator">|</span>     cume_dist1      <span class="operator">|</span>     cume_dist2      <span class="operator">|</span> cume_dist3  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+---------------------+---------------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">111</span>        <span class="operator">|</span> <span class="number">69</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">0.1111111111111111</span>  <span class="operator">|</span> <span class="number">1.0</span>                 <span class="operator">|</span> <span class="number">0.2</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">113</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">0.4444444444444444</span>  <span class="operator">|</span> <span class="number">0.7777777777777778</span>  <span class="operator">|</span> <span class="number">0.4</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">112</span>        <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">0.6666666666666666</span>  <span class="operator">|</span> <span class="number">0.4444444444444444</span>  <span class="operator">|</span> <span class="number">0.6</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">115</span>        <span class="operator">|</span> <span class="number">93</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">0.8888888888888888</span>  <span class="operator">|</span> <span class="number">0.2222222222222222</span>  <span class="operator">|</span> <span class="number">0.8</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">114</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class1   <span class="operator">|</span> <span class="number">1.0</span>                 <span class="operator">|</span> <span class="number">0.1111111111111111</span>  <span class="operator">|</span> <span class="number">1.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">124</span>        <span class="operator">|</span> <span class="number">70</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">0.2222222222222222</span>  <span class="operator">|</span> <span class="number">0.8888888888888888</span>  <span class="operator">|</span> <span class="number">0.25</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">121</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">0.4444444444444444</span>  <span class="operator">|</span> <span class="number">0.7777777777777778</span>  <span class="operator">|</span> <span class="number">0.5</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">123</span>        <span class="operator">|</span> <span class="number">78</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">0.5555555555555556</span>  <span class="operator">|</span> <span class="number">0.5555555555555556</span>  <span class="operator">|</span> <span class="number">0.75</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">122</span>        <span class="operator">|</span> <span class="number">86</span>    <span class="operator">|</span> department1   <span class="operator">|</span> class2   <span class="operator">|</span> <span class="number">0.7777777777777778</span>  <span class="operator">|</span> <span class="number">0.3333333333333333</span>  <span class="operator">|</span> <span class="number">1.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-------+---------------+----------+---------------------+---------------------+-------------+</span></span><br></pre></td></tr></table></figure></li>
<li>结果解析  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">studentId=115为例</span><br><span class="line">cume_dist1=小于等于93的行数8/总行数9=0.8888888888888888</span><br><span class="line">cume_dist2=大于等于93的行数2/总行数9=0.2222222222222222</span><br><span class="line">cume_dist3=class1分区内小于等于93的行数4/总行数5=0.8</span><br></pre></td></tr></table></figure>
<h4 id="8-2-5-3-排序开窗函数"><a href="#8-2-5-3-排序开窗函数" class="headerlink" title="8.2.5.3 排序开窗函数"></a>8.2.5.3 排序开窗函数</h4></li>
</ul>
</li>
<li>row_number<ul>
<li>作用：row_number() over([partition by col1] [order by col2])开窗函数是基于over子句中order by列的一个排名。在窗口或分区内从1开始排序，即使遇到col2相等时，名次依旧增加。例如：有两条记录相等，但一个是第一，一个是第二</li>
<li>sql示例  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,</span><br><span class="line">       studentId,</span><br><span class="line">       <span class="keyword">language</span>,</span><br><span class="line">       math,</span><br><span class="line">       english,</span><br><span class="line">       classId,</span><br><span class="line">       departmentId,</span><br><span class="line">       <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> math) <span class="keyword">as</span> math_order,</span><br><span class="line">       <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> english) <span class="keyword">as</span> english_order,</span><br><span class="line">       <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">language</span>) <span class="keyword">as</span> class_language_order</span><br><span class="line"><span class="keyword">from</span> student_scores;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+------------+-----------+-------+----------+----------+---------------+------------+---------------+----------------------+</span></span><br><span class="line"><span class="operator">|</span> id  <span class="operator">|</span> studentid  <span class="operator">|</span> <span class="keyword">language</span>  <span class="operator">|</span> math  <span class="operator">|</span> english  <span class="operator">|</span> classid  <span class="operator">|</span> departmentid  <span class="operator">|</span> math_order  <span class="operator">|</span> english_order  <span class="operator">|</span> class_language_order  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+------------+-----------+-------+----------+----------+---------------+------------+---------------+----------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>   <span class="operator">|</span> <span class="number">111</span>        <span class="operator">|</span> <span class="number">68</span>        <span class="operator">|</span> <span class="number">69</span>    <span class="operator">|</span> <span class="number">90</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">1</span>          <span class="operator">|</span> <span class="number">14</span>            <span class="operator">|</span> <span class="number">1</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">12</span>  <span class="operator">|</span> <span class="number">213</span>        <span class="operator">|</span> <span class="number">71</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> <span class="number">90</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">17</span>         <span class="operator">|</span> <span class="number">15</span>            <span class="operator">|</span> <span class="number">2</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">112</span>        <span class="operator">|</span> <span class="number">73</span>        <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> <span class="number">96</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">10</span>         <span class="operator">|</span> <span class="number">20</span>            <span class="operator">|</span> <span class="number">3</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">11</span>  <span class="operator">|</span> <span class="number">212</span>        <span class="operator">|</span> <span class="number">76</span>        <span class="operator">|</span> <span class="number">83</span>    <span class="operator">|</span> <span class="number">75</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">12</span>         <span class="operator">|</span> <span class="number">8</span>             <span class="operator">|</span> <span class="number">4</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">14</span>  <span class="operator">|</span> <span class="number">215</span>        <span class="operator">|</span> <span class="number">84</span>        <span class="operator">|</span> <span class="number">82</span>    <span class="operator">|</span> <span class="number">73</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">11</span>         <span class="operator">|</span> <span class="number">6</span>             <span class="operator">|</span> <span class="number">5</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">15</span>  <span class="operator">|</span> <span class="number">216</span>        <span class="operator">|</span> <span class="number">85</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">93</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">4</span>          <span class="operator">|</span> <span class="number">16</span>            <span class="operator">|</span> <span class="number">6</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span>  <span class="operator">|</span> <span class="number">211</span>        <span class="operator">|</span> <span class="number">89</span>        <span class="operator">|</span> <span class="number">93</span>    <span class="operator">|</span> <span class="number">60</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">16</span>         <span class="operator">|</span> <span class="number">1</span>             <span class="operator">|</span> <span class="number">7</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">4</span>   <span class="operator">|</span> <span class="number">114</span>        <span class="operator">|</span> <span class="number">89</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> <span class="number">93</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">18</span>         <span class="operator">|</span> <span class="number">17</span>            <span class="operator">|</span> <span class="number">8</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">3</span>   <span class="operator">|</span> <span class="number">113</span>        <span class="operator">|</span> <span class="number">90</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">75</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">5</span>          <span class="operator">|</span> <span class="number">7</span>             <span class="operator">|</span> <span class="number">9</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">13</span>  <span class="operator">|</span> <span class="number">214</span>        <span class="operator">|</span> <span class="number">94</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> <span class="number">66</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">19</span>         <span class="operator">|</span> <span class="number">5</span>             <span class="operator">|</span> <span class="number">10</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">5</span>   <span class="operator">|</span> <span class="number">115</span>        <span class="operator">|</span> <span class="number">99</span>        <span class="operator">|</span> <span class="number">93</span>    <span class="operator">|</span> <span class="number">89</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">15</span>         <span class="operator">|</span> <span class="number">13</span>            <span class="operator">|</span> <span class="number">11</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">8</span>   <span class="operator">|</span> <span class="number">123</span>        <span class="operator">|</span> <span class="number">70</span>        <span class="operator">|</span> <span class="number">78</span>    <span class="operator">|</span> <span class="number">61</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">7</span>          <span class="operator">|</span> <span class="number">2</span>             <span class="operator">|</span> <span class="number">1</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">19</span>  <span class="operator">|</span> <span class="number">224</span>        <span class="operator">|</span> <span class="number">75</span>        <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> <span class="number">78</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">9</span>          <span class="operator">|</span> <span class="number">10</span>            <span class="operator">|</span> <span class="number">2</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">9</span>   <span class="operator">|</span> <span class="number">124</span>        <span class="operator">|</span> <span class="number">76</span>        <span class="operator">|</span> <span class="number">70</span>    <span class="operator">|</span> <span class="number">76</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">2</span>          <span class="operator">|</span> <span class="number">9</span>             <span class="operator">|</span> <span class="number">3</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">16</span>  <span class="operator">|</span> <span class="number">221</span>        <span class="operator">|</span> <span class="number">77</span>        <span class="operator">|</span> <span class="number">99</span>    <span class="operator">|</span> <span class="number">61</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">20</span>         <span class="operator">|</span> <span class="number">3</span>             <span class="operator">|</span> <span class="number">4</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">18</span>  <span class="operator">|</span> <span class="number">223</span>        <span class="operator">|</span> <span class="number">79</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">96</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">3</span>          <span class="operator">|</span> <span class="number">19</span>            <span class="operator">|</span> <span class="number">5</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">17</span>  <span class="operator">|</span> <span class="number">222</span>        <span class="operator">|</span> <span class="number">80</span>        <span class="operator">|</span> <span class="number">78</span>    <span class="operator">|</span> <span class="number">96</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">8</span>          <span class="operator">|</span> <span class="number">18</span>            <span class="operator">|</span> <span class="number">6</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span>  <span class="operator">|</span> <span class="number">225</span>        <span class="operator">|</span> <span class="number">82</span>        <span class="operator">|</span> <span class="number">85</span>    <span class="operator">|</span> <span class="number">63</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">13</span>         <span class="operator">|</span> <span class="number">4</span>             <span class="operator">|</span> <span class="number">7</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7</span>   <span class="operator">|</span> <span class="number">122</span>        <span class="operator">|</span> <span class="number">89</span>        <span class="operator">|</span> <span class="number">86</span>    <span class="operator">|</span> <span class="number">85</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">14</span>         <span class="operator">|</span> <span class="number">12</span>            <span class="operator">|</span> <span class="number">8</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">6</span>   <span class="operator">|</span> <span class="number">121</span>        <span class="operator">|</span> <span class="number">96</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">79</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">6</span>          <span class="operator">|</span> <span class="number">11</span>            <span class="operator">|</span> <span class="number">9</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+------------+-----------+-------+----------+----------+---------------+------------+---------------+----------------------+</span></span><br></pre></td></tr></table></figure></li>
<li>结果解析   <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">math_order: 以match排序</span><br><span class="line">english_order: 以english排序</span><br><span class="line">class_order: 以classId,departmentId分组后组内排序</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>rank<ul>
<li>作用：rank() over([partition by col1] [order by col2])，当遇到col2相等时，名次相同，但是下一个col2值的名次递增N（N是重复的次数）。例如：有两条记录是并列第一，下一个是第三，没有第二。</li>
<li>sql示例  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,</span><br><span class="line">       studentId,</span><br><span class="line">       <span class="keyword">language</span>,</span><br><span class="line">       math,</span><br><span class="line">       english,</span><br><span class="line">       classId,</span><br><span class="line">       departmentId,</span><br><span class="line">       <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> math) <span class="keyword">as</span> math_rank,</span><br><span class="line">       <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> english) <span class="keyword">as</span> english_rank,</span><br><span class="line">       <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId,departmentId <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">language</span> ) <span class="keyword">as</span> class_language_rank</span><br><span class="line"><span class="keyword">from</span> student_scores;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+------------+-----------+-------+----------+----------+---------------+------------+---------------+----------------------+</span></span><br><span class="line"><span class="operator">|</span> id  <span class="operator">|</span> studentid  <span class="operator">|</span> <span class="keyword">language</span>  <span class="operator">|</span> math  <span class="operator">|</span> english  <span class="operator">|</span> classid  <span class="operator">|</span> departmentid  <span class="operator">|</span> math_rank  <span class="operator">|</span> english_rank  <span class="operator">|</span> class_language_rank  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+------------+-----------+-------+----------+----------+---------------+------------+---------------+----------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>   <span class="operator">|</span> <span class="number">111</span>        <span class="operator">|</span> <span class="number">68</span>        <span class="operator">|</span> <span class="number">69</span>    <span class="operator">|</span> <span class="number">90</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">1</span>          <span class="operator">|</span> <span class="number">14</span>            <span class="operator">|</span> <span class="number">1</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">112</span>        <span class="operator">|</span> <span class="number">73</span>        <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> <span class="number">96</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">9</span>          <span class="operator">|</span> <span class="number">18</span>            <span class="operator">|</span> <span class="number">2</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">4</span>   <span class="operator">|</span> <span class="number">114</span>        <span class="operator">|</span> <span class="number">89</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> <span class="number">93</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">17</span>         <span class="operator">|</span> <span class="number">16</span>            <span class="operator">|</span> <span class="number">3</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">3</span>   <span class="operator">|</span> <span class="number">113</span>        <span class="operator">|</span> <span class="number">90</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">75</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">3</span>          <span class="operator">|</span> <span class="number">7</span>             <span class="operator">|</span> <span class="number">4</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">5</span>   <span class="operator">|</span> <span class="number">115</span>        <span class="operator">|</span> <span class="number">99</span>        <span class="operator">|</span> <span class="number">93</span>    <span class="operator">|</span> <span class="number">89</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">15</span>         <span class="operator">|</span> <span class="number">13</span>            <span class="operator">|</span> <span class="number">5</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">12</span>  <span class="operator">|</span> <span class="number">213</span>        <span class="operator">|</span> <span class="number">71</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> <span class="number">90</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">17</span>         <span class="operator">|</span> <span class="number">14</span>            <span class="operator">|</span> <span class="number">1</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">11</span>  <span class="operator">|</span> <span class="number">212</span>        <span class="operator">|</span> <span class="number">76</span>        <span class="operator">|</span> <span class="number">83</span>    <span class="operator">|</span> <span class="number">75</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">12</span>         <span class="operator">|</span> <span class="number">7</span>             <span class="operator">|</span> <span class="number">2</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">14</span>  <span class="operator">|</span> <span class="number">215</span>        <span class="operator">|</span> <span class="number">84</span>        <span class="operator">|</span> <span class="number">82</span>    <span class="operator">|</span> <span class="number">73</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">11</span>         <span class="operator">|</span> <span class="number">6</span>             <span class="operator">|</span> <span class="number">3</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">15</span>  <span class="operator">|</span> <span class="number">216</span>        <span class="operator">|</span> <span class="number">85</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">93</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">3</span>          <span class="operator">|</span> <span class="number">16</span>            <span class="operator">|</span> <span class="number">4</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span>  <span class="operator">|</span> <span class="number">211</span>        <span class="operator">|</span> <span class="number">89</span>        <span class="operator">|</span> <span class="number">93</span>    <span class="operator">|</span> <span class="number">60</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">15</span>         <span class="operator">|</span> <span class="number">1</span>             <span class="operator">|</span> <span class="number">5</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">13</span>  <span class="operator">|</span> <span class="number">214</span>        <span class="operator">|</span> <span class="number">94</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> <span class="number">66</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">17</span>         <span class="operator">|</span> <span class="number">5</span>             <span class="operator">|</span> <span class="number">6</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">8</span>   <span class="operator">|</span> <span class="number">123</span>        <span class="operator">|</span> <span class="number">70</span>        <span class="operator">|</span> <span class="number">78</span>    <span class="operator">|</span> <span class="number">61</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">7</span>          <span class="operator">|</span> <span class="number">2</span>             <span class="operator">|</span> <span class="number">1</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">9</span>   <span class="operator">|</span> <span class="number">124</span>        <span class="operator">|</span> <span class="number">76</span>        <span class="operator">|</span> <span class="number">70</span>    <span class="operator">|</span> <span class="number">76</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">2</span>          <span class="operator">|</span> <span class="number">9</span>             <span class="operator">|</span> <span class="number">2</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7</span>   <span class="operator">|</span> <span class="number">122</span>        <span class="operator">|</span> <span class="number">89</span>        <span class="operator">|</span> <span class="number">86</span>    <span class="operator">|</span> <span class="number">85</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">14</span>         <span class="operator">|</span> <span class="number">12</span>            <span class="operator">|</span> <span class="number">3</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">6</span>   <span class="operator">|</span> <span class="number">121</span>        <span class="operator">|</span> <span class="number">96</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">79</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">3</span>          <span class="operator">|</span> <span class="number">11</span>            <span class="operator">|</span> <span class="number">4</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">19</span>  <span class="operator">|</span> <span class="number">224</span>        <span class="operator">|</span> <span class="number">75</span>        <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> <span class="number">78</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">9</span>          <span class="operator">|</span> <span class="number">10</span>            <span class="operator">|</span> <span class="number">1</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">16</span>  <span class="operator">|</span> <span class="number">221</span>        <span class="operator">|</span> <span class="number">77</span>        <span class="operator">|</span> <span class="number">99</span>    <span class="operator">|</span> <span class="number">61</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">20</span>         <span class="operator">|</span> <span class="number">2</span>             <span class="operator">|</span> <span class="number">2</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">18</span>  <span class="operator">|</span> <span class="number">223</span>        <span class="operator">|</span> <span class="number">79</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">96</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">3</span>          <span class="operator">|</span> <span class="number">18</span>            <span class="operator">|</span> <span class="number">3</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">17</span>  <span class="operator">|</span> <span class="number">222</span>        <span class="operator">|</span> <span class="number">80</span>        <span class="operator">|</span> <span class="number">78</span>    <span class="operator">|</span> <span class="number">96</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">7</span>          <span class="operator">|</span> <span class="number">18</span>            <span class="operator">|</span> <span class="number">4</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span>  <span class="operator">|</span> <span class="number">225</span>        <span class="operator">|</span> <span class="number">82</span>        <span class="operator">|</span> <span class="number">85</span>    <span class="operator">|</span> <span class="number">63</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">13</span>         <span class="operator">|</span> <span class="number">4</span>             <span class="operator">|</span> <span class="number">5</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+------------+-----------+-------+----------+----------+---------------+------------+---------------+----------------------+</span></span><br></pre></td></tr></table></figure></li>
<li>结果解析  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">math_rank: 以match排序 ,student_id：113、216、121、223 math相同，排名都为3，123序号=7</span><br><span class="line">class_language_rank: 以classId,departmentId分组后组内排序</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>dense_rank<ul>
<li>作用：dense_rank() over([partition by col1] [order by col2])与rank类似，当遇到col2相等时，名次同样相等，不同的是，下一个col2值的名次+1，而不是+N。</li>
<li>sql示例  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,</span><br><span class="line">       studentId,</span><br><span class="line">       <span class="keyword">language</span>,</span><br><span class="line">       math,</span><br><span class="line">       english,</span><br><span class="line">       classId,</span><br><span class="line">       departmentId,</span><br><span class="line">       <span class="built_in">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> math) <span class="keyword">as</span> math_dense_rank,</span><br><span class="line">       <span class="built_in">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> english) <span class="keyword">as</span> english_dense_rank,</span><br><span class="line">       <span class="built_in">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId,departmentId <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">language</span> ) <span class="keyword">as</span> class_language_dense_rank</span><br><span class="line"><span class="keyword">from</span> student_scores;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+------------+-----------+-------+----------+----------+---------------+------------------+---------------------+----------------------------+</span></span><br><span class="line"><span class="operator">|</span> id  <span class="operator">|</span> studentid  <span class="operator">|</span> <span class="keyword">language</span>  <span class="operator">|</span> math  <span class="operator">|</span> english  <span class="operator">|</span> classid  <span class="operator">|</span> departmentid  <span class="operator">|</span> math_dense_rank  <span class="operator">|</span> english_dense_rank  <span class="operator">|</span> class_language_dense_rank  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+------------+-----------+-------+----------+----------+---------------+------------------+---------------------+----------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>   <span class="operator">|</span> <span class="number">111</span>        <span class="operator">|</span> <span class="number">68</span>        <span class="operator">|</span> <span class="number">69</span>    <span class="operator">|</span> <span class="number">90</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">1</span>                <span class="operator">|</span> <span class="number">12</span>                  <span class="operator">|</span> <span class="number">1</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">112</span>        <span class="operator">|</span> <span class="number">73</span>        <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> <span class="number">96</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">5</span>                <span class="operator">|</span> <span class="number">14</span>                  <span class="operator">|</span> <span class="number">2</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">4</span>   <span class="operator">|</span> <span class="number">114</span>        <span class="operator">|</span> <span class="number">89</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> <span class="number">93</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">11</span>               <span class="operator">|</span> <span class="number">13</span>                  <span class="operator">|</span> <span class="number">3</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">3</span>   <span class="operator">|</span> <span class="number">113</span>        <span class="operator">|</span> <span class="number">90</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">75</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">3</span>                <span class="operator">|</span> <span class="number">6</span>                   <span class="operator">|</span> <span class="number">4</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">5</span>   <span class="operator">|</span> <span class="number">115</span>        <span class="operator">|</span> <span class="number">99</span>        <span class="operator">|</span> <span class="number">93</span>    <span class="operator">|</span> <span class="number">89</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">10</span>               <span class="operator">|</span> <span class="number">11</span>                  <span class="operator">|</span> <span class="number">5</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">12</span>  <span class="operator">|</span> <span class="number">213</span>        <span class="operator">|</span> <span class="number">71</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> <span class="number">90</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">11</span>               <span class="operator">|</span> <span class="number">12</span>                  <span class="operator">|</span> <span class="number">1</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">11</span>  <span class="operator">|</span> <span class="number">212</span>        <span class="operator">|</span> <span class="number">76</span>        <span class="operator">|</span> <span class="number">83</span>    <span class="operator">|</span> <span class="number">75</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">7</span>                <span class="operator">|</span> <span class="number">6</span>                   <span class="operator">|</span> <span class="number">2</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">14</span>  <span class="operator">|</span> <span class="number">215</span>        <span class="operator">|</span> <span class="number">84</span>        <span class="operator">|</span> <span class="number">82</span>    <span class="operator">|</span> <span class="number">73</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">6</span>                <span class="operator">|</span> <span class="number">5</span>                   <span class="operator">|</span> <span class="number">3</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">15</span>  <span class="operator">|</span> <span class="number">216</span>        <span class="operator">|</span> <span class="number">85</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">93</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">3</span>                <span class="operator">|</span> <span class="number">13</span>                  <span class="operator">|</span> <span class="number">4</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span>  <span class="operator">|</span> <span class="number">211</span>        <span class="operator">|</span> <span class="number">89</span>        <span class="operator">|</span> <span class="number">93</span>    <span class="operator">|</span> <span class="number">60</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">10</span>               <span class="operator">|</span> <span class="number">1</span>                   <span class="operator">|</span> <span class="number">5</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">13</span>  <span class="operator">|</span> <span class="number">214</span>        <span class="operator">|</span> <span class="number">94</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> <span class="number">66</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">11</span>               <span class="operator">|</span> <span class="number">4</span>                   <span class="operator">|</span> <span class="number">6</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">8</span>   <span class="operator">|</span> <span class="number">123</span>        <span class="operator">|</span> <span class="number">70</span>        <span class="operator">|</span> <span class="number">78</span>    <span class="operator">|</span> <span class="number">61</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">4</span>                <span class="operator">|</span> <span class="number">2</span>                   <span class="operator">|</span> <span class="number">1</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">9</span>   <span class="operator">|</span> <span class="number">124</span>        <span class="operator">|</span> <span class="number">76</span>        <span class="operator">|</span> <span class="number">70</span>    <span class="operator">|</span> <span class="number">76</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">2</span>                <span class="operator">|</span> <span class="number">7</span>                   <span class="operator">|</span> <span class="number">2</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7</span>   <span class="operator">|</span> <span class="number">122</span>        <span class="operator">|</span> <span class="number">89</span>        <span class="operator">|</span> <span class="number">86</span>    <span class="operator">|</span> <span class="number">85</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">9</span>                <span class="operator">|</span> <span class="number">10</span>                  <span class="operator">|</span> <span class="number">3</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">6</span>   <span class="operator">|</span> <span class="number">121</span>        <span class="operator">|</span> <span class="number">96</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">79</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">3</span>                <span class="operator">|</span> <span class="number">9</span>                   <span class="operator">|</span> <span class="number">4</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">19</span>  <span class="operator">|</span> <span class="number">224</span>        <span class="operator">|</span> <span class="number">75</span>        <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> <span class="number">78</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">5</span>                <span class="operator">|</span> <span class="number">8</span>                   <span class="operator">|</span> <span class="number">1</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">16</span>  <span class="operator">|</span> <span class="number">221</span>        <span class="operator">|</span> <span class="number">77</span>        <span class="operator">|</span> <span class="number">99</span>    <span class="operator">|</span> <span class="number">61</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">12</span>               <span class="operator">|</span> <span class="number">2</span>                   <span class="operator">|</span> <span class="number">2</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">18</span>  <span class="operator">|</span> <span class="number">223</span>        <span class="operator">|</span> <span class="number">79</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">96</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">3</span>                <span class="operator">|</span> <span class="number">14</span>                  <span class="operator">|</span> <span class="number">3</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">17</span>  <span class="operator">|</span> <span class="number">222</span>        <span class="operator">|</span> <span class="number">80</span>        <span class="operator">|</span> <span class="number">78</span>    <span class="operator">|</span> <span class="number">96</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">4</span>                <span class="operator">|</span> <span class="number">14</span>                  <span class="operator">|</span> <span class="number">4</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span>  <span class="operator">|</span> <span class="number">225</span>        <span class="operator">|</span> <span class="number">82</span>        <span class="operator">|</span> <span class="number">85</span>    <span class="operator">|</span> <span class="number">63</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">8</span>                <span class="operator">|</span> <span class="number">3</span>                   <span class="operator">|</span> <span class="number">5</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+------------+-----------+-------+----------+----------+---------------+------------------+---------------------+----------------------------+</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>ntile<ul>
<li>作用：ntile(N) over([partition by col1] [order by col2])，将分区中的数据按照顺序划分为N片，返回当前片的值。<ul>
<li>注1：如果切片分布不均匀，默认增加第一个切片的分布</li>
<li>注2：ntile不支持ROWS BETWEEN</li>
</ul>
</li>
<li>sql示例  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,</span><br><span class="line">       studentId,</span><br><span class="line">       <span class="keyword">language</span>,</span><br><span class="line">       math,</span><br><span class="line">       english,</span><br><span class="line">       classId,</span><br><span class="line">       departmentId,</span><br><span class="line">       <span class="built_in">ntile</span>(<span class="number">2</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> math) <span class="keyword">as</span> math_ntile,</span><br><span class="line">       <span class="built_in">ntile</span>(<span class="number">2</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> english) <span class="keyword">as</span> english_ntile,</span><br><span class="line">       <span class="built_in">ntile</span>(<span class="number">2</span>) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId,departmentId <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">language</span> ) <span class="keyword">as</span> class_language_ntile</span><br><span class="line"><span class="keyword">from</span> student_scores;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+------------+-----------+-------+----------+----------+---------------+-------------+----------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> id  <span class="operator">|</span> studentid  <span class="operator">|</span> <span class="keyword">language</span>  <span class="operator">|</span> math  <span class="operator">|</span> english  <span class="operator">|</span> classid  <span class="operator">|</span> departmentid  <span class="operator">|</span> math_ntile  <span class="operator">|</span> english_ntile  <span class="operator">|</span> class_language_ntile  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+------------+-----------+-------+----------+----------+---------------+-------------+----------------+-----------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>   <span class="operator">|</span> <span class="number">111</span>        <span class="operator">|</span> <span class="number">68</span>        <span class="operator">|</span> <span class="number">69</span>    <span class="operator">|</span> <span class="number">90</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">1</span>           <span class="operator">|</span> <span class="number">2</span>              <span class="operator">|</span> <span class="number">1</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">112</span>        <span class="operator">|</span> <span class="number">73</span>        <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> <span class="number">96</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">1</span>           <span class="operator">|</span> <span class="number">2</span>              <span class="operator">|</span> <span class="number">1</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">4</span>   <span class="operator">|</span> <span class="number">114</span>        <span class="operator">|</span> <span class="number">89</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> <span class="number">93</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">2</span>           <span class="operator">|</span> <span class="number">2</span>              <span class="operator">|</span> <span class="number">1</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">3</span>   <span class="operator">|</span> <span class="number">113</span>        <span class="operator">|</span> <span class="number">90</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">75</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">1</span>           <span class="operator">|</span> <span class="number">1</span>              <span class="operator">|</span> <span class="number">2</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">5</span>   <span class="operator">|</span> <span class="number">115</span>        <span class="operator">|</span> <span class="number">99</span>        <span class="operator">|</span> <span class="number">93</span>    <span class="operator">|</span> <span class="number">89</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">2</span>           <span class="operator">|</span> <span class="number">2</span>              <span class="operator">|</span> <span class="number">2</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">12</span>  <span class="operator">|</span> <span class="number">213</span>        <span class="operator">|</span> <span class="number">71</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> <span class="number">90</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">2</span>           <span class="operator">|</span> <span class="number">2</span>              <span class="operator">|</span> <span class="number">1</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">11</span>  <span class="operator">|</span> <span class="number">212</span>        <span class="operator">|</span> <span class="number">76</span>        <span class="operator">|</span> <span class="number">83</span>    <span class="operator">|</span> <span class="number">75</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">2</span>           <span class="operator">|</span> <span class="number">1</span>              <span class="operator">|</span> <span class="number">1</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">14</span>  <span class="operator">|</span> <span class="number">215</span>        <span class="operator">|</span> <span class="number">84</span>        <span class="operator">|</span> <span class="number">82</span>    <span class="operator">|</span> <span class="number">73</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">2</span>           <span class="operator">|</span> <span class="number">1</span>              <span class="operator">|</span> <span class="number">1</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">15</span>  <span class="operator">|</span> <span class="number">216</span>        <span class="operator">|</span> <span class="number">85</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">93</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">1</span>           <span class="operator">|</span> <span class="number">2</span>              <span class="operator">|</span> <span class="number">2</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span>  <span class="operator">|</span> <span class="number">211</span>        <span class="operator">|</span> <span class="number">89</span>        <span class="operator">|</span> <span class="number">93</span>    <span class="operator">|</span> <span class="number">60</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">2</span>           <span class="operator">|</span> <span class="number">1</span>              <span class="operator">|</span> <span class="number">2</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">13</span>  <span class="operator">|</span> <span class="number">214</span>        <span class="operator">|</span> <span class="number">94</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> <span class="number">66</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">2</span>           <span class="operator">|</span> <span class="number">1</span>              <span class="operator">|</span> <span class="number">2</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">8</span>   <span class="operator">|</span> <span class="number">123</span>        <span class="operator">|</span> <span class="number">70</span>        <span class="operator">|</span> <span class="number">78</span>    <span class="operator">|</span> <span class="number">61</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">1</span>           <span class="operator">|</span> <span class="number">1</span>              <span class="operator">|</span> <span class="number">1</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">9</span>   <span class="operator">|</span> <span class="number">124</span>        <span class="operator">|</span> <span class="number">76</span>        <span class="operator">|</span> <span class="number">70</span>    <span class="operator">|</span> <span class="number">76</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">1</span>           <span class="operator">|</span> <span class="number">1</span>              <span class="operator">|</span> <span class="number">1</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7</span>   <span class="operator">|</span> <span class="number">122</span>        <span class="operator">|</span> <span class="number">89</span>        <span class="operator">|</span> <span class="number">86</span>    <span class="operator">|</span> <span class="number">85</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">2</span>           <span class="operator">|</span> <span class="number">2</span>              <span class="operator">|</span> <span class="number">2</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">6</span>   <span class="operator">|</span> <span class="number">121</span>        <span class="operator">|</span> <span class="number">96</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">79</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">1</span>           <span class="operator">|</span> <span class="number">2</span>              <span class="operator">|</span> <span class="number">2</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">19</span>  <span class="operator">|</span> <span class="number">224</span>        <span class="operator">|</span> <span class="number">75</span>        <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> <span class="number">78</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">1</span>           <span class="operator">|</span> <span class="number">1</span>              <span class="operator">|</span> <span class="number">1</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">16</span>  <span class="operator">|</span> <span class="number">221</span>        <span class="operator">|</span> <span class="number">77</span>        <span class="operator">|</span> <span class="number">99</span>    <span class="operator">|</span> <span class="number">61</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">2</span>           <span class="operator">|</span> <span class="number">1</span>              <span class="operator">|</span> <span class="number">1</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">18</span>  <span class="operator">|</span> <span class="number">223</span>        <span class="operator">|</span> <span class="number">79</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">96</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">1</span>           <span class="operator">|</span> <span class="number">2</span>              <span class="operator">|</span> <span class="number">1</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">17</span>  <span class="operator">|</span> <span class="number">222</span>        <span class="operator">|</span> <span class="number">80</span>        <span class="operator">|</span> <span class="number">78</span>    <span class="operator">|</span> <span class="number">96</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">1</span>           <span class="operator">|</span> <span class="number">2</span>              <span class="operator">|</span> <span class="number">2</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span>  <span class="operator">|</span> <span class="number">225</span>        <span class="operator">|</span> <span class="number">82</span>        <span class="operator">|</span> <span class="number">85</span>    <span class="operator">|</span> <span class="number">63</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">2</span>           <span class="operator">|</span> <span class="number">1</span>              <span class="operator">|</span> <span class="number">2</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+------------+-----------+-------+----------+----------+---------------+-------------+----------------+-----------------------+</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>percent_rank<ul>
<li>作用：percent_rank() over([partition by col1] [order by col2])，计算给定行的百分比排名。分组内当前行的RANK值-1/分组内总行数-1，可以用来计算超过了百分之多少的人。</li>
<li>sql示例  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,</span><br><span class="line">       studentid,</span><br><span class="line">       <span class="keyword">language</span>,</span><br><span class="line">       math,</span><br><span class="line">       english,</span><br><span class="line">       classid,</span><br><span class="line">       departmentid,</span><br><span class="line">       <span class="built_in">percent_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> math)                                        <span class="keyword">as</span> math_percent_rank,</span><br><span class="line">       <span class="built_in">percent_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> english)                                     <span class="keyword">as</span> english_percent_rank,</span><br><span class="line">       <span class="built_in">percent_rank</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> classId,departmentId <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">language</span> ) <span class="keyword">as</span> class_language_percent_rank</span><br><span class="line"><span class="keyword">from</span> student_scores;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+------------+-----------+-------+----------+----------+---------------+----------------------+-----------------------+------------------------------+</span></span><br><span class="line"><span class="operator">|</span> id  <span class="operator">|</span> studentid  <span class="operator">|</span> <span class="keyword">language</span>  <span class="operator">|</span> math  <span class="operator">|</span> english  <span class="operator">|</span> classid  <span class="operator">|</span> departmentid  <span class="operator">|</span>  math_percent_rank   <span class="operator">|</span> english_percent_rank  <span class="operator">|</span> class_language_percent_rank  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+------------+-----------+-------+----------+----------+---------------+----------------------+-----------------------+------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>   <span class="operator">|</span> <span class="number">111</span>        <span class="operator">|</span> <span class="number">68</span>        <span class="operator">|</span> <span class="number">69</span>    <span class="operator">|</span> <span class="number">90</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">0.0</span>                  <span class="operator">|</span> <span class="number">0.6842105263157895</span>    <span class="operator">|</span> <span class="number">0.0</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">112</span>        <span class="operator">|</span> <span class="number">73</span>        <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> <span class="number">96</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">0.42105263157894735</span>  <span class="operator">|</span> <span class="number">0.8947368421052632</span>    <span class="operator">|</span> <span class="number">0.25</span>                         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">4</span>   <span class="operator">|</span> <span class="number">114</span>        <span class="operator">|</span> <span class="number">89</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> <span class="number">93</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">0.8421052631578947</span>   <span class="operator">|</span> <span class="number">0.7894736842105263</span>    <span class="operator">|</span> <span class="number">0.5</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">3</span>   <span class="operator">|</span> <span class="number">113</span>        <span class="operator">|</span> <span class="number">90</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">75</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">0.10526315789473684</span>  <span class="operator">|</span> <span class="number">0.3157894736842105</span>    <span class="operator">|</span> <span class="number">0.75</span>                         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">5</span>   <span class="operator">|</span> <span class="number">115</span>        <span class="operator">|</span> <span class="number">99</span>        <span class="operator">|</span> <span class="number">93</span>    <span class="operator">|</span> <span class="number">89</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">0.7368421052631579</span>   <span class="operator">|</span> <span class="number">0.631578947368421</span>     <span class="operator">|</span> <span class="number">1.0</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">12</span>  <span class="operator">|</span> <span class="number">213</span>        <span class="operator">|</span> <span class="number">71</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> <span class="number">90</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">0.8421052631578947</span>   <span class="operator">|</span> <span class="number">0.6842105263157895</span>    <span class="operator">|</span> <span class="number">0.0</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">11</span>  <span class="operator">|</span> <span class="number">212</span>        <span class="operator">|</span> <span class="number">76</span>        <span class="operator">|</span> <span class="number">83</span>    <span class="operator">|</span> <span class="number">75</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">0.5789473684210527</span>   <span class="operator">|</span> <span class="number">0.3157894736842105</span>    <span class="operator">|</span> <span class="number">0.2</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">14</span>  <span class="operator">|</span> <span class="number">215</span>        <span class="operator">|</span> <span class="number">84</span>        <span class="operator">|</span> <span class="number">82</span>    <span class="operator">|</span> <span class="number">73</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">0.5263157894736842</span>   <span class="operator">|</span> <span class="number">0.2631578947368421</span>    <span class="operator">|</span> <span class="number">0.4</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">15</span>  <span class="operator">|</span> <span class="number">216</span>        <span class="operator">|</span> <span class="number">85</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">93</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">0.10526315789473684</span>  <span class="operator">|</span> <span class="number">0.7894736842105263</span>    <span class="operator">|</span> <span class="number">0.6</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span>  <span class="operator">|</span> <span class="number">211</span>        <span class="operator">|</span> <span class="number">89</span>        <span class="operator">|</span> <span class="number">93</span>    <span class="operator">|</span> <span class="number">60</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">0.7368421052631579</span>   <span class="operator">|</span> <span class="number">0.0</span>                   <span class="operator">|</span> <span class="number">0.8</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">13</span>  <span class="operator">|</span> <span class="number">214</span>        <span class="operator">|</span> <span class="number">94</span>        <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> <span class="number">66</span>       <span class="operator">|</span> class1   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">0.8421052631578947</span>   <span class="operator">|</span> <span class="number">0.21052631578947367</span>   <span class="operator">|</span> <span class="number">1.0</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">8</span>   <span class="operator">|</span> <span class="number">123</span>        <span class="operator">|</span> <span class="number">70</span>        <span class="operator">|</span> <span class="number">78</span>    <span class="operator">|</span> <span class="number">61</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">0.3157894736842105</span>   <span class="operator">|</span> <span class="number">0.05263157894736842</span>   <span class="operator">|</span> <span class="number">0.0</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">9</span>   <span class="operator">|</span> <span class="number">124</span>        <span class="operator">|</span> <span class="number">76</span>        <span class="operator">|</span> <span class="number">70</span>    <span class="operator">|</span> <span class="number">76</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">0.05263157894736842</span>  <span class="operator">|</span> <span class="number">0.42105263157894735</span>   <span class="operator">|</span> <span class="number">0.3333333333333333</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7</span>   <span class="operator">|</span> <span class="number">122</span>        <span class="operator">|</span> <span class="number">89</span>        <span class="operator">|</span> <span class="number">86</span>    <span class="operator">|</span> <span class="number">85</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">0.6842105263157895</span>   <span class="operator">|</span> <span class="number">0.5789473684210527</span>    <span class="operator">|</span> <span class="number">0.6666666666666666</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">6</span>   <span class="operator">|</span> <span class="number">121</span>        <span class="operator">|</span> <span class="number">96</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">79</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department1   <span class="operator">|</span> <span class="number">0.10526315789473684</span>  <span class="operator">|</span> <span class="number">0.5263157894736842</span>    <span class="operator">|</span> <span class="number">1.0</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">19</span>  <span class="operator">|</span> <span class="number">224</span>        <span class="operator">|</span> <span class="number">75</span>        <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> <span class="number">78</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">0.42105263157894735</span>  <span class="operator">|</span> <span class="number">0.47368421052631576</span>   <span class="operator">|</span> <span class="number">0.0</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">16</span>  <span class="operator">|</span> <span class="number">221</span>        <span class="operator">|</span> <span class="number">77</span>        <span class="operator">|</span> <span class="number">99</span>    <span class="operator">|</span> <span class="number">61</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">1.0</span>                  <span class="operator">|</span> <span class="number">0.05263157894736842</span>   <span class="operator">|</span> <span class="number">0.25</span>                         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">18</span>  <span class="operator">|</span> <span class="number">223</span>        <span class="operator">|</span> <span class="number">79</span>        <span class="operator">|</span> <span class="number">74</span>    <span class="operator">|</span> <span class="number">96</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">0.10526315789473684</span>  <span class="operator">|</span> <span class="number">0.8947368421052632</span>    <span class="operator">|</span> <span class="number">0.5</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">17</span>  <span class="operator">|</span> <span class="number">222</span>        <span class="operator">|</span> <span class="number">80</span>        <span class="operator">|</span> <span class="number">78</span>    <span class="operator">|</span> <span class="number">96</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">0.3157894736842105</span>   <span class="operator">|</span> <span class="number">0.8947368421052632</span>    <span class="operator">|</span> <span class="number">0.75</span>                         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">20</span>  <span class="operator">|</span> <span class="number">225</span>        <span class="operator">|</span> <span class="number">82</span>        <span class="operator">|</span> <span class="number">85</span>    <span class="operator">|</span> <span class="number">63</span>       <span class="operator">|</span> class2   <span class="operator">|</span> department2   <span class="operator">|</span> <span class="number">0.631578947368421</span>    <span class="operator">|</span> <span class="number">0.15789473684210525</span>   <span class="operator">|</span> <span class="number">1.0</span>                          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+------------+-----------+-------+----------+----------+---------------+----------------------+-----------------------+------------------------------+</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h4 id="8-2-5-4-多维度分析"><a href="#8-2-5-4-多维度分析" class="headerlink" title="8.2.5.4 多维度分析"></a>8.2.5.4 多维度分析</h4><ol>
<li>GROUPING SETS<ul>
<li>作用：在一个GROUP BY查询中，根据不同的维度组合进行聚合，等价于将不同维度的GROUP BY结果集进行UNION ALL</li>
<li>示例  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">month</span>,</span><br><span class="line">       <span class="keyword">day</span>,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv</span><br><span class="line"><span class="keyword">FROM</span> visit_log</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>, <span class="keyword">day</span></span><br><span class="line">    <span class="keyword">GROUPING</span> SETS ( <span class="keyword">month</span>, <span class="keyword">day</span>);</span><br><span class="line">    </span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-------------+-----+</span></span><br><span class="line"><span class="operator">|</span>  <span class="keyword">month</span>   <span class="operator">|</span>     <span class="keyword">day</span>     <span class="operator">|</span> uv  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-------------+-----+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span><span class="number">-10</span>  <span class="operator">|</span> <span class="number">4</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span><span class="number">-12</span>  <span class="operator">|</span> <span class="number">1</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>  <span class="operator">|</span> <span class="number">3</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span>  <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span> <span class="number">5</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span> <span class="number">6</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-------------+-----+</span></span><br></pre></td></tr></table></figure></li>
<li>分析  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 等价于</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">month</span>,<span class="keyword">NULL</span> <span class="keyword">as</span> <span class="keyword">day</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv <span class="keyword">FROM</span> test2 <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span> </span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">NULL</span> <span class="keyword">as</span> <span class="keyword">month</span>,<span class="keyword">day</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv <span class="keyword">FROM</span> test2 <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">day</span>;</span><br></pre></td></tr></table></figure></li>
<li>升级版 GROUPING__ID，表示结果属于哪一个分组集合。（<font color ='red' >GROUPING__ID</font>两个下划线__）  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    <span class="keyword">day</span>,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,</span><br><span class="line">    GROUPING__ID</span><br><span class="line"><span class="keyword">FROM</span> visit_log</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>,<span class="keyword">day</span></span><br><span class="line">    <span class="keyword">GROUPING</span> SETS (<span class="keyword">month</span>,<span class="keyword">day</span>,(<span class="keyword">month</span>,<span class="keyword">day</span>))</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> GROUPING__ID;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-------------+-----+---------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="keyword">month</span>   <span class="operator">|</span>     <span class="keyword">day</span>     <span class="operator">|</span> uv  <span class="operator">|</span> grouping__id  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-------------+-----+---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span><span class="number">-10</span>  <span class="operator">|</span> <span class="number">4</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>  <span class="operator">|</span> <span class="number">3</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span><span class="number">-12</span>  <span class="operator">|</span> <span class="number">1</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span>  <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span> <span class="number">5</span>   <span class="operator">|</span> <span class="number">1</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span> <span class="number">6</span>   <span class="operator">|</span> <span class="number">1</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">2</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">2</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>  <span class="operator">|</span> <span class="number">3</span>   <span class="operator">|</span> <span class="number">2</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">2</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span><span class="number">-12</span>  <span class="operator">|</span> <span class="number">1</span>   <span class="operator">|</span> <span class="number">2</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span><span class="number">-10</span>  <span class="operator">|</span> <span class="number">4</span>   <span class="operator">|</span> <span class="number">2</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-------------+-----+---------------+</span></span><br></pre></td></tr></table></figure></li>
<li>分析  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 等价</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">month</span>,<span class="keyword">NULL</span> <span class="keyword">as</span> <span class="keyword">day</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,<span class="number">1</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> test2 <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span> </span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">NULL</span> <span class="keyword">as</span> <span class="keyword">month</span>,<span class="keyword">day</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,<span class="number">2</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> test2 <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">day</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">month</span>,<span class="keyword">day</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,<span class="number">3</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> test2 <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>,<span class="keyword">day</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>CUBE<ul>
<li>作用：根据GROUP BY的维度的所有组合进行聚合。</li>
<li>示例  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    <span class="keyword">day</span>,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,</span><br><span class="line">    GROUPING__ID</span><br><span class="line"><span class="keyword">FROM</span> visit_log</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>,<span class="keyword">day</span></span><br><span class="line">    <span class="keyword">WITH</span> <span class="keyword">CUBE</span></span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> GROUPING__ID;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-------------+-----+---------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="keyword">month</span>   <span class="operator">|</span>     <span class="keyword">day</span>     <span class="operator">|</span> uv  <span class="operator">|</span> grouping__id  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-------------+-----+---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span><span class="number">-10</span>  <span class="operator">|</span> <span class="number">4</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>  <span class="operator">|</span> <span class="number">3</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span><span class="number">-12</span>  <span class="operator">|</span> <span class="number">1</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span>  <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span> <span class="number">5</span>   <span class="operator">|</span> <span class="number">1</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span> <span class="number">6</span>   <span class="operator">|</span> <span class="number">1</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">2</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">2</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>  <span class="operator">|</span> <span class="number">3</span>   <span class="operator">|</span> <span class="number">2</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">2</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span><span class="number">-12</span>  <span class="operator">|</span> <span class="number">1</span>   <span class="operator">|</span> <span class="number">2</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span><span class="number">-10</span>  <span class="operator">|</span> <span class="number">4</span>   <span class="operator">|</span> <span class="number">2</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span> <span class="number">7</span>   <span class="operator">|</span> <span class="number">3</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-------------+-----+---------------+</span></span><br></pre></td></tr></table></figure></li>
<li>解析  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">等价于</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">NULL</span> <span class="keyword">as</span> <span class="keyword">month</span>,<span class="keyword">NULL</span> <span class="keyword">as</span> <span class="keyword">day</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,<span class="number">0</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> test2</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">month</span>,<span class="keyword">NULL</span> <span class="keyword">as</span> <span class="keyword">day</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,<span class="number">1</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> test2 <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span> </span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">NULL</span> <span class="keyword">as</span> <span class="keyword">month</span>,<span class="keyword">day</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,<span class="number">2</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> test2 <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">day</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">month</span>,<span class="keyword">day</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,<span class="number">3</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> test2 <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>,<span class="keyword">day</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>ROLLUP<ul>
<li>作用：是CUBE的子集，以最左侧的维度为主，从该维度进行层级聚合。</li>
<li>比如，以month维度进行层级聚合：实现的上钻过程：月天的UV-&gt;月的UV-&gt;总UV  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    <span class="keyword">day</span>,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,</span><br><span class="line">    GROUPING__ID</span><br><span class="line"><span class="keyword">FROM</span> visit_log</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>,<span class="keyword">day</span></span><br><span class="line">    <span class="keyword">WITH</span> <span class="keyword">ROLLUP</span></span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> GROUPING__ID;</span><br><span class="line">    </span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-------------+-----+---------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="keyword">month</span>   <span class="operator">|</span>     <span class="keyword">day</span>     <span class="operator">|</span> uv  <span class="operator">|</span> grouping__id  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-------------+-----+---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>  <span class="operator">|</span> <span class="number">3</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span><span class="number">-12</span>  <span class="operator">|</span> <span class="number">1</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span><span class="number">-10</span>  <span class="operator">|</span> <span class="number">4</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span> <span class="number">6</span>   <span class="operator">|</span> <span class="number">1</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span>  <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span> <span class="number">5</span>   <span class="operator">|</span> <span class="number">1</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span> <span class="number">7</span>   <span class="operator">|</span> <span class="number">3</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+-------------+-----+---------------+</span></span><br></pre></td></tr></table></figure></li>
<li>如果把month和day调换顺序，则以day维度进行层级聚合：实现的上钻过程：天月的UV-&gt;天的UV-&gt;总UV  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">day</span>,</span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,</span><br><span class="line">    GROUPING__ID</span><br><span class="line"><span class="keyword">FROM</span> visit_log</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">day</span>,<span class="keyword">month</span></span><br><span class="line">    <span class="keyword">WITH</span> <span class="keyword">ROLLUP</span></span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> GROUPING__ID;</span><br><span class="line">    </span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+-----+---------------+</span></span><br><span class="line"><span class="operator">|</span>     <span class="keyword">day</span>     <span class="operator">|</span>  <span class="keyword">month</span>   <span class="operator">|</span> uv  <span class="operator">|</span> grouping__id  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+-----+---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">3</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span><span class="number">-12</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span>  <span class="operator">|</span> <span class="number">1</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span><span class="number">-10</span>  <span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span>  <span class="operator">|</span> <span class="number">4</span>   <span class="operator">|</span> <span class="number">0</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>  <span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">1</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>  <span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">1</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span><span class="number">-10</span>  <span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">4</span>   <span class="operator">|</span> <span class="number">1</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>  <span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> <span class="number">1</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-03</span><span class="number">-12</span>  <span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">1</span>   <span class="operator">|</span> <span class="number">1</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>  <span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">3</span>   <span class="operator">|</span> <span class="number">1</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>        <span class="operator">|</span> <span class="keyword">NULL</span>     <span class="operator">|</span> <span class="number">7</span>   <span class="operator">|</span> <span class="number">3</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+----------+-----+---------------+</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h4 id="8-2-5-5-开窗函数练习"><a href="#8-2-5-5-开窗函数练习" class="headerlink" title="8.2.5.5 开窗函数练习"></a>8.2.5.5 开窗函数练习</h4><h5 id="8-2-5-5-1-聚合开窗练习"><a href="#8-2-5-5-1-聚合开窗练习" class="headerlink" title="8.2.5.5.1 聚合开窗练习"></a>8.2.5.5.1 聚合开窗练习</h5><ol>
<li>建表导入数据 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> business <span class="keyword">as</span> </span><br><span class="line"><span class="keyword">select</span> stack(<span class="number">14</span>,</span><br><span class="line">    <span class="string">&#x27;jack&#x27;</span>,<span class="string">&#x27;2017-01-01&#x27;</span>,<span class="string">&#x27;10&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;tony&#x27;</span>,<span class="string">&#x27;2017-01-02&#x27;</span>,<span class="string">&#x27;15&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;jack&#x27;</span>,<span class="string">&#x27;2017-02-03&#x27;</span>,<span class="string">&#x27;23&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;tony&#x27;</span>,<span class="string">&#x27;2017-01-04&#x27;</span>,<span class="string">&#x27;29&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;jack&#x27;</span>,<span class="string">&#x27;2017-01-05&#x27;</span>,<span class="string">&#x27;46&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;jack&#x27;</span>,<span class="string">&#x27;2017-04-06&#x27;</span>,<span class="string">&#x27;42&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;tony&#x27;</span>,<span class="string">&#x27;2017-01-07&#x27;</span>,<span class="string">&#x27;50&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;jack&#x27;</span>,<span class="string">&#x27;2017-01-08&#x27;</span>,<span class="string">&#x27;55&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;mart&#x27;</span>,<span class="string">&#x27;2017-04-08&#x27;</span>,<span class="string">&#x27;62&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;mart&#x27;</span>,<span class="string">&#x27;2017-04-09&#x27;</span>,<span class="string">&#x27;68&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;neil&#x27;</span>,<span class="string">&#x27;2017-05-10&#x27;</span>,<span class="string">&#x27;12&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;mart&#x27;</span>,<span class="string">&#x27;2017-04-11&#x27;</span>,<span class="string">&#x27;75&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;neil&#x27;</span>,<span class="string">&#x27;2017-06-12&#x27;</span>,<span class="string">&#x27;80&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;mart&#x27;</span>,<span class="string">&#x27;2017-04-13&#x27;</span>,<span class="string">&#x27;94&#x27;</span>)</span><br><span class="line"><span class="keyword">as</span> (name, orderdate, cost)</span><br></pre></td></tr></table></figure></li>
<li>需求一： 查询在2017年4月份购买过的顾客及总人数 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">       name,</span><br><span class="line">       <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">over</span> ()</span><br><span class="line"><span class="keyword">from</span> business</span><br><span class="line"><span class="keyword">where</span> substr(orderdate, <span class="number">0</span>, <span class="number">7</span>) <span class="operator">=</span> <span class="string">&#x27;2017-04&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> name;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span> count_window_0  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> mart  <span class="operator">|</span> <span class="number">2</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">2</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-----------------+</span></span><br></pre></td></tr></table></figure></li>
<li>需求二：查询顾客的购买明细及月购买总额 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">       name,</span><br><span class="line">       cost,</span><br><span class="line">       orderdate,</span><br><span class="line">       substr(orderdate, <span class="number">0</span>, <span class="number">7</span>),</span><br><span class="line">       <span class="built_in">sum</span>(cost) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> substr(orderdate, <span class="number">0</span>, <span class="number">7</span>))</span><br><span class="line"><span class="keyword">from</span> business;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------------+----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span> cost  <span class="operator">|</span>  orderdate  <span class="operator">|</span>   _c3    <span class="operator">|</span> sum_window_0  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------------+----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">10</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">205.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">55</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-08</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">205.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> tony  <span class="operator">|</span> <span class="number">50</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-07</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">205.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">46</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-05</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">205.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> tony  <span class="operator">|</span> <span class="number">29</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">205.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> tony  <span class="operator">|</span> <span class="number">15</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-02</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">205.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">23</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-02</span><span class="number">-03</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-02</span>  <span class="operator">|</span> <span class="number">23.0</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mart  <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-13</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">341.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">42</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-06</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">341.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mart  <span class="operator">|</span> <span class="number">75</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-11</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">341.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mart  <span class="operator">|</span> <span class="number">68</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-09</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">341.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mart  <span class="operator">|</span> <span class="number">62</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-08</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">341.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> neil  <span class="operator">|</span> <span class="number">12</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-05</span><span class="number">-10</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-05</span>  <span class="operator">|</span> <span class="number">12.0</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> neil  <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-06</span><span class="number">-12</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-06</span>  <span class="operator">|</span> <span class="number">80.0</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------------+----------+---------------+</span></span><br></pre></td></tr></table></figure></li>
<li>需求三：查询每个顾客的购买明细及月购买总额 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">       name,</span><br><span class="line">       cost,</span><br><span class="line">       orderdate,</span><br><span class="line">       substr(orderdate, <span class="number">0</span>, <span class="number">7</span>),</span><br><span class="line">       <span class="built_in">sum</span>(cost) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> substr(orderdate, <span class="number">0</span>, <span class="number">7</span>),name)</span><br><span class="line"><span class="keyword">from</span> business;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------------+----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span> cost  <span class="operator">|</span>  orderdate  <span class="operator">|</span>   _c3    <span class="operator">|</span> sum_window_0  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------------+----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">55</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-08</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">111.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">46</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-05</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">111.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">10</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">111.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> tony  <span class="operator">|</span> <span class="number">50</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-07</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">94.0</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> tony  <span class="operator">|</span> <span class="number">29</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">94.0</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> tony  <span class="operator">|</span> <span class="number">15</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-02</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">94.0</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">23</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-02</span><span class="number">-03</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-02</span>  <span class="operator">|</span> <span class="number">23.0</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">42</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-06</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">42.0</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mart  <span class="operator">|</span> <span class="number">75</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-11</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">299.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mart  <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-13</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">299.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mart  <span class="operator">|</span> <span class="number">68</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-09</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">299.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mart  <span class="operator">|</span> <span class="number">62</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-08</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">299.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> neil  <span class="operator">|</span> <span class="number">12</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-05</span><span class="number">-10</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-05</span>  <span class="operator">|</span> <span class="number">12.0</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> neil  <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-06</span><span class="number">-12</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-06</span>  <span class="operator">|</span> <span class="number">80.0</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------------+----------+---------------+</span></span><br></pre></td></tr></table></figure></li>
<li>需求四：查询每个顾客的购买明细及月购买总额, 将每个顾客的cost按照日期进行累加 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">       name,</span><br><span class="line">       cost,</span><br><span class="line">       orderdate,</span><br><span class="line">       substr(orderdate, <span class="number">0</span>, <span class="number">7</span>),</span><br><span class="line">       <span class="built_in">sum</span>(cost) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> name <span class="keyword">order</span> <span class="keyword">by</span> orderdate),</span><br><span class="line">       <span class="built_in">sum</span>(cost) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> substr(orderdate, <span class="number">0</span>, <span class="number">7</span>),name)</span><br><span class="line"><span class="keyword">from</span> business</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> name,orderdate;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------------+----------+--------+---------------+</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span> cost  <span class="operator">|</span>  orderdate  <span class="operator">|</span>   _c3    <span class="operator">|</span>  _c4   <span class="operator">|</span> sum_window_1  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------------+----------+--------+---------------+</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">10</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">10.0</span>   <span class="operator">|</span> <span class="number">111.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">46</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-05</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">56.0</span>   <span class="operator">|</span> <span class="number">111.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">55</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-08</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">111.0</span>  <span class="operator">|</span> <span class="number">111.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">23</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-02</span><span class="number">-03</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-02</span>  <span class="operator">|</span> <span class="number">134.0</span>  <span class="operator">|</span> <span class="number">23.0</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">42</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-06</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">176.0</span>  <span class="operator">|</span> <span class="number">42.0</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mart  <span class="operator">|</span> <span class="number">62</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-08</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">62.0</span>   <span class="operator">|</span> <span class="number">299.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mart  <span class="operator">|</span> <span class="number">68</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-09</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">130.0</span>  <span class="operator">|</span> <span class="number">299.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mart  <span class="operator">|</span> <span class="number">75</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-11</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">205.0</span>  <span class="operator">|</span> <span class="number">299.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mart  <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-13</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">299.0</span>  <span class="operator">|</span> <span class="number">299.0</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> neil  <span class="operator">|</span> <span class="number">12</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-05</span><span class="number">-10</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-05</span>  <span class="operator">|</span> <span class="number">12.0</span>   <span class="operator">|</span> <span class="number">12.0</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> neil  <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-06</span><span class="number">-12</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-06</span>  <span class="operator">|</span> <span class="number">92.0</span>   <span class="operator">|</span> <span class="number">80.0</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> tony  <span class="operator">|</span> <span class="number">15</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-02</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">15.0</span>   <span class="operator">|</span> <span class="number">94.0</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> tony  <span class="operator">|</span> <span class="number">29</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">44.0</span>   <span class="operator">|</span> <span class="number">94.0</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> tony  <span class="operator">|</span> <span class="number">50</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-07</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">94.0</span>   <span class="operator">|</span> <span class="number">94.0</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------------+----------+--------+---------------+</span></span><br></pre></td></tr></table></figure></li>
<li>需求五：查询每个顾客上次的购买时间以及下一次的购买时间 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">       name,</span><br><span class="line">       cost,</span><br><span class="line">       orderdate,</span><br><span class="line">       <span class="built_in">lag</span>(orderdate, <span class="number">1</span>, &quot;first&quot;) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> name <span class="keyword">order</span> <span class="keyword">by</span> orderdate),</span><br><span class="line">       <span class="built_in">lead</span>(orderdate, <span class="number">1</span>, &quot;last&quot;) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> name <span class="keyword">order</span> <span class="keyword">by</span> orderdate)</span><br><span class="line"><span class="keyword">from</span> business</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> name, orderdate;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------------+---------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span> cost  <span class="operator">|</span>  orderdate  <span class="operator">|</span> lag_window_0  <span class="operator">|</span> lead_window_1  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------------+---------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">10</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-01</span>  <span class="operator">|</span> <span class="keyword">first</span>         <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-05</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">46</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-05</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-01</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-08</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">55</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-08</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-05</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-02</span><span class="number">-03</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">23</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-02</span><span class="number">-03</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-08</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-06</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jack  <span class="operator">|</span> <span class="number">42</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-06</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-02</span><span class="number">-03</span>    <span class="operator">|</span> <span class="keyword">last</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mart  <span class="operator">|</span> <span class="number">62</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-08</span>  <span class="operator">|</span> <span class="keyword">first</span>         <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-09</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mart  <span class="operator">|</span> <span class="number">68</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-09</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-08</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-11</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mart  <span class="operator">|</span> <span class="number">75</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-11</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-09</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-13</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mart  <span class="operator">|</span> <span class="number">94</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-13</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-04</span><span class="number">-11</span>    <span class="operator">|</span> <span class="keyword">last</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> neil  <span class="operator">|</span> <span class="number">12</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-05</span><span class="number">-10</span>  <span class="operator">|</span> <span class="keyword">first</span>         <span class="operator">|</span> <span class="number">2017</span><span class="number">-06</span><span class="number">-12</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> neil  <span class="operator">|</span> <span class="number">80</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-06</span><span class="number">-12</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-05</span><span class="number">-10</span>    <span class="operator">|</span> <span class="keyword">last</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> tony  <span class="operator">|</span> <span class="number">15</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-02</span>  <span class="operator">|</span> <span class="keyword">first</span>         <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-04</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> tony  <span class="operator">|</span> <span class="number">29</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-04</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-02</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-07</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> tony  <span class="operator">|</span> <span class="number">50</span>    <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-07</span>  <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-04</span>    <span class="operator">|</span> <span class="keyword">last</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+-------------+---------------+----------------+</span></span><br></pre></td></tr></table></figure></li>
<li>需求六：查询前20%时间的订单信息 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">         <span class="keyword">select</span> name,</span><br><span class="line">                cost,</span><br><span class="line">                orderdate,</span><br><span class="line">                <span class="built_in">ntile</span>(<span class="number">5</span>) <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> orderdate) num</span><br><span class="line">         <span class="keyword">from</span> business</span><br><span class="line">     ) t1</span><br><span class="line"><span class="keyword">where</span> t1.num <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> name, orderdate;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+---------------+---------+</span></span><br><span class="line"><span class="operator">|</span> t1.name  <span class="operator">|</span> t1.cost  <span class="operator">|</span> t1.orderdate  <span class="operator">|</span> t1.num  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+---------------+---------+</span></span><br><span class="line"><span class="operator">|</span> jack     <span class="operator">|</span> <span class="number">10</span>       <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-01</span>    <span class="operator">|</span> <span class="number">1</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> tony     <span class="operator">|</span> <span class="number">15</span>       <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-02</span>    <span class="operator">|</span> <span class="number">1</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> tony     <span class="operator">|</span> <span class="number">29</span>       <span class="operator">|</span> <span class="number">2017</span><span class="number">-01</span><span class="number">-04</span>    <span class="operator">|</span> <span class="number">1</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+----------+---------------+---------+</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="8-2-5-5-1-排序开窗练习"><a href="#8-2-5-5-1-排序开窗练习" class="headerlink" title="8.2.5.5.1 排序开窗练习"></a>8.2.5.5.1 排序开窗练习</h5><ol>
<li>建表导数据 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> score <span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> stack(<span class="number">12</span>,</span><br><span class="line"> &quot;孙悟空&quot;, &quot;语文&quot;, &quot;87&quot;,</span><br><span class="line"> &quot;孙悟空&quot;, &quot;数学&quot;, &quot;95&quot;,</span><br><span class="line"> &quot;孙悟空&quot;, &quot;英语&quot;, &quot;68&quot;,</span><br><span class="line"> &quot;大海&quot;, &quot;语文&quot;, &quot;94&quot;,</span><br><span class="line"> &quot;大海&quot;, &quot;数学&quot;, &quot;56&quot;,</span><br><span class="line"> &quot;大海&quot;, &quot;英语&quot;, &quot;84&quot;,</span><br><span class="line"> &quot;宋宋&quot;, &quot;语文&quot;, &quot;64&quot;,</span><br><span class="line"> &quot;宋宋&quot;, &quot;数学&quot;, &quot;86&quot;,</span><br><span class="line"> &quot;宋宋&quot;, &quot;英语&quot;, &quot;84&quot;,</span><br><span class="line"> &quot;婷婷&quot;, &quot;语文&quot;, &quot;65&quot;,</span><br><span class="line"> &quot;婷婷&quot;, &quot;数学&quot;, &quot;85&quot;,</span><br><span class="line"> &quot;婷婷&quot;, &quot;英语&quot;, &quot;78&quot;)</span><br><span class="line"><span class="keyword">as</span> (name, subject, score);</span><br></pre></td></tr></table></figure></li>
<li>根据学科进行分区操作 并且按照成绩字段进行倒序，最后利用排名函数 完成排名  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name,</span><br><span class="line">       subject,</span><br><span class="line">       score,</span><br><span class="line">       <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> subject <span class="keyword">order</span> <span class="keyword">by</span> score <span class="keyword">desc</span> ),</span><br><span class="line">       <span class="built_in">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> subject <span class="keyword">order</span> <span class="keyword">by</span> score <span class="keyword">desc</span> ),</span><br><span class="line">       <span class="built_in">row_number</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> subject <span class="keyword">order</span> <span class="keyword">by</span> score <span class="keyword">desc</span> )</span><br><span class="line"><span class="keyword">from</span> score;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+----------+--------+----------------+----------------------+----------------------+</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span> subject  <span class="operator">|</span> score  <span class="operator">|</span> rank_window_0  <span class="operator">|</span> dense_rank_window_1  <span class="operator">|</span> row_number_window_2  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+----------+--------+----------------+----------------------+----------------------+</span></span><br><span class="line"><span class="operator">|</span> 孙悟空   <span class="operator">|</span> 数学       <span class="operator">|</span> <span class="number">95</span>     <span class="operator">|</span> <span class="number">1</span>              <span class="operator">|</span> <span class="number">1</span>                    <span class="operator">|</span> <span class="number">1</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 宋宋    <span class="operator">|</span> 数学       <span class="operator">|</span> <span class="number">86</span>     <span class="operator">|</span> <span class="number">2</span>              <span class="operator">|</span> <span class="number">2</span>                    <span class="operator">|</span> <span class="number">2</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 婷婷    <span class="operator">|</span> 数学       <span class="operator">|</span> <span class="number">85</span>     <span class="operator">|</span> <span class="number">3</span>              <span class="operator">|</span> <span class="number">3</span>                    <span class="operator">|</span> <span class="number">3</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 大海    <span class="operator">|</span> 数学       <span class="operator">|</span> <span class="number">56</span>     <span class="operator">|</span> <span class="number">4</span>              <span class="operator">|</span> <span class="number">4</span>                    <span class="operator">|</span> <span class="number">4</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 宋宋    <span class="operator">|</span> 英语       <span class="operator">|</span> <span class="number">84</span>     <span class="operator">|</span> <span class="number">1</span>              <span class="operator">|</span> <span class="number">1</span>                    <span class="operator">|</span> <span class="number">1</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 大海    <span class="operator">|</span> 英语       <span class="operator">|</span> <span class="number">84</span>     <span class="operator">|</span> <span class="number">1</span>              <span class="operator">|</span> <span class="number">1</span>                    <span class="operator">|</span> <span class="number">2</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 婷婷    <span class="operator">|</span> 英语       <span class="operator">|</span> <span class="number">78</span>     <span class="operator">|</span> <span class="number">3</span>              <span class="operator">|</span> <span class="number">2</span>                    <span class="operator">|</span> <span class="number">3</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 孙悟空   <span class="operator">|</span> 英语       <span class="operator">|</span> <span class="number">68</span>     <span class="operator">|</span> <span class="number">4</span>              <span class="operator">|</span> <span class="number">3</span>                    <span class="operator">|</span> <span class="number">4</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 大海    <span class="operator">|</span> 语文       <span class="operator">|</span> <span class="number">94</span>     <span class="operator">|</span> <span class="number">1</span>              <span class="operator">|</span> <span class="number">1</span>                    <span class="operator">|</span> <span class="number">1</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 孙悟空   <span class="operator">|</span> 语文       <span class="operator">|</span> <span class="number">87</span>     <span class="operator">|</span> <span class="number">2</span>              <span class="operator">|</span> <span class="number">2</span>                    <span class="operator">|</span> <span class="number">2</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 婷婷    <span class="operator">|</span> 语文       <span class="operator">|</span> <span class="number">65</span>     <span class="operator">|</span> <span class="number">3</span>              <span class="operator">|</span> <span class="number">3</span>                    <span class="operator">|</span> <span class="number">3</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 宋宋    <span class="operator">|</span> 语文       <span class="operator">|</span> <span class="number">64</span>     <span class="operator">|</span> <span class="number">4</span>              <span class="operator">|</span> <span class="number">4</span>                    <span class="operator">|</span> <span class="number">4</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+----------+--------+----------------+----------------------+----------------------+</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="8-2-6-其他常用函数"><a href="#8-2-6-其他常用函数" class="headerlink" title="8.2.6 其他常用函数"></a>8.2.6 其他常用函数</h3><table>
<thead>
<tr>
<th>类别</th>
<th>函数</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>常用日期函数</td>
<td>unix_timestamp</td>
<td>返回当前或指定时间的时间戳</td>
<td>select unix_timestamp();select unix_timestamp(“2020-10-28”,’yyyy-MM-dd’);</td>
</tr>
<tr>
<td></td>
<td>from_unixtime</td>
<td>将时间戳转为日期格式</td>
<td>select from_unixtime(1603843200);</td>
</tr>
<tr>
<td></td>
<td>current_date</td>
<td>当前日期</td>
<td>select current_date;</td>
</tr>
<tr>
<td></td>
<td>current_timestamp</td>
<td>当前的日期加时间</td>
<td>select current_timestamp;</td>
</tr>
<tr>
<td></td>
<td>to_date</td>
<td>抽取日期部分</td>
<td>select to_date(‘2020-10-28 12:12:12’);</td>
</tr>
<tr>
<td></td>
<td>year</td>
<td>获取年</td>
<td>select year(‘2020-10-28 12:12:12’);</td>
</tr>
<tr>
<td></td>
<td>month</td>
<td>获取月</td>
<td>select month(‘2020-10-28 12:12:12’);</td>
</tr>
<tr>
<td></td>
<td>day</td>
<td>获取日</td>
<td>select day(‘2020-10-28 12:12:12’);</td>
</tr>
<tr>
<td></td>
<td>hour</td>
<td>获取时</td>
<td>select hour(‘2020-10-28 12:12:12’);</td>
</tr>
<tr>
<td></td>
<td>minute</td>
<td>获取分</td>
<td>select minute(‘2020-10-28 12:12:12’);</td>
</tr>
<tr>
<td></td>
<td>second</td>
<td>获取秒</td>
<td>select second(‘2020-10-28 12:12:12’);</td>
</tr>
<tr>
<td></td>
<td>weekofyear</td>
<td>当前时间是一年中的第几周</td>
<td>select weekofyear(‘2020-10-28 12:12:12’);</td>
</tr>
<tr>
<td></td>
<td>dayofmonth</td>
<td>当前时间是一个月中的第几天</td>
<td>select dayofmonth(‘2020-10-28 12:12:12’);</td>
</tr>
<tr>
<td></td>
<td>months_between</td>
<td>两个日期间的月份</td>
<td>select months_between(‘2020-04-01’,’2020-10-28’);</td>
</tr>
<tr>
<td></td>
<td>add_months</td>
<td>日期加减月</td>
<td>select add_months(‘2020-10-28’,-3);</td>
</tr>
<tr>
<td></td>
<td>datediff</td>
<td>两个日期相差的天数</td>
<td>select datediff(‘2020-11-04’,’2020-10-28’);</td>
</tr>
<tr>
<td></td>
<td>date_add</td>
<td>日期加天数</td>
<td>select date_add(‘2020-10-28’,4);</td>
</tr>
<tr>
<td></td>
<td>date_sub</td>
<td>日期减天数</td>
<td>select date_sub(‘2020-10-28’,-4);</td>
</tr>
<tr>
<td></td>
<td>last_day</td>
<td>日期的当月的最后一天</td>
<td>select last_day(‘2020-02-30’);</td>
</tr>
<tr>
<td></td>
<td>date_format</td>
<td>格式化日期</td>
<td>select date_format(‘2020-10-28 12:12:12’,’yyyy/MM/dd HH:mm:ss’);</td>
</tr>
<tr>
<td>常用取整函数</td>
<td>round</td>
<td>四舍五入</td>
<td>select round(3.14);select round(3.54);</td>
</tr>
<tr>
<td></td>
<td>ceil</td>
<td>向上取整</td>
<td>select ceil(3.14);select ceil(3.54);</td>
</tr>
<tr>
<td></td>
<td>floor</td>
<td>向下取整</td>
<td>select floor(3.14);select floor(3.54);</td>
</tr>
<tr>
<td>常用字符串操作函数</td>
<td>upper</td>
<td>转大写</td>
<td>select upper(‘low’);</td>
</tr>
<tr>
<td></td>
<td>lower</td>
<td>转小写</td>
<td>select lower(‘low’);</td>
</tr>
<tr>
<td></td>
<td>length</td>
<td>长度</td>
<td>select length(“atguigu”);</td>
</tr>
<tr>
<td></td>
<td>trim</td>
<td>前后去空格</td>
<td>select trim(“ atguigu “);</td>
</tr>
<tr>
<td></td>
<td>lpad</td>
<td>向左补齐，到指定长度</td>
<td>select lpad(‘atguigu’,9,’g’);</td>
</tr>
<tr>
<td></td>
<td>rpad</td>
<td>向右补齐，到指定长度</td>
<td>select rpad(‘atguigu’,9,’g’);</td>
</tr>
<tr>
<td></td>
<td>regexp_replace</td>
<td>使用正则表达式匹配目标字符串，匹配成功后替换！</td>
<td>SELECT regexp_replace(‘2020/10/25’, ‘/‘, ‘-‘);</td>
</tr>
<tr>
<td>集合操作</td>
<td>size</td>
<td>集合中元素的个数</td>
<td>select size(friends) from person_info;</td>
</tr>
<tr>
<td></td>
<td>map_keys</td>
<td>返回map中的key</td>
<td>select map_keys(children) from person_info;</td>
</tr>
<tr>
<td></td>
<td>map_value</td>
<td>返回map中的value</td>
<td>select map_values(children) from person_info;</td>
</tr>
<tr>
<td></td>
<td>array_contains</td>
<td>判断array中是否包含某个元素</td>
<td>select array_contains(friends,’bingbing’) from person_info;</td>
</tr>
<tr>
<td></td>
<td>sort_array</td>
<td>将array中的元素排序</td>
<td>select sort_array(friends) from person_info;</td>
</tr>
<tr>
<td></td>
<td>grouping_set</td>
<td>多维分析</td>
<td></td>
</tr>
</tbody></table>
<h2 id="8-3-自定义函数"><a href="#8-3-自定义函数" class="headerlink" title="8.3 自定义函数"></a>8.3 自定义函数</h2><ol>
<li>Hive 自带了一些函数，比如：max/min等，但是数量有限，自己可以通过自定义UDF来方便的扩展。</li>
<li>当Hive提供的内置函数无法满足你的业务处理需要时，此时就可以考虑使用用户自定义函数（UDF：user-defined function）。</li>
<li>根据用户自定义函数类别分为以下三种：<ul>
<li>UDF（User-Defined-Function）：一进一出</li>
<li>UDAF（User-Defined Aggregation Function）：聚集函数，多进一出，类似于：count/max/min</li>
<li>UDTF（User-Defined Table-Generating Functions）一进多出，如lateral view explode()</li>
</ul>
</li>
<li>官方文档地址<ul>
<li><a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/Hive/HivePlugins">https://cwiki.apache.org/confluence/display/Hive/HivePlugins</a></li>
</ul>
</li>
<li>编程步骤：<ol>
<li>继承Hive提供的类<ul>
<li>org.apache.hadoop.hive.ql.udf.generic.GenericUDF  </li>
<li>org.apache.hadoop.hive.ql.udf.generic.GenericUDTF;</li>
</ul>
</li>
<li>实现类中的抽象方法</li>
<li>在hive的命令行窗口创建函数 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 添加jar</span></span><br><span class="line"><span class="keyword">add</span> jar linux_jar_path</span><br><span class="line"><span class="comment">-- 创建function</span></span><br><span class="line"><span class="keyword">create</span> [temporary] <span class="keyword">function</span> [dbname.]function_name <span class="keyword">AS</span> class_name;</span><br></pre></td></tr></table></figure></li>
<li>在hive的命令行窗口删除函数 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> [temporary] <span class="keyword">function</span> [if <span class="keyword">exists</span>] [dbname.]function_name;</span><br></pre></td></tr></table></figure>
<h2 id="8-4-自定义UDF函数"><a href="#8-4-自定义UDF函数" class="headerlink" title="8.4 自定义UDF函数"></a>8.4 自定义UDF函数</h2></li>
</ol>
</li>
<li>创建函数类</li>
<li>继承org.apache.hadoop.hive.ql.udf.generic.GenericUDF</li>
<li>重写initialize，evaluate，getDisplayString</li>
<li>执行hive add jar</li>
<li>创建函数</li>
<li>使用函数</li>
<li>示例 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一进一出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UDFTest</span> <span class="keyword">extends</span> <span class="title">GenericUDF</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectInspectors</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> UDFArgumentException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ObjectInspector <span class="title">initialize</span><span class="params">(ObjectInspector[] objectInspectors)</span> <span class="keyword">throws</span> UDFArgumentException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (objectInspectors == <span class="keyword">null</span> || objectInspectors.length != <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UDFArgumentLengthException(<span class="string">&quot;参数数量有误&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ObjectInspector objectInspector = objectInspectors[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (objectInspector.getCategory() != ObjectInspector.Category.PRIMITIVE) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UDFArgumentTypeException(<span class="number">0</span>, <span class="string">&quot;参数类型错误&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> PrimitiveObjectInspectorFactory.javaIntObjectInspector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 函数体的核心逻辑</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> deferredObjects</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> HiveException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">evaluate</span><span class="params">(DeferredObject[] deferredObjects)</span> <span class="keyword">throws</span> HiveException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (deferredObjects == <span class="keyword">null</span> || deferredObjects.length != <span class="number">1</span> || deferredObjects[<span class="number">0</span>].get() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> deferredObjects[<span class="number">0</span>].get().toString().length();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 针对当前函数的说明</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> strings</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDisplayString</span><span class="params">(String[] strings)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;针对当前函数的说明&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">add</span> jar <span class="operator">/</span>home<span class="operator">/</span>atguigu<span class="operator">/</span>hive<span class="operator">/</span>custom_function<span class="operator">/</span>sgg<span class="operator">-</span>hive<span class="operator">-</span>custom<span class="operator">-</span><span class="keyword">function</span><span class="number">-0.0</span><span class="number">.1</span><span class="operator">-</span>SNAPSHOT.jar;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.037</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">create</span> temporary <span class="keyword">function</span> str_split <span class="keyword">as</span> <span class="string">&#x27;tech.anzhen.sgg.hive.custom.function.udf.UDTFTest&#x27;</span>;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.028</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> str_split(<span class="string">&#x27;a,d,d,w&#x27;</span>,<span class="string">&#x27;,&#x27;</span>,<span class="string">&#x27;12&#x27;</span>);</span><br><span class="line">Error: Error while compiling statement: FAILED: UDFArgumentLengthException 参数数量有误 (state<span class="operator">=</span><span class="number">42000</span>,code<span class="operator">=</span><span class="number">40000</span>)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> str_split(<span class="string">&#x27;a,d,d,w&#x27;</span>,<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> word  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> a     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> d     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> d     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> w     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br></pre></td></tr></table></figure>
<h2 id="8-5-自定义UDTF函数"><a href="#8-5-自定义UDTF函数" class="headerlink" title="8.5 自定义UDTF函数"></a>8.5 自定义UDTF函数</h2></li>
<li>创建函数类</li>
<li>继承org.apache.hadoop.hive.ql.udf.generic.GenericUDTF</li>
<li>重写initialize，process，close</li>
<li>执行hive add jar</li>
<li>创建函数</li>
<li>使用函数</li>
<li>示例 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UDTFMultiColumnTest</span> <span class="keyword">extends</span> <span class="title">GenericUDTF</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> StructObjectInspector <span class="title">initialize</span><span class="params">(StructObjectInspector argOIs)</span> <span class="keyword">throws</span> UDFArgumentException </span>&#123;</span><br><span class="line">        <span class="comment">//参数数量</span></span><br><span class="line">        List&lt;? extends StructField&gt; allStructFieldRefs = argOIs.getAllStructFieldRefs();</span><br><span class="line">        <span class="keyword">if</span> (allStructFieldRefs == <span class="keyword">null</span> || allStructFieldRefs.size() != <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UDFArgumentLengthException(<span class="string">&quot;参数数量有误&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//参数数据类型</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; allStructFieldRefs.size(); i++) &#123;</span><br><span class="line">            StructField structField = allStructFieldRefs.get(i);</span><br><span class="line">            <span class="keyword">if</span> (structField.getFieldObjectInspector().getCategory() != ObjectInspector.Category.PRIMITIVE) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> UDFArgumentTypeException(i, <span class="string">&quot;参数类型有误&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ArrayList&lt;String&gt; fieldNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        fieldNames.add(<span class="string">&quot;word1&quot;</span>);</span><br><span class="line">        fieldNames.add(<span class="string">&quot;word2&quot;</span>);</span><br><span class="line">        ArrayList&lt;ObjectInspector&gt; fieldOIs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        fieldOIs.add(PrimitiveObjectInspectorFactory.javaStringObjectInspector);</span><br><span class="line">        fieldOIs.add(PrimitiveObjectInspectorFactory.javaStringObjectInspector);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ObjectInspectorFactory.getStandardStructObjectInspector(fieldNames,</span><br><span class="line">                fieldOIs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Object[] args)</span> <span class="keyword">throws</span> HiveException </span>&#123;</span><br><span class="line">        String str = args[<span class="number">0</span>].toString();</span><br><span class="line">        String split1 = args[<span class="number">1</span>].toString();</span><br><span class="line">        String split2 = args[<span class="number">2</span>].toString();</span><br><span class="line">        String[] split1Array = str.split(split1);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; split1Array.length; i++) &#123;</span><br><span class="line">            String split2Str = split1Array[i];</span><br><span class="line">            String[] split2Array = split2Str.split(split2);</span><br><span class="line">            forward(split2Array);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 收尾</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> HiveException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> HiveException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">add</span> jar <span class="operator">/</span>home<span class="operator">/</span>atguigu<span class="operator">/</span>hive<span class="operator">/</span>custom_function<span class="operator">/</span>sgg<span class="operator">-</span>hive<span class="operator">-</span>custom<span class="operator">-</span><span class="keyword">function</span><span class="number">-0.0</span><span class="number">.1</span><span class="operator">-</span>SNAPSHOT.jar;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.037</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">create</span> temporary <span class="keyword">function</span> str_splits <span class="keyword">as</span> <span class="string">&#x27;tech.anzhen.sgg.hive.custom.function.udf.UDTFMultiColumnTest&#x27;</span>;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.037</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> str_splits(<span class="string">&#x27;a,d,d,w&#x27;</span>,<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">Error: Error while compiling statement: FAILED: UDFArgumentLengthException 参数数量有误 (state<span class="operator">=</span><span class="number">42000</span>,code<span class="operator">=</span><span class="number">40000</span>)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> str_splits(<span class="string">&#x27;a-1,b-2,c-3&#x27;</span>,<span class="string">&#x27;,&#x27;</span>,<span class="string">&#x27;-&#x27;</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+--------+</span></span><br><span class="line"><span class="operator">|</span> word1  <span class="operator">|</span> word2  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+--------+</span></span><br><span class="line"><span class="operator">|</span> a      <span class="operator">|</span> <span class="number">1</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> b      <span class="operator">|</span> <span class="number">2</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> c      <span class="operator">|</span> <span class="number">3</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+--------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> selected (<span class="number">0.062</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="九、压缩和存储"><a href="#九、压缩和存储" class="headerlink" title="九、压缩和存储"></a>九、压缩和存储</h1><h2 id="9-1-Hadoop压缩配置"><a href="#9-1-Hadoop压缩配置" class="headerlink" title="9.1 Hadoop压缩配置"></a>9.1 Hadoop压缩配置</h2><h3 id="9-1-1-MR支持的压缩编码"><a href="#9-1-1-MR支持的压缩编码" class="headerlink" title="9.1.1 MR支持的压缩编码"></a>9.1.1 MR支持的压缩编码</h3><ul>
<li><p>MR支持的压缩编码</p>
<table>
<thead>
<tr>
<th>压缩格式</th>
<th>算法</th>
<th>文件扩展名</th>
<th>是否可切分</th>
</tr>
</thead>
<tbody><tr>
<td>DEFLATE</td>
<td>DEFLATE</td>
<td>.deflate</td>
<td>否</td>
</tr>
<tr>
<td>Gzip</td>
<td>DEFLATE</td>
<td>.gz</td>
<td>否</td>
</tr>
<tr>
<td>bzip2</td>
<td>bzip2</td>
<td>.bz2</td>
<td>是</td>
</tr>
<tr>
<td>LZO</td>
<td>LZO</td>
<td>.lzo</td>
<td>是</td>
</tr>
<tr>
<td>Snappy</td>
<td>Snappy</td>
<td>.snappy</td>
<td>否</td>
</tr>
</tbody></table>
</li>
<li><p>为了支持多种压缩/解压缩算法，Hadoop引入了编码/解码器，如下表所示：</p>
<table>
<thead>
<tr>
<th>压缩格式</th>
<th>对应的编码/解码器</th>
</tr>
</thead>
<tbody><tr>
<td>DEFLATE</td>
<td>org.apache.hadoop.io.compress.DefaultCodec</td>
</tr>
<tr>
<td>gzip</td>
<td>org.apache.hadoop.io.compress.GzipCodec</td>
</tr>
<tr>
<td>bzip2</td>
<td>org.apache.hadoop.io.compress.BZip2Codec</td>
</tr>
<tr>
<td>LZO</td>
<td>com.hadoop.compression.lzo.LzopCodec</td>
</tr>
<tr>
<td>Snappy</td>
<td>org.apache.hadoop.io.compress.SnappyCodec</td>
</tr>
</tbody></table>
</li>
<li><p>压缩性能的比较：</p>
<table>
<thead>
<tr>
<th>压缩算法</th>
<th>原始文件大小</th>
<th>压缩文件大小</th>
<th>压缩速度</th>
<th>解压速度</th>
</tr>
</thead>
<tbody><tr>
<td>gzip</td>
<td>8.3GB</td>
<td>1.8GB</td>
<td>17.5MB/s</td>
<td>58MB/s</td>
</tr>
<tr>
<td>bzip2</td>
<td>8.3GB</td>
<td>1.1GB</td>
<td>2.4MB/s</td>
<td>9.5MB/s</td>
</tr>
<tr>
<td>LZO</td>
<td>8.3GB</td>
<td>2.9GB</td>
<td>49.3MB/s</td>
<td>74.6MB/s</td>
</tr>
</tbody></table>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://google.github.io/snappy/">http://google.github.io/snappy/</a><br>On a single core of a Core i7 processor in 64-bit mode, Snappy compresses at about 250 MB/sec or more and decompresses at about 500 MB/sec or more.</p>
</blockquote>
</li>
</ul>
<h3 id="9-1-2-压缩参数配置"><a href="#9-1-2-压缩参数配置" class="headerlink" title="9.1.2 压缩参数配置"></a>9.1.2 压缩参数配置</h3><ul>
<li>要在Hadoop中启用压缩，可以配置如下参数（mapred-site.xml文件中）：<table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>阶段</th>
<th>建议</th>
</tr>
</thead>
<tbody><tr>
<td>io.compression.codecs（在core-site.xml中配置）</td>
<td>org.apache.hadoop.io.compress.DefaultCodec, org.apache.hadoop.io.compress.GzipCodec, org.apache.hadoop.io.compress.BZip2Codec,</td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.apache.hadoop.io.compress.Lz4Codec</td>
<td>输入压缩</td>
<td>Hadoop使用文件扩展名判断是否支持某种编解码器</td>
<td></td>
</tr>
<tr>
<td>mapreduce.map.output.compress</td>
<td>false</td>
<td>mapper输出</td>
<td>这个参数设为true启用压缩</td>
</tr>
<tr>
<td>mapreduce.map.output.compress.codec</td>
<td>org.apache.hadoop.io.compress.DefaultCodec</td>
<td>mapper输出</td>
<td>使用LZO、LZ4或snappy编解码器在此阶段压缩数据</td>
</tr>
<tr>
<td>mapreduce.output.fileoutputformat.compress</td>
<td>false</td>
<td>reducer输出</td>
<td>这个参数设为true启用压缩</td>
</tr>
<tr>
<td>mapreduce.output.fileoutputformat.compress.codec</td>
<td>org.apache.hadoop.io.compress. DefaultCodec</td>
<td>reducer输出</td>
<td>使用标准工具或者编解码器，如gzip和bzip2</td>
</tr>
<tr>
<td>mapreduce.output.fileoutputformat.compress.type</td>
<td>RECORD</td>
<td>reducer输出</td>
<td>SequenceFile输出使用的压缩类型：NONE和BLOCK</td>
</tr>
</tbody></table>
</li>
</ul>
<h2 id="9-2-开启Map输出阶段压缩"><a href="#9-2-开启Map输出阶段压缩" class="headerlink" title="9.2 开启Map输出阶段压缩"></a>9.2 开启Map输出阶段压缩</h2><p>开启map输出阶段压缩可以减少job中map和Reduce task间数据传输量。具体配置如下：</p>
<ol>
<li>开启hive中间传输数据压缩功能 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span><span class="keyword">set</span> hive.exec.compress.intermediate<span class="operator">=</span><span class="literal">true</span>;</span><br></pre></td></tr></table></figure></li>
<li>开启mapreduce中map输出压缩功能 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span><span class="keyword">set</span> mapreduce.map.output.compress<span class="operator">=</span><span class="literal">true</span>;</span><br></pre></td></tr></table></figure></li>
<li>设置mapreduce中map输出数据的压缩方式 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span><span class="keyword">set</span> mapreduce.map.output.compress.codec <span class="operator">=</span> org.apache.hadoop.io.compress.SnappyCodec;</span><br></pre></td></tr></table></figure></li>
<li>执行查询语句 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(ename) name <span class="keyword">from</span> emp;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="9-3-开启Reduce输出阶段压缩"><a href="#9-3-开启Reduce输出阶段压缩" class="headerlink" title="9.3 开启Reduce输出阶段压缩"></a>9.3 开启Reduce输出阶段压缩</h2><p>当Hive将输出写入到表中时，输出内容同样可以进行压缩。属性hive.exec.compress.output控制着这个功能。用户可能需要保持默认设置文件中的默认值false，这样默认的输出就是非压缩的纯文本文件了。用户可以通过在查询语句或执行脚本中设置这个值为true，来开启输出结果压缩功能。</p>
<ol>
<li>开启hive最终输出数据压缩功能 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span><span class="keyword">set</span> hive.exec.compress.output<span class="operator">=</span><span class="literal">true</span>;</span><br></pre></td></tr></table></figure></li>
<li>开启mapreduce最终输出数据压缩 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span><span class="keyword">set</span> mapreduce.output.fileoutputformat.compress<span class="operator">=</span><span class="literal">true</span>;</span><br></pre></td></tr></table></figure></li>
<li>设置mapreduce最终数据输出压缩方式 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">set</span> mapreduce.output.fileoutputformat.compress.codec <span class="operator">=</span> org.apache.hadoop.io.compress.SnappyCodec;</span><br></pre></td></tr></table></figure></li>
<li>设置mapreduce最终数据输出压缩为块压缩 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">set</span> mapreduce.output.fileoutputformat.compress.type<span class="operator">=</span>BLOCK;</span><br></pre></td></tr></table></figure></li>
<li>测试一下输出结果是否是压缩文件 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">insert</span> overwrite <span class="keyword">local</span> directory <span class="string">&#x27;/opt/module/hive-3.1.2/datas/distribute-result&#x27;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp distribute <span class="keyword">by</span> deptno sort <span class="keyword">by</span> empno <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="9-4-文件存储格式"><a href="#9-4-文件存储格式" class="headerlink" title="9.4 文件存储格式"></a>9.4 文件存储格式</h2><ul>
<li>建表语法中以下规则就是确定Hive的存储格式  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[STORED <span class="keyword">AS</span> file_format] </span><br></pre></td></tr></table></figure></li>
<li>Hive中的存储格式<ul>
<li>textfile   (默认格式) — 行存</li>
<li>SEQUENCEFILE  二进制的序列文件 — 行存</li>
<li>ORC (Hive中最常用的一种存储格式) — 列存</li>
<li>PARQUET (和ORC接近的一种存储格式，hive中支持比较早的一种存储格式)– 列存</li>
</ul>
</li>
</ul>
<h3 id="9-4-1-列式存储和行式存储"><a href="#9-4-1-列式存储和行式存储" class="headerlink" title="9.4.1 列式存储和行式存储"></a>9.4.1 列式存储和行式存储</h3><p><img src="https://anzhen-tech-imges.oss-cn-beijing.aliyuncs.com/2021/11/07/16355110552074.jpg?x-oss-process=image/auto-orient,1/quality,q_90/watermark,text_YW56aGVuLnRlY2g,size_40,x_10,y_10"><br>如图所示左边为逻辑表，右边第一个为行式存储，第二个为列式存储。</p>
<ol>
<li>行存储的特点: 查询满足条件的一整行数据的时候，列存储则需要去每个聚集的字段找到对应的每个列的值，行存储只需要找到其中一个值，其余的值都在相邻地方，所以此时行存储查询的速度更快。</li>
<li>列存储的特点: 因为每个字段的数据聚集存储，在查询只需要少数几个字段的时候，能大大减少读取的数据量；每个字段的数据类型一定是相同的，列式存储可以针对性的设计更好的设计压缩算法。</li>
</ol>
<ul>
<li>TEXTFILE和SEQUENCEFILE的存储格式都是基于行存储的；</li>
<li>ORC和PARQUET是基于列式存储的。</li>
</ul>
<h3 id="9-4-2-TextFile格式"><a href="#9-4-2-TextFile格式" class="headerlink" title="9.4.2 TextFile格式"></a>9.4.2 TextFile格式</h3><p>默认格式，数据不做压缩，磁盘开销大，数据解析开销大。可结合Gzip、Bzip2使用，但使用Gzip这种方式，hive不会对数据进行切分，从而无法对数据进行并行操作</p>
<h3 id="9-4-3-Orc格式"><a href="#9-4-3-Orc格式" class="headerlink" title="9.4.3 Orc格式"></a>9.4.3 Orc格式</h3><p><img src="https://anzhen-tech-imges.oss-cn-beijing.aliyuncs.com/2021/11/07/16355111657327.jpg?x-oss-process=image/auto-orient,1/quality,q_90/watermark,text_YW56aGVuLnRlY2g,size_40,x_10,y_10"></p>
<p>Orc (Optimized Row Columnar)是Hive 0.11版里引入的新的存储格式。<br>如图所示可以看到每个Orc文件由1个或多个stripe组成，每个stripe一般为HDFS的块大小，每一个stripe包含多条记录，这些记录按照列进行独立存储，对应到Parquet中的row group的概念。每个Stripe里有三部分组成，分别是Index Data，Row Data，Stripe Footer：</p>
<ol>
<li>Index Data：一个轻量级的index，默认是每隔1W行做一个索引。这里做的索引应该只是记录某行的各字段在Row Data中的offset。</li>
<li>Row Data：存的是具体的数据，先取部分行，然后对这些行按列进行存储。对每个列进行了编码，分成多个Stream来存储。</li>
<li>Stripe Footer：存的是各个Stream的类型，长度等信息。</li>
<li>每个文件有一个File Footer，这里面存的是每个Stripe的行数，每个Column的数据类型信息等；每个文件的尾部是一个PostScript，这里面记录了整个文件的压缩类型以及FileFooter的长度信息等。在读取文件时，会seek到文件尾部读PostScript，从里面解析到File Footer长度，再读FileFooter，从里面解析到各个Stripe信息，再读各个Stripe，即从后往前读。</li>
<li>以json方式查看orc文件 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive --orcfiledump -j -p /user/hive/warehouse/dim.db/dim_province/000000_0</span><br></pre></td></tr></table></figure>
<ul>
<li>文件示例：<a href="media/16346959668071/log_orc.json">log_orc.json</a><br>  <img src="https://anzhen-tech-imges.oss-cn-beijing.aliyuncs.com/2021/11/07/16356457996704.jpg?x-oss-process=image/auto-orient,1/quality,q_90/watermark,text_YW56aGVuLnRlY2g,size_40,x_10,y_10"><ul>
<li>schema: 为每一个字段做了编号，从1开始，编号为0的columnId中描述了整个表的字段定义。<br>  <img src="https://anzhen-tech-imges.oss-cn-beijing.aliyuncs.com/2021/11/07/16356459007816.jpg?x-oss-process=image/auto-orient,1/quality,q_90/watermark,text_YW56aGVuLnRlY2g,size_40,x_10,y_10"></li>
<li>stripeStatistics:是ORC文件中所有stripes的统计信息，其中有每个stripe中每个字段的min/max值，是否有空值等等<br>  <img src="https://anzhen-tech-imges.oss-cn-beijing.aliyuncs.com/2021/11/07/16356459954433.jpg?x-oss-process=image/auto-orient,1/quality,q_90/watermark,text_YW56aGVuLnRlY2g,size_40,x_10,y_10"></li>
<li>fileStatistics:整个文件中每个字段的统计信息，该表只有一个文件，也只有一个stripe<br>  <img src="https://anzhen-tech-imges.oss-cn-beijing.aliyuncs.com/2021/11/07/16356461542820.jpg?x-oss-process=image/auto-orient,1/quality,q_90/watermark,text_YW56aGVuLnRlY2g,size_40,x_10,y_10"></li>
<li>stripes:这里列出了所有stripes的元数据信息，包括index data, row data和stripe footer。<br>  <img src="https://anzhen-tech-imges.oss-cn-beijing.aliyuncs.com/2021/11/07/16356462325881.jpg?x-oss-process=image/auto-orient,1/quality,q_90/watermark,text_YW56aGVuLnRlY2g,size_40,x_10,y_10"></li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="9-4-4-Parquet格式"><a href="#9-4-4-Parquet格式" class="headerlink" title="9.4.4 Parquet格式"></a>9.4.4 Parquet格式</h3><p>Parquet文件是以二进制方式存储的，所以是不可以直接读取的，文件中包括该文件的数据和元数据，因此Parquet格式文件是自解析的。</p>
<ol>
<li>行组(Row Group)：每一个行组包含一定的行数，在一个HDFS文件中至少存储一个行组，类似于orc的stripe的概念。</li>
<li>列块(Column Chunk)：在一个行组中每一列保存在一个列块中，行组中的所有列连续的存储在这个行组文件中。一个列块中的值都是相同类型的，不同的列块可能使用不同的算法进行压缩。</li>
<li>页(Page)：每一个列块划分为多个页，一个页是最小的编码的单位，在同一个列块的不同页可能使用不同的编码方式。</li>
<li>通常情况下，在存储Parquet数据的时候会按照Block大小设置行组的大小，由于一般情况下每一个Mapper任务处理数据的最小单位是一个Block，这样可以把每一个行组由一个Mapper任务处理，增大任务执行并行度。Parquet文件的格式。</li>
</ol>
<h3 id="9-4-5-主流文件存储格式对比实验"><a href="#9-4-5-主流文件存储格式对比实验" class="headerlink" title="9.4.5 主流文件存储格式对比实验"></a>9.4.5 主流文件存储格式对比实验</h3><p>数据文件 <a href="media/16346959668071/log.data">log.data</a></p>
<ol>
<li>textfile<ol>
<li>建表导数据 存储数据格式为TEXTFILE <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> log_text</span><br><span class="line">(</span><br><span class="line">    track_time  string,</span><br><span class="line">    url         string,</span><br><span class="line">    session_id  string,</span><br><span class="line">    referer     string,</span><br><span class="line">    ip          string,</span><br><span class="line">    end_user_id string,</span><br><span class="line">    city_id     string</span><br><span class="line">)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span></span><br><span class="line">stored <span class="keyword">as</span> textfile;</span><br><span class="line"></span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/opt/module/hive-3.1.2/datas/log.data&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> log_text ;</span><br></pre></td></tr></table></figure></li>
<li>查看占用空间占用 18.1 M <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> dfs <span class="operator">-</span>ls <span class="operator">-</span>h <span class="operator">/</span><span class="keyword">user</span><span class="operator">/</span>hive<span class="operator">/</span>warehouse<span class="operator">/</span>mock_data.db<span class="operator">/</span>log_text;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                     DFS Output                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Found <span class="number">1</span> items                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--   3 atguigu supergroup     18.1 M 2021-10-30 10:34 /user/hive/warehouse/mock_data.db/log_text/log.data |</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> selected (<span class="number">0.008</span> seconds)</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li>orc<ol>
<li>建表导数据，指定orc格式 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> log_orc (</span><br><span class="line">    track_time  string,</span><br><span class="line">    url         string,</span><br><span class="line">    session_id  string,</span><br><span class="line">    referer     string,</span><br><span class="line">    ip          string,</span><br><span class="line">    end_user_id string,</span><br><span class="line">    city_id     string</span><br><span class="line">)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span></span><br><span class="line">stored <span class="keyword">as</span> orc</span><br><span class="line">tblproperties (&quot;orc.compress&quot; <span class="operator">=</span> &quot;NONE&quot;); <span class="comment">-- 设置orc存储不使用压缩</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> log_orc <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> log_text ;</span><br></pre></td></tr></table></figure></li>
<li>查看文件大小 7.7 M <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> dfs <span class="operator">-</span>ls <span class="operator">-</span>h <span class="operator">/</span><span class="keyword">user</span><span class="operator">/</span>hive<span class="operator">/</span>warehouse<span class="operator">/</span>mock_data.db<span class="operator">/</span>log_orc;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                     DFS Output                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Found <span class="number">1</span> items                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--   3 atguigu supergroup      7.7 M 2021-10-30 10:37 /user/hive/warehouse/mock_data.db/log_orc/000000_0 |</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> selected (<span class="number">0.005</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li>parquet<ol>
<li>建表导数据，指定parquet格式 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> log_parquet (</span><br><span class="line">    track_time  string,</span><br><span class="line">    url         string,</span><br><span class="line">    session_id  string,</span><br><span class="line">    referer     string,</span><br><span class="line">    ip          string,</span><br><span class="line">    end_user_id string,</span><br><span class="line">    city_id     string</span><br><span class="line">)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span></span><br><span class="line">stored <span class="keyword">as</span> parquet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> log_parquet <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> log_text ;</span><br></pre></td></tr></table></figure></li>
<li>查看文件大小 13.1 M <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> dfs <span class="operator">-</span>ls <span class="operator">-</span>h <span class="operator">/</span><span class="keyword">user</span><span class="operator">/</span>hive<span class="operator">/</span>warehouse<span class="operator">/</span>mock_data.db<span class="operator">/</span>log_parquet;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                     DFS Output                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Found <span class="number">1</span> items                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--   3 atguigu supergroup     13.1 M 2021-10-30 10:49 /user/hive/warehouse/mock_data.db/log_parquet/000000_0 |</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> selected (<span class="number">0.009</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li>存储文件大小的对比总结：<br> ORC &gt;  Parquet &gt;  textFile</li>
<li>存储文件的查询速度测试<br> ORC &gt;  Parquet &gt;  textFile <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">from</span> person <span class="keyword">where</span> id<span class="operator">=</span><span class="number">4</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> _c0  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">21.249</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">set</span> hive.optimize.index.filter<span class="operator">=</span><span class="literal">true</span>;</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">0.005</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">from</span> person_orc <span class="keyword">where</span> id<span class="operator">=</span><span class="number">4</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> _c0  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">17.151</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">from</span> person_parquet <span class="keyword">where</span> id<span class="operator">=</span><span class="number">4</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> _c0  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> selected (<span class="number">18.485</span> seconds)</span><br></pre></td></tr></table></figure>
<h2 id="9-5-存储和压缩结合"><a href="#9-5-存储和压缩结合" class="headerlink" title="9.5 存储和压缩结合"></a>9.5 存储和压缩结合</h2><h3 id="9-5-1-测试存储和压缩"><a href="#9-5-1-测试存储和压缩" class="headerlink" title="9.5.1 测试存储和压缩"></a>9.5.1 测试存储和压缩</h3></li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+ORC">官方文档</a></li>
<li>ORC存储方式的压缩：<table>
<thead>
<tr>
<th>Key</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody><tr>
<td>orc.compress</td>
<td>ZLIB</td>
<td>high level compression (one of NONE, ZLIB, SNAPPY)</td>
</tr>
<tr>
<td>orc.compress.size</td>
<td>262,144</td>
<td>number of bytes in each compression chunk</td>
</tr>
<tr>
<td>orc.stripe.size</td>
<td>268,435,456</td>
<td>number of bytes in each stripe</td>
</tr>
<tr>
<td>orc.row.index.stride</td>
<td>10,000</td>
<td>number of rows between index entries (must be &gt;= 1000)</td>
</tr>
<tr>
<td>orc.create.index</td>
<td>true</td>
<td>whether to create row indexes</td>
</tr>
<tr>
<td>orc.bloom.filter.columns</td>
<td>“”</td>
<td>comma separated list of column names for which bloom filter should be created</td>
</tr>
<tr>
<td>orc.bloom.filter.fpp</td>
<td>0.05</td>
<td>false positive probability for bloom filter (must &gt;0.0 and &lt;1.0)</td>
</tr>
</tbody></table>
</li>
<li>注意：所有关于ORCFile的参数都是在HQL语句的TBLPROPERTIES字段里面出现</li>
<li>测试<ol>
<li>创建ZLIB压缩的ORC存储方式<ul>
<li>建表导数据  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> log_orc_zlib (</span><br><span class="line">    track_time  string,</span><br><span class="line">    url         string,</span><br><span class="line">    session_id  string,</span><br><span class="line">    referer     string,</span><br><span class="line">    ip          string,</span><br><span class="line">    end_user_id string,</span><br><span class="line">    city_id     string</span><br><span class="line">)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span></span><br><span class="line">stored <span class="keyword">as</span> orc</span><br><span class="line">tblproperties (&quot;orc.compress&quot; <span class="operator">=</span> &quot;ZLIB&quot;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> log_orc_zlib <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> log_text;</span><br></pre></td></tr></table></figure></li>
<li>查看文件大小 2.8 M  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> dfs <span class="operator">-</span>ls <span class="operator">-</span>h <span class="operator">/</span><span class="keyword">user</span><span class="operator">/</span>hive<span class="operator">/</span>warehouse<span class="operator">/</span>mock_data.db<span class="operator">/</span>log_orc_zlib;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                     DFS Output                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Found <span class="number">1</span> items                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--   3 atguigu supergroup      2.8 M 2021-10-30 10:50 /user/hive/warehouse/mock_data.db/log_orc_zlib/000000_0 |</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> selected (<span class="number">0.011</span> seconds)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>创建一个SNAPPY压缩的ORC存储方式<ul>
<li>建表导数据  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> log_orc_snappy (</span><br><span class="line">    track_time  string,</span><br><span class="line">    url         string,</span><br><span class="line">    session_id  string,</span><br><span class="line">    referer     string,</span><br><span class="line">    ip          string,</span><br><span class="line">    end_user_id string,</span><br><span class="line">    city_id     string</span><br><span class="line">)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span></span><br><span class="line">stored <span class="keyword">as</span> orc</span><br><span class="line">tblproperties (&quot;orc.compress&quot; <span class="operator">=</span> &quot;SNAPPY&quot;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> log_orc_snappy <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> log_text;</span><br></pre></td></tr></table></figure></li>
<li>查看文件大小 3.7 M  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> dfs <span class="operator">-</span>ls <span class="operator">-</span>h <span class="operator">/</span><span class="keyword">user</span><span class="operator">/</span>hive<span class="operator">/</span>warehouse<span class="operator">/</span>mock_data.db<span class="operator">/</span>log_orc_snappy;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                     DFS Output                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Found <span class="number">1</span> items                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--   3 atguigu supergroup      3.7 M 2021-10-30 10:51 /user/hive/warehouse/mock_data.db/log_orc_snappy/000000_0 |</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> selected (<span class="number">0.009</span> seconds)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>创建一个SNAPPY压缩的parquet存储方式<ul>
<li>建表导数据  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> log_parquet_snappy (</span><br><span class="line">    track_time  string,</span><br><span class="line">    url         string,</span><br><span class="line">    session_id  string,</span><br><span class="line">    referer     string,</span><br><span class="line">    ip          string,</span><br><span class="line">    end_user_id string,</span><br><span class="line">    city_id     string</span><br><span class="line">)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span></span><br><span class="line">stored <span class="keyword">as</span> parquet</span><br><span class="line">tblproperties (&quot;parquet.compression&quot; <span class="operator">=</span> &quot;SNAPPY&quot;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> log_parquet_snappy <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> log_text;</span><br></pre></td></tr></table></figure></li>
<li>查看文件大小 6.4 M  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> dfs <span class="operator">-</span>ls <span class="operator">-</span>h <span class="operator">/</span><span class="keyword">user</span><span class="operator">/</span>hive<span class="operator">/</span>warehouse<span class="operator">/</span>mock_data.db<span class="operator">/</span>log_parquet_snappy;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                     DFS Output                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Found <span class="number">1</span> items                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--r--   3 atguigu supergroup      6.4 M 2021-10-31 12:29 /user/hive/warehouse/mock_data.db/log_parquet_snappy/000000_0 |</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> selected (<span class="number">0.078</span> seconds)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>存储方式和压缩总结<ul>
<li>在实际的项目开发当中，hive表的数据存储格式一般选择：orc或parquet。压缩方式一般选择snappy，lzo。<h1 id="十、性能优化"><a href="#十、性能优化" class="headerlink" title="十、性能优化"></a>十、性能优化</h1><h2 id="10-1-执行计划（Explain）"><a href="#10-1-执行计划（Explain）" class="headerlink" title="10.1 执行计划（Explain）"></a>10.1 执行计划（Explain）</h2></li>
</ul>
</li>
</ol>
</li>
</ul>
<ol>
<li>概念：获取SQL执行的规划，主要用于分析SQL需要的优化依据信息</li>
<li>基本语法 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN [EXTENDED <span class="operator">|</span> DEPENDENCY <span class="operator">|</span> <span class="keyword">AUTHORIZATION</span>] query</span><br></pre></td></tr></table></figure></li>
<li>案例实操<ul>
<li>不生成MR任务(关注Fetch Operator)  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                      Explain                       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> STAGE DEPENDENCIES:                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   Stage<span class="number">-0</span> <span class="keyword">is</span> a root stage                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> STAGE PLANS:                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   Stage: Stage<span class="number">-0</span>                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="keyword">Fetch</span> Operator                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       limit: <span class="number">-1</span>                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       Processor Tree:                              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         TableScan                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           alias: emp                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           Statistics: Num <span class="keyword">rows</span>: <span class="number">1</span> Data size: <span class="number">6570</span> Basic stats: COMPLETE <span class="keyword">Column</span> stats: <span class="keyword">NONE</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="keyword">Select</span> Operator                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>             expressions: emp_no (type: <span class="type">int</span>), emp_name (type: string), job (type: string), mgr (type: <span class="type">int</span>), hire_date (type: string), sal (type: <span class="keyword">double</span>), comm (type: <span class="keyword">double</span>), dept_no (type: <span class="type">int</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>             outputColumnNames: _col0, _col1, _col2, _col3, _col4, _col5, _col6, _col7 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>             Statistics: Num <span class="keyword">rows</span>: <span class="number">1</span> Data size: <span class="number">6570</span> Basic stats: COMPLETE <span class="keyword">Column</span> stats: <span class="keyword">NONE</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>             ListSink                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="number">17</span> <span class="keyword">rows</span> selected (<span class="number">0.076</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>生成MR任务的（关注Map Operator Tree）  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span> explain <span class="keyword">select</span> dept_no, <span class="built_in">avg</span>(sal) avg_sal <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> dept_no;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>                      Explain                       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> STAGE DEPENDENCIES:                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   Stage<span class="number">-1</span> <span class="keyword">is</span> a root stage                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   Stage<span class="number">-0</span> depends <span class="keyword">on</span> stages: Stage<span class="number">-1</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> STAGE PLANS:                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   Stage: Stage<span class="number">-1</span>                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     Map Reduce                                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       Map Operator Tree:                           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           TableScan                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>             alias: emp                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>             Statistics: Num <span class="keyword">rows</span>: <span class="number">1</span> Data size: <span class="number">6570</span> Basic stats: COMPLETE <span class="keyword">Column</span> stats: <span class="keyword">NONE</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>             <span class="keyword">Select</span> Operator                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>               expressions: sal (type: <span class="keyword">double</span>), dept_no (type: <span class="type">int</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>               outputColumnNames: sal, dept_no      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>               Statistics: Num <span class="keyword">rows</span>: <span class="number">1</span> Data size: <span class="number">6570</span> Basic stats: COMPLETE <span class="keyword">Column</span> stats: <span class="keyword">NONE</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>               <span class="keyword">Group</span> <span class="keyword">By</span> Operator                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                 aggregations: <span class="built_in">sum</span>(sal), <span class="built_in">count</span>(sal) <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                 keys: dept_no (type: <span class="type">int</span>)          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                 mode: hash                         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                 outputColumnNames: _col0, _col1, _col2 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                 Statistics: Num <span class="keyword">rows</span>: <span class="number">1</span> Data size: <span class="number">6570</span> Basic stats: COMPLETE <span class="keyword">Column</span> stats: <span class="keyword">NONE</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                 Reduce Output Operator             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                   key expressions: _col0 (type: <span class="type">int</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                   sort <span class="keyword">order</span>: <span class="operator">+</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                   Map<span class="operator">-</span>reduce <span class="keyword">partition</span> columns: _col0 (type: <span class="type">int</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                   Statistics: Num <span class="keyword">rows</span>: <span class="number">1</span> Data size: <span class="number">6570</span> Basic stats: COMPLETE <span class="keyword">Column</span> stats: <span class="keyword">NONE</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                   <span class="keyword">value</span> expressions: _col1 (type: <span class="keyword">double</span>), _col2 (type: <span class="type">bigint</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       Execution mode: vectorized                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       Reduce Operator Tree:                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="keyword">Group</span> <span class="keyword">By</span> Operator                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           aggregations: <span class="built_in">sum</span>(VALUE._col0), <span class="built_in">count</span>(VALUE._col1) <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           keys: KEY._col0 (type: <span class="type">int</span>)              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           mode: mergepartial                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           outputColumnNames: _col0, _col1, _col2   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           Statistics: Num <span class="keyword">rows</span>: <span class="number">1</span> Data size: <span class="number">6570</span> Basic stats: COMPLETE <span class="keyword">Column</span> stats: <span class="keyword">NONE</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="keyword">Select</span> Operator                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>             expressions: _col0 (type: <span class="type">int</span>), (_col1 <span class="operator">/</span> _col2) (type: <span class="keyword">double</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>             outputColumnNames: _col0, _col1        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>             Statistics: Num <span class="keyword">rows</span>: <span class="number">1</span> Data size: <span class="number">6570</span> Basic stats: COMPLETE <span class="keyword">Column</span> stats: <span class="keyword">NONE</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>             File Output Operator                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>               compressed: <span class="literal">false</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>               Statistics: Num <span class="keyword">rows</span>: <span class="number">1</span> Data size: <span class="number">6570</span> Basic stats: COMPLETE <span class="keyword">Column</span> stats: <span class="keyword">NONE</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>               <span class="keyword">table</span>:                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                   input format: org.apache.hadoop.mapred.SequenceFileInputFormat <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                   output format: org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                   serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   Stage: Stage<span class="number">-0</span>                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="keyword">Fetch</span> Operator                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       limit: <span class="number">-1</span>                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       Processor Tree:                              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         ListSink                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>                                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------------------------+</span></span><br><span class="line"><span class="number">53</span> <span class="keyword">rows</span> selected (<span class="number">0.063</span> seconds)</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="operator">/</span><span class="operator">/</span>hadoop001:<span class="number">10000</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>查看详细执行计划  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> explain extended <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp;</span><br><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> explain extended <span class="keyword">select</span> deptno, <span class="built_in">avg</span>(sal) avg_sal <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> deptno;</span><br></pre></td></tr></table></figure>
<h2 id="10-2-Fetch抓取"><a href="#10-2-Fetch抓取" class="headerlink" title="10.2 Fetch抓取"></a>10.2 Fetch抓取</h2></li>
</ul>
</li>
</ol>
<ul>
<li>Fetch抓取是指，Hive中对某些情况的查询可以不必使用MapReduce计算。</li>
<li>例如：SELECT * FROM employees;在这种情况下，Hive可以简单地读取employee对应的存储目录下的文件，然后输出查询结果到控制台。</li>
<li>在hive-default.xml.template文件中hive.fetch.task.conversion默认是more，老版本hive默认是minimal，该属性修改为more以后，在全局查找、字段查找、limit查找等都不走mapreduce。  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.fetch.task.conversion<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>more<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span></span><br><span class="line">      Expects one of [none, minimal, more].</span><br><span class="line">      Some select queries can be converted to single FETCH task minimizing latency.</span><br><span class="line">      Currently the query should be single sourced not having any subquery and should not have any aggregations or distincts (which incurs RS), lateral views and joins.</span><br><span class="line">      0. none : disable hive.fetch.task.conversion</span><br><span class="line">      1. minimal : SELECT STAR, FILTER on partition columns, LIMIT only</span><br><span class="line">      2. more  : SELECT, FILTER, LIMIT only (support TABLESAMPLE and virtual columns)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<ol>
<li>案例实操：<ol>
<li>把hive.fetch.task.conversion设置成none，然后执行查询语句，都会执行mapreduce程序。 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hive (default)&gt; <span class="built_in">set</span> hive.fetch.task.conversion=none;</span><br><span class="line">hive (default)&gt; select * from emp;</span><br><span class="line">hive (default)&gt; select ename from emp;</span><br><span class="line">hive (default)&gt; select ename from emp <span class="built_in">limit</span> 3;</span><br></pre></td></tr></table></figure></li>
<li>把hive.fetch.task.conversion设置成more，然后执行查询语句，如下查询方式都不会执行mapreduce程序。 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hive (default)&gt; <span class="built_in">set</span> hive.fetch.task.conversion=more;</span><br><span class="line">hive (default)&gt; select * from emp;</span><br><span class="line">hive (default)&gt; select ename from emp;</span><br><span class="line">hive (default)&gt; select ename from emp <span class="built_in">limit</span> 3;</span><br></pre></td></tr></table></figure>
<h2 id="10-3-本地模式"><a href="#10-3-本地模式" class="headerlink" title="10.3 本地模式"></a>10.3 本地模式</h2></li>
</ol>
</li>
</ol>
<ul>
<li>大多数的Hadoop Job是需要Hadoop提供的完整的可扩展性来处理大数据集的。不过，有时Hive的输入数据量是非常小的。在这种情况下，为查询触发执行任务消耗的时间可能会比实际job的执行时间要多的多。对于大多数这种情况，Hive可以通过本地模式在单台机器上处理所有的任务。对于小数据集，执行时间可以明显被缩短。</li>
<li>用户可以通过设置hive.exec.mode.local.auto的值为true，来让Hive在适当的时候自动启动这个优化。  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- //开启本地mr</span></span><br><span class="line"><span class="keyword">set</span> hive.exec.mode.local.auto<span class="operator">=</span><span class="literal">true</span>;</span><br><span class="line"><span class="comment">-- 设置local mr的最大输入数据量，当输入数据量小于这个值时采用local  mr的方式，默认为134217728，即128M</span></span><br><span class="line"><span class="keyword">set</span> hive.exec.mode.local.auto.inputbytes.max<span class="operator">=</span><span class="number">134217728</span>;</span><br><span class="line"><span class="comment">-- 设置local mr的最大输入文件个数，当输入文件个数小于这个值时采用local mr的方式，默认为4</span></span><br><span class="line"><span class="keyword">set</span> hive.exec.mode.local.auto.input.files.max<span class="operator">=</span><span class="number">4</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<ol>
<li>开启本地模式，并执行查询语句 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">set</span> hive.exec.mode.local.auto<span class="operator">=</span><span class="literal">true</span>; </span><br><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp cluster <span class="keyword">by</span> deptno;</span><br><span class="line"><span class="type">Time</span> taken: <span class="number">1.328</span> seconds, Fetched: <span class="number">14</span> <span class="type">row</span>(s)</span><br></pre></td></tr></table></figure></li>
<li>关闭本地模式，并执行查询语句 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">set</span> hive.exec.mode.local.auto<span class="operator">=</span><span class="literal">false</span>; </span><br><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp cluster <span class="keyword">by</span> deptno;</span><br><span class="line"><span class="type">Time</span> taken: <span class="number">20.09</span> seconds, Fetched: <span class="number">14</span> <span class="type">row</span>(s)</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="10-4-表的优化"><a href="#10-4-表的优化" class="headerlink" title="10.4 表的优化"></a>10.4 表的优化</h2><h3 id="10-4-1-小表大表Join-MapJoin-内连接场景"><a href="#10-4-1-小表大表Join-MapJoin-内连接场景" class="headerlink" title="10.4.1 小表大表Join(MapJoin)内连接场景"></a>10.4.1 小表大表Join(MapJoin)内连接场景</h3><ul>
<li>将key相对分散，并且数据量小的表放在join的左边，这样可以有效减少内存溢出错误发生的几率；再进一步，可以使用map join让小的维度表（1000条以下的记录条数）先进内存。在map端完成join。<blockquote>
<p>实际测试发现：新版的hive已经对小表JOIN大表和大表JOIN小表进行了优化。小表放在左边和右边已经没有明显区别。</p>
</blockquote>
</li>
<li>案例实操<ol>
<li>需求测试大表JOIN小表和小表JOIN大表的效率</li>
<li>开启MapJoin参数设置<ol>
<li>设置自动选择Mapjoin <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.auto.convert.join <span class="operator">=</span> <span class="literal">true</span>; 默认为<span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
<li>大表小表的阈值设置（默认25M以下认为是小表）： <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.mapjoin.smalltable.filesize <span class="operator">=</span> <span class="number">25000000</span>;</span><br></pre></td></tr></table></figure></li>
<li>MapJoin工作机制<br> <img src="https://anzhen-tech-imges.oss-cn-beijing.aliyuncs.com/2021/11/07/16355531696295.jpg?x-oss-process=image/auto-orient,1/quality,q_90/watermark,text_YW56aGVuLnRlY2g,size_40,x_10,y_10"></li>
<li>建大表、小表和JOIN后表的语句 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">-- 创建大表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> bigtable (</span><br><span class="line">     id        <span class="type">bigint</span>,</span><br><span class="line">     t         <span class="type">bigint</span>,</span><br><span class="line">     uid       string,</span><br><span class="line">     keyword   string,</span><br><span class="line">     url_rank  <span class="type">int</span>,</span><br><span class="line">     click_num <span class="type">int</span>,</span><br><span class="line">     click_url string</span><br><span class="line"> ) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"> <span class="comment">-- 创建小表</span></span><br><span class="line"> <span class="keyword">create</span> <span class="keyword">table</span> smalltable (</span><br><span class="line">     id        <span class="type">bigint</span>,</span><br><span class="line">     t         <span class="type">bigint</span>,</span><br><span class="line">     uid       string,</span><br><span class="line">     keyword   string,</span><br><span class="line">     url_rank  <span class="type">int</span>,</span><br><span class="line">     click_num <span class="type">int</span>,</span><br><span class="line">     click_url string</span><br><span class="line"> ) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">-- 创建join后表的语句</span></span><br><span class="line"> <span class="keyword">create</span> <span class="keyword">table</span> jointable (</span><br><span class="line">     id        <span class="type">bigint</span>,</span><br><span class="line">     t         <span class="type">bigint</span>,</span><br><span class="line">     uid       string,</span><br><span class="line">     keyword   string,</span><br><span class="line">     url_rank  <span class="type">int</span>,</span><br><span class="line">     click_num <span class="type">int</span>,</span><br><span class="line">     click_url string</span><br><span class="line"> ) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li>分别向大表和小表中导入数据 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> load data <span class="keyword">local</span> inpath <span class="string">&#x27;/opt/module/hive-3.1.2/datas/bigtable&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> bigtable;</span><br><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span>load data <span class="keyword">local</span> inpath <span class="string">&#x27;/opt/module/hive-3.1.2/datas/smalltable&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> smalltable;</span><br></pre></td></tr></table></figure></li>
<li>小表JOIN大表语句 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> jointable</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">       b.id, </span><br><span class="line">       b.t, </span><br><span class="line">       b.uid, </span><br><span class="line">       b.keyword, </span><br><span class="line">       b.url_rank, </span><br><span class="line">       b.click_num, </span><br><span class="line">       b.click_url</span><br><span class="line"><span class="keyword">from</span> smalltable s</span><br><span class="line">         <span class="keyword">join</span> bigtable b <span class="keyword">on</span> b.id <span class="operator">=</span> s.id;</span><br></pre></td></tr></table></figure></li>
<li>执行大表JOIN小表语句 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> jointable</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">       b.id, </span><br><span class="line">       b.t, </span><br><span class="line">       b.uid, </span><br><span class="line">       b.keyword, </span><br><span class="line">       b.url_rank, </span><br><span class="line">       b.click_num, </span><br><span class="line">       b.click_url</span><br><span class="line"><span class="keyword">from</span> bigtable  b</span><br><span class="line">    <span class="keyword">join</span> smalltable  s <span class="keyword">on</span> s.id <span class="operator">=</span> b.id;</span><br></pre></td></tr></table></figure>
<h3 id="10-4-2-大表Join大表"><a href="#10-4-2-大表Join大表" class="headerlink" title="10.4.2 大表Join大表"></a>10.4.2 大表Join大表</h3></li>
</ol>
</li>
</ol>
</li>
</ul>
<ol>
<li>大表和大表join时，MR一定执行ReduceJoin操作，需要注意优化的点就是ReduceJoin带来的问题！！！<h4 id="10-4-2-1-空Key过滤（针对数据倾斜的一种解决方案）"><a href="#10-4-2-1-空Key过滤（针对数据倾斜的一种解决方案）" class="headerlink" title="10.4.2.1 空Key过滤（针对数据倾斜的一种解决方案）"></a>10.4.2.1 空Key过滤（针对数据倾斜的一种解决方案）</h4></li>
<li>当大表和大表Join走MR的时候，相同Key对应的values会进入一个Reduce，如果出现大量相同搞得key，会导致数据倾斜</li>
<li>案例实操<ol>
<li>创建原始数据表、空id表、合并后数据表 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建空id表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> nullidtable (</span><br><span class="line">    id        <span class="type">bigint</span>,</span><br><span class="line">    t         <span class="type">bigint</span>,</span><br><span class="line">    uid       string,</span><br><span class="line">    keyword   string,</span><br><span class="line">    url_rank  <span class="type">int</span>,</span><br><span class="line">    click_num <span class="type">int</span>,</span><br><span class="line">    click_url string</span><br><span class="line">) <span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li>分别加载原始数据和空id数据到对应表中 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> load data <span class="keyword">local</span> inpath <span class="string">&#x27;/opt/module/hive-3.1.2/datas/nullid&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> nullidtable;</span><br></pre></td></tr></table></figure></li>
<li>测试不过滤空id <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">insert</span> overwrite <span class="keyword">table</span> jointable <span class="keyword">select</span> n.<span class="operator">*</span> <span class="keyword">from</span> nullidtable n <span class="keyword">left</span> <span class="keyword">join</span> bigtable o <span class="keyword">on</span> n.id <span class="operator">=</span> o.id;</span><br></pre></td></tr></table></figure></li>
<li>测试过滤空id <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">insert</span> overwrite <span class="keyword">table</span> jointable <span class="keyword">select</span> n.<span class="operator">*</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> nullidtable <span class="keyword">where</span> id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> ) n  <span class="keyword">left</span> <span class="keyword">join</span> bigtable o <span class="keyword">on</span> n.id <span class="operator">=</span> o.id;</span><br></pre></td></tr></table></figure>
<h4 id="10-4-2-1-SMB-Sort-Merge-Bucket-join"><a href="#10-4-2-1-SMB-Sort-Merge-Bucket-join" class="headerlink" title="10.4.2.1 SMB(Sort Merge Bucket join)"></a>10.4.2.1 SMB(Sort Merge Bucket join)</h4></li>
</ol>
</li>
<li>数据量超级大的时候可能导致Join时间过长，或者直接导致Job失败</li>
<li>原理：从建表的时候就将其创建为分桶表，两表的关联字段作为分桶字段，后续做Join的时候就对桶进行Join，避免了每一条数据进行Join</li>
<li>案例实操<ul>
<li>创建第二张大表  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> bigtable2 (</span><br><span class="line">    id        <span class="type">bigint</span>,</span><br><span class="line">    t         <span class="type">bigint</span>,</span><br><span class="line">    uid       string,</span><br><span class="line">    keyword   string,</span><br><span class="line">    url_rank  <span class="type">int</span>,</span><br><span class="line">    click_num <span class="type">int</span>,</span><br><span class="line">    click_url string</span><br><span class="line">)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/home/atguigu/hive/table_optimize/bigtable&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> bigtable2;</span><br></pre></td></tr></table></figure></li>
<li>测试大表直接JOIN 耗时51.176  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> jointable</span><br><span class="line"><span class="keyword">select</span> b.id,</span><br><span class="line">       b.t,</span><br><span class="line">       b.uid,</span><br><span class="line">       b.keyword,</span><br><span class="line">       b.url_rank,</span><br><span class="line">       b.click_num,</span><br><span class="line">       b.click_url</span><br><span class="line"><span class="keyword">from</span> bigtable s</span><br><span class="line"><span class="keyword">join</span> bigtable2 b <span class="keyword">on</span> b.id <span class="operator">=</span> s.id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">51.176</span> seconds)</span><br></pre></td></tr></table></figure></li>
<li>创建分桶表1, 创建分桶表2, 桶的个数不要超过可用CPU的核数  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> bigtable_buck1 (</span><br><span class="line">    id        <span class="type">bigint</span>,</span><br><span class="line">    t         <span class="type">bigint</span>,</span><br><span class="line">    uid       string,</span><br><span class="line">    keyword   string,</span><br><span class="line">    url_rank  <span class="type">int</span>,</span><br><span class="line">    click_num <span class="type">int</span>,</span><br><span class="line">    click_url string</span><br><span class="line">)</span><br><span class="line">clustered <span class="keyword">by</span> (id)</span><br><span class="line">sorted <span class="keyword">by</span> (id)</span><br><span class="line"><span class="keyword">into</span> <span class="number">8</span> buckets</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> bigtable_buck2 (</span><br><span class="line">    id        <span class="type">bigint</span>,</span><br><span class="line">    t         <span class="type">bigint</span>,</span><br><span class="line">    uid       string,</span><br><span class="line">    keyword   string,</span><br><span class="line">    url_rank  <span class="type">int</span>,</span><br><span class="line">    click_num <span class="type">int</span>,</span><br><span class="line">    click_url string</span><br><span class="line">)</span><br><span class="line">clustered <span class="keyword">by</span> (id)</span><br><span class="line">sorted <span class="keyword">by</span> (id)</span><br><span class="line"><span class="keyword">into</span> <span class="number">8</span> buckets</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"></span><br><span class="line">load data inpath <span class="string">&#x27;/bigtable&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> bigtable_buck1;</span><br><span class="line">load data inpath <span class="string">&#x27;/bigtable&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> bigtable_buck2;</span><br></pre></td></tr></table></figure></li>
<li>设置参数  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.optimize.bucketmapjoin <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">set</span> hive.optimize.bucketmapjoin.sortedmerge <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">set</span> hive.input.format<span class="operator">=</span>org.apache.hadoop.hive.ql.io.BucketizedHiveInputFormat;</span><br></pre></td></tr></table></figure></li>
<li>测试 耗时23.272 seconds  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> jointable</span><br><span class="line"><span class="keyword">select</span> b.id,</span><br><span class="line">       b.t,</span><br><span class="line">       b.uid,</span><br><span class="line">       b.keyword,</span><br><span class="line">       b.url_rank,</span><br><span class="line">       b.click_num,</span><br><span class="line">       b.click_url</span><br><span class="line"><span class="keyword">from</span> bigtable_buck1 s</span><br><span class="line"><span class="keyword">join</span> bigtable_buck2 b <span class="keyword">on</span> b.id <span class="operator">=</span> s.id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">No</span> <span class="keyword">rows</span> affected (<span class="number">23.272</span> seconds)</span><br></pre></td></tr></table></figure>
<h3 id="10-4-3-Group-By"><a href="#10-4-3-Group-By" class="headerlink" title="10.4.3 Group By"></a>10.4.3 Group By</h3></li>
</ul>
</li>
</ol>
<ul>
<li>分组聚合操作时，如果一个组内出现大量的数据，都会交给一个reduce处理，很可能会造成数据倾斜<br>  <img src="https://anzhen-tech-imges.oss-cn-beijing.aliyuncs.com/2021/11/07/16355799864007.jpg?x-oss-process=image/auto-orient,1/quality,q_90/watermark,text_YW56aGVuLnRlY2g,size_40,x_10,y_10"></li>
<li>解决思路<ol>
<li>是否在Map端进行聚合，默认为True<br> <code>set hive.map.aggr = true</code></li>
<li>在Map端进行聚合操作的条目数目<br><code>set   = 100000</code> </li>
<li>有数据倾斜的时候进行负载均衡（默认是false）<br> <code>set hive.groupby.skewindata = true</code><br> <font color ='red' >当选项设定为 true，生成的查询计划会有两个MR Job</font>。第一个MR Job中，Map的输出结果会随机分布到Reduce中，每个Reduce做部分聚合操作，并输出结果，这样处理的结果是<font color ='red' >相同的Group By Key有可能被分发到不同的Reduce中</font>，从而达到负载均衡的目的；第二个MR Job再根据预处理的数据结果按照Group By Key分布到Reduce中（这个过程可以保证相同的Group By Key被分布到同一个Reduce中），最后完成最终的聚合操作。</li>
</ol>
<ul>
<li>思路：会多执行一个Job做数据的负载均衡 解决数据倾斜！</li>
</ul>
</li>
<li>测试<ul>
<li>直接执行  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">       substr(birth, <span class="number">0</span>, <span class="number">7</span>), </span><br><span class="line">       <span class="built_in">count</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">from</span> person</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> substr(birth, <span class="number">0</span>, <span class="number">7</span>)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="number">2</span> <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line">INFO  : MapReduce Jobs Launched:</span><br><span class="line">INFO  : Stage<span class="operator">-</span>Stage<span class="number">-1</span>: Map: <span class="number">1</span>  Reduce: <span class="number">1</span>   Cumulative CPU: <span class="number">2.12</span> sec   HDFS Read: <span class="number">14687</span> HDFS Write: <span class="number">138</span> SUCCESS</span><br><span class="line">INFO  : Total MapReduce CPU <span class="type">Time</span> Spent: <span class="number">2</span> seconds <span class="number">120</span> msec</span><br></pre></td></tr></table></figure></li>
<li>修改参数执行   <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.groupby.skewindata <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">       substr(birth, <span class="number">0</span>, <span class="number">7</span>), </span><br><span class="line">       <span class="built_in">count</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">from</span> person</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> substr(birth, <span class="number">0</span>, <span class="number">7</span>)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="number">2</span> <span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line">INFO  : MapReduce Jobs Launched:</span><br><span class="line">INFO  : Stage<span class="operator">-</span>Stage<span class="number">-1</span>: Map: <span class="number">1</span>  Reduce: <span class="number">1</span>   Cumulative CPU: <span class="number">2.47</span> sec   HDFS Read: <span class="number">14399</span> HDFS Write: <span class="number">153</span> SUCCESS</span><br><span class="line">INFO  : Stage<span class="operator">-</span>Stage<span class="number">-2</span>: Map: <span class="number">1</span>  Reduce: <span class="number">1</span>   Cumulative CPU: <span class="number">2.08</span> sec   HDFS Read: <span class="number">7574</span> HDFS Write: <span class="number">138</span> SUCCESS</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="10-4-4-Count-Distinct-去重统计"><a href="#10-4-4-Count-Distinct-去重统计" class="headerlink" title="10.4.4 Count(Distinct) 去重统计"></a>10.4.4 Count(Distinct) 去重统计</h3><p>数据量小的时候无所谓，数据量大的情况下，由于COUNT DISTINCT操作需要用一个Reduce Task来完成，这一个Reduce需要处理的数据量太大，就会导致整个Job很难完成，一般COUNT DISTINCT使用先GROUP BY再COUNT的方式替换,但是需要注意group by造成的数据倾斜问题.</p>
<ol>
<li>设置5个reduce个数 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> mapreduce.job.reduces <span class="operator">=</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure></li>
<li>执行去重id查询 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> id) <span class="keyword">from</span> bigtable;</span><br><span class="line">Stage<span class="operator">-</span>Stage<span class="number">-1</span>: Map: <span class="number">1</span>  Reduce: <span class="number">1</span>   Cumulative CPU: <span class="number">7.12</span> sec   HDFS Read: <span class="number">120741990</span> HDFS Write: <span class="number">7</span> SUCCESS</span><br><span class="line">Total MapReduce CPU <span class="type">Time</span> Spent: <span class="number">7</span> seconds <span class="number">120</span> msec</span><br><span class="line">OK</span><br><span class="line">c0</span><br><span class="line"><span class="number">100001</span></span><br><span class="line"><span class="type">Time</span> taken: <span class="number">23.607</span> seconds, Fetched: <span class="number">1</span> <span class="type">row</span>(s)</span><br></pre></td></tr></table></figure></li>
<li>采用GROUP by去重id <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hive (<span class="keyword">default</span>)<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="built_in">count</span>(id) <span class="keyword">from</span> (<span class="keyword">select</span> id <span class="keyword">from</span> bigtable <span class="keyword">group</span> <span class="keyword">by</span> id) a;</span><br><span class="line">Stage<span class="operator">-</span>Stage<span class="number">-1</span>: Map: <span class="number">1</span>  Reduce: <span class="number">5</span>   Cumulative CPU: <span class="number">17.53</span> sec   HDFS Read: <span class="number">120752703</span> HDFS Write: <span class="number">580</span> SUCCESS</span><br><span class="line">Stage<span class="operator">-</span>Stage<span class="number">-2</span>: Map: <span class="number">1</span>  Reduce: <span class="number">1</span>   Cumulative CPU: <span class="number">4.29</span> sec2   HDFS Read: <span class="number">9409</span> HDFS Write: <span class="number">7</span> SUCCESS</span><br><span class="line">Total MapReduce CPU <span class="type">Time</span> Spent: <span class="number">21</span> seconds <span class="number">820</span> msec</span><br><span class="line">OK</span><br><span class="line">_c0</span><br><span class="line"><span class="number">100001</span></span><br><span class="line"><span class="type">Time</span> taken: <span class="number">50.795</span> seconds, Fetched: <span class="number">1</span> <span class="type">row</span>(s)</span><br></pre></td></tr></table></figure></li>
<li>虽然会多用一个Job来完成，但在数据量大的情况下，可以避免Reduce因为数据量大导致失败，所以是值得的。</li>
</ol>
<h3 id="10-4-5-笛卡尔积"><a href="#10-4-5-笛卡尔积" class="headerlink" title="10.4.5 笛卡尔积"></a>10.4.5 笛卡尔积</h3><p>尽量避免笛卡尔积，join的时候不加on条件，或者无效的on条件，Hive只能使用1个reducer来完成笛卡尔积。</p>
<h3 id="10-4-6-行列过滤"><a href="#10-4-6-行列过滤" class="headerlink" title="10.4.6 行列过滤"></a>10.4.6 行列过滤</h3><ul>
<li>列处理：在SELECT中，只拿需要的列，如果有分区，尽量使用分区过滤，少用SELECT *。</li>
<li>行处理：在分区剪裁中，当使用外关联时，如果将副表的过滤条件写在Where后面，那么就会先全表关联，之后再过滤，比如：</li>
<li>案例实操：<ol>
<li>测试先关联两张表，再用where条件过滤 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">       o.id </span><br><span class="line"><span class="keyword">from</span> bigtable b</span><br><span class="line"><span class="keyword">join</span> bigtable o <span class="keyword">on</span>  o.id <span class="operator">=</span> b.id</span><br><span class="line"><span class="keyword">where</span> o.id <span class="operator">&lt;=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>,<span class="number">081</span> <span class="keyword">rows</span> selected (<span class="number">18.979</span> seconds)</span><br></pre></td></tr></table></figure></li>
<li>通过子查询后，再关联表 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">       b.id</span><br><span class="line"><span class="keyword">from</span> bigtable b</span><br><span class="line"><span class="keyword">join</span> (<span class="keyword">select</span> </span><br><span class="line">             id</span><br><span class="line">    <span class="keyword">from</span> bigtable</span><br><span class="line">    <span class="keyword">where</span> id <span class="operator">&lt;=</span> <span class="number">10</span>) o </span><br><span class="line"><span class="keyword">on</span> b.id <span class="operator">=</span> o.id;</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>,<span class="number">081</span> <span class="keyword">rows</span> selected (<span class="number">17.753</span> seconds)</span><br></pre></td></tr></table></figure>
<h3 id="10-4-7-分区"><a href="#10-4-7-分区" class="headerlink" title="10.4.7 分区"></a>10.4.7 分区</h3>详见7.1章。</li>
</ol>
</li>
</ul>
<h3 id="10-4-8-分桶"><a href="#10-4-8-分桶" class="headerlink" title="10.4.8 分桶"></a>10.4.8 分桶</h3><pre><code>详见7.2章。
</code></pre>
<h2 id="10-5-合理设置Map及Reduce数"><a href="#10-5-合理设置Map及Reduce数" class="headerlink" title="10.5 合理设置Map及Reduce数"></a>10.5 合理设置Map及Reduce数</h2><ol>
<li>通常情况下，作业会产生一个或者多个map任务。<ul>
<li>主要的决定因素有：input的文件总个数，input的文件大小，集群设置的文件块大小。</li>
</ul>
</li>
<li>是不是map数越多越好？<ul>
<li>答案是否定的。如果一个任务有很多小文件（远远小于块大小128m），则每个小文件也会被当做一个片，用一个map任务来完成，而一个map任务启动和初始化的时间远远大于逻辑处理的时间，就会造成很大的资源浪费。而且，同时可执行的map数是受限的。</li>
</ul>
</li>
<li>是不是保证每个map处理接近128m的文件块，就高枕无忧了？<ul>
<li>答案也是不一定。比如有一个127m的文件，正常会用一个map去完成，但这个文件只有一个或者两个小字段，却有几千万的记录，如果map处理的逻辑比较复杂，用一个map任务去做，肯定也比较耗时。</li>
</ul>
</li>
</ol>
<ul>
<li>针对上面的问题2和3，我们需要采取两种方式来解决：即减少map数和增加map数；</li>
</ul>
<h3 id="10-5-1-复杂文件增加Map数"><a href="#10-5-1-复杂文件增加Map数" class="headerlink" title="10.5.1 复杂文件增加Map数"></a>10.5.1 复杂文件增加Map数</h3><ul>
<li>当input的文件都很大，任务逻辑复杂，map执行非常慢的时候，可以考虑增加Map数，来使得每个map处理的数据量减少，从而提高任务的执行效率。</li>
<li>增加map的方法为：根据<br>computeSliteSize(Math.max(minSize,Math.min(maxSize,blocksize)))=blocksize=128M公式，调整maxSize最大值。让maxSize最大值低于blocksize就可以增加map的个数。</li>
<li>案例实操：<ol>
<li>执行查询 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> bigtable;</span><br><span class="line"></span><br><span class="line">Hadoop job information <span class="keyword">for</span> Stage<span class="number">-1</span>: number <span class="keyword">of</span> mappers: <span class="number">1</span>; number <span class="keyword">of</span> reducers: <span class="number">1</span></span><br></pre></td></tr></table></figure></li>
<li>设置最大切片值为100个字节 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> mapreduce.input.fileinputformat.split.maxsize<span class="operator">=</span><span class="number">10240</span>;</span><br><span class="line"></span><br><span class="line">Hadoop job information <span class="keyword">for</span> Stage<span class="number">-1</span>: number <span class="keyword">of</span> mappers: <span class="number">12613</span>; number <span class="keyword">of</span> reducers: <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h3 id="10-5-2-小文件进行合并"><a href="#10-5-2-小文件进行合并" class="headerlink" title="10.5.2 小文件进行合并"></a>10.5.2 小文件进行合并</h3></li>
</ol>
</li>
</ul>
<ol>
<li>在map执行前合并小文件，减少map数：CombineHiveInputFormat具有对小文件进行合并的功能（系统默认的格式）。HiveInputFormat没有对小文件合并功能。 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.input.format<span class="operator">=</span> org.apache.hadoop.hive.ql.io.CombineHiveInputFormat;</span><br></pre></td></tr></table></figure></li>
<li>在Map-Reduce的任务结束时合并小文件的设置：<ul>
<li>在map-only任务结束时合并小文件，默认true  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> hive.merge.mapfiles <span class="operator">=</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure></li>
<li>在map-reduce任务结束时合并小文件，默认false  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> hive.merge.mapredfiles <span class="operator">=</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure></li>
<li>合并文件的大小，默认256M  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> hive.merge.size.per.task <span class="operator">=</span> <span class="number">268435456</span>;</span><br></pre></td></tr></table></figure></li>
<li>当输出文件的平均大小小于该值时，启动一个独立的map-reduce任务进行文件merge  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> hive.merge.smallfiles.avgsize <span class="operator">=</span> <span class="number">16777216</span>;</span><br></pre></td></tr></table></figure>
<h3 id="10-5-3-合理设置Reduce数"><a href="#10-5-3-合理设置Reduce数" class="headerlink" title="10.5.3 合理设置Reduce数"></a>10.5.3 合理设置Reduce数</h3></li>
</ul>
</li>
<li>调整reduce个数方法一<ol>
<li>每个Reduce处理的数据量默认是256MB <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive.exec.reducers.bytes.per.reducer<span class="operator">=</span><span class="number">256000000</span></span><br></pre></td></tr></table></figure></li>
<li>每个任务最大的reduce数，默认为1009 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive.exec.reducers.max<span class="operator">=</span><span class="number">1009</span></span><br></pre></td></tr></table></figure></li>
<li>计算reducer数的公式 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">N<span class="operator">=</span><span class="built_in">min</span>(参数<span class="number">2</span>，总输入数据量<span class="operator">/</span>参数<span class="number">1</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li>调整reduce个数方法二<ol>
<li>在hadoop的mapred-default.xml文件中修改，设置每个job的Reduce个数 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> mapreduce.job.reduces <span class="operator">=</span> <span class="number">15</span>;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li>reduce个数并不是越多越好<ol>
<li>过多的启动和初始化reduce也会消耗时间和资源；</li>
<li>另外，有多少个reduce，就会有多少个输出文件，如果生成了很多个小文件，那么如果这些小文件作为下一个任务的输入，则也会出现小文件过多的问题；</li>
<li>在设置reduce个数的时候也需要考虑这两个原则：处理大数据量利用合适的reduce数；使单个reduce任务处理数据量大小要合适；</li>
</ol>
</li>
</ol>
<h3 id="10-6-并行执行"><a href="#10-6-并行执行" class="headerlink" title="10.6 并行执行"></a>10.6 并行执行</h3><ul>
<li>Hive会将一个查询转化成一个或者多个阶段。这样的阶段可以是MapReduce阶段、抽样阶段、合并阶段、limit阶段。或者Hive执行过程中可能需要的其他阶段。默认情况下，Hive一次只会执行一个阶段。不过，某个特定的job可能包含众多的阶段，而这些阶段可能并非完全互相依赖的，也就是说有些阶段是可以并行执行的，这样可能使得整个job的执行时间缩短。不过，如果有更多的阶段可以并行执行，那么job可能就越快完成。</li>
<li>通过设置参数hive.exec.parallel值为true，就可以开启并发执行。不过，在共享集群中，需要注意下，如果job中并行阶段增多，那么集群利用率就会增加。当然，得是在系统资源比较空闲的时候才有优势，否则，没资源，并行也起不来。  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 打开任务并行执行</span></span><br><span class="line"><span class="keyword">set</span> hive.exec.parallel<span class="operator">=</span><span class="literal">true</span>;</span><br><span class="line"><span class="comment">-- 同一个sql允许最大并行度，默认为8。</span></span><br><span class="line"><span class="keyword">set</span> hive.exec.parallel.thread.number<span class="operator">=</span><span class="number">8</span>; </span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="10-7-严格模式"><a href="#10-7-严格模式" class="headerlink" title="10.7 严格模式"></a>10.7 严格模式</h3><p>Hive可以通过设置防止一些危险操作：</p>
<ol>
<li>分区表不使用分区过滤<ul>
<li>将hive.strict.checks.no.partition.filter设置为true时，对于分区表，除非where语句中含有分区字段过滤条件来限制范围，否则不允许执行。换句话说，就是用户不允许扫描所有分区。进行这个限制的原因是，通常分区表都拥有非常大的数据集，而且数据增加迅速。没有进行分区限制的查询可能会消耗令人不可接受的巨大资源来处理这个表。</li>
</ul>
</li>
<li>使用order by没有limit过滤<ul>
<li>将hive.strict.checks.orderby.no.limit设置为true时，对于使用了order by语句的查询，要求必须使用limit语句。因为order by为了执行排序过程会将所有的结果数据分发到同一个Reducer中进行处理，强制要求用户增加这个LIMIT语句可以防止Reducer额外执行很长一段时间。</li>
</ul>
</li>
<li>笛卡尔积<ul>
<li>将hive.strict.checks.cartesian.product设置为true时，会限制笛卡尔积的查询。对关系型数据库非常了解的用户可能期望在 执行JOIN查询的时候不使用ON语句而是使用where语句，这样关系数据库的执行优化器就可以高效地将WHERE语句转化成那个ON语句。不幸的是，Hive并不会执行这种优化，因此，如果表足够大，那么这个查询就会出现不可控的情况。</li>
</ul>
</li>
</ol>
<h2 id="10-8-JVM重用"><a href="#10-8-JVM重用" class="headerlink" title="10.8 JVM重用"></a>10.8 JVM重用</h2><pre><code>详见hadoop优化文档中jvm重用
</code></pre>
<h2 id="10-9-压缩"><a href="#10-9-压缩" class="headerlink" title="10.9 压缩"></a>10.9 压缩</h2><pre><code>详见第9章。
</code></pre>
<h1 id="十一、Hive实战"><a href="#十一、Hive实战" class="headerlink" title="十一、Hive实战"></a>十一、Hive实战</h1><h2 id="11-1-需求描述"><a href="#11-1-需求描述" class="headerlink" title="11.1 需求描述"></a>11.1 需求描述</h2><p>统计硅谷影音视频网站的常规指标，各种TopN指标：</p>
<ul>
<li>统计视频观看数Top10</li>
<li>统计视频类别热度Top10</li>
<li>统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数</li>
<li>统计视频观看数Top50所关联视频的所属类别Rank</li>
<li>统计每个类别中的视频热度Top10,以Music为例</li>
<li>统计每个类别视频观看数Top10</li>
<li>统计上传视频最多的用户Top10以及他们上传的视频观看次数在前20的视频 </li>
</ul>
<h2 id="11-2-数据结构"><a href="#11-2-数据结构" class="headerlink" title="11.2 数据结构"></a>11.2 数据结构</h2><ol>
<li>视频表<table>
<thead>
<tr>
<th>字段</th>
<th>备注</th>
<th>详细描述</th>
</tr>
</thead>
<tbody><tr>
<td>videoId</td>
<td>视频唯一id（String）</td>
<td>11位字符串</td>
</tr>
<tr>
<td>uploader</td>
<td>视频上传者（String）</td>
<td>上传视频的用户名String</td>
</tr>
<tr>
<td>age</td>
<td>视频年龄（int）</td>
<td>视频在平台上的整数天</td>
</tr>
<tr>
<td>category</td>
<td>视频类别（Array<String>）</td>
<td>上传视频指定的视频分类</td>
</tr>
<tr>
<td>length</td>
<td>视频长度（Int）</td>
<td>整形数字标识的视频长度</td>
</tr>
<tr>
<td>views</td>
<td>观看次数（Int）</td>
<td>视频被浏览的次数</td>
</tr>
<tr>
<td>rate</td>
<td>视频评分（Double）</td>
<td>满分5分</td>
</tr>
<tr>
<td>Ratings</td>
<td>流量（Int）</td>
<td>视频的流量，整型数字</td>
</tr>
<tr>
<td>conments</td>
<td>评论数（Int）</td>
<td>一个视频的整数评论数</td>
</tr>
<tr>
<td>relatedId</td>
<td>相关视频id（Array<String>）</td>
<td>相关视频的id，最多20个</td>
</tr>
</tbody></table>
</li>
<li>用户表<table>
<thead>
<tr>
<th>字段</th>
<th>备注</th>
<th>字段类型</th>
</tr>
</thead>
<tbody><tr>
<td>uploader</td>
<td>上传者用户名</td>
<td>string</td>
</tr>
<tr>
<td>videos</td>
<td>上传视频数</td>
<td>int</td>
</tr>
<tr>
<td>friends</td>
<td>朋友数量</td>
<td>int</td>
</tr>
</tbody></table>
</li>
</ol>
<h2 id="11-3-准备工作"><a href="#11-3-准备工作" class="headerlink" title="11.3 准备工作"></a>11.3 准备工作</h2><h3 id="11-3-1-ETL"><a href="#11-3-1-ETL" class="headerlink" title="11.3.1 ETL"></a>11.3.1 ETL</h3><h3 id="11-3-2-准备表"><a href="#11-3-2-准备表" class="headerlink" title="11.3.2 准备表"></a>11.3.2 准备表</h3><ol>
<li>需要准备的表<ul>
<li>创建原始数据表：gulivideo_ori，gulivideo_user_ori，</li>
<li>创建最终表：gulivideo_orc，gulivideo_user_orc</li>
</ul>
</li>
<li>创建原始数据表：<ul>
<li>创建视频原始数据表：gulivideo_ori  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> gulivideo_ori (</span><br><span class="line">    videoId   string,</span><br><span class="line">    uploader  string,</span><br><span class="line">    age       <span class="type">int</span>,</span><br><span class="line">    category  <span class="keyword">array</span><span class="operator">&lt;</span>string<span class="operator">&gt;</span>,</span><br><span class="line">    length    <span class="type">int</span>,</span><br><span class="line">    `views`     <span class="type">int</span>,</span><br><span class="line">    rate      <span class="type">float</span>,</span><br><span class="line">    ratings   <span class="type">int</span>,</span><br><span class="line">    comments  <span class="type">int</span>,</span><br><span class="line">    relatedId <span class="keyword">array</span><span class="operator">&lt;</span>string<span class="operator">&gt;</span></span><br><span class="line">)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> &quot;\t&quot;</span><br><span class="line">collection items terminated <span class="keyword">by</span> &quot;&amp;&quot;</span><br><span class="line">stored <span class="keyword">as</span> textfile;</span><br></pre></td></tr></table></figure></li>
<li>创建用户原始数据表: gulivideo_user_ori  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> gulivideo_user_ori(</span><br><span class="line">    uploader string,</span><br><span class="line">    videos <span class="type">int</span>,</span><br><span class="line">    friends <span class="type">int</span>)</span><br><span class="line"><span class="type">row</span> format delimited </span><br><span class="line">fields terminated <span class="keyword">by</span> &quot;\t&quot; </span><br><span class="line">stored <span class="keyword">as</span> textfile;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>创建orc存储格式带snappy压缩的表：<ul>
<li>gulivideo_orc  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> gulivideo_orc(</span><br><span class="line">    videoId string, </span><br><span class="line">    uploader string, </span><br><span class="line">    age <span class="type">int</span>, </span><br><span class="line">    category <span class="keyword">array</span><span class="operator">&lt;</span>string<span class="operator">&gt;</span>, </span><br><span class="line">    length <span class="type">int</span>, </span><br><span class="line">    views <span class="type">int</span>, </span><br><span class="line">    rate <span class="type">float</span>, </span><br><span class="line">    ratings <span class="type">int</span>, </span><br><span class="line">    comments <span class="type">int</span>,</span><br><span class="line">    relatedId <span class="keyword">array</span><span class="operator">&lt;</span>string<span class="operator">&gt;</span>)</span><br><span class="line">stored <span class="keyword">as</span> orc</span><br><span class="line">tblproperties(&quot;orc.compress&quot;<span class="operator">=</span>&quot;SNAPPY&quot;);</span><br></pre></td></tr></table></figure></li>
<li>gulivideo_user_orc  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> gulivideo_user_orc(</span><br><span class="line">    uploader string,</span><br><span class="line">    videos <span class="type">int</span>,</span><br><span class="line">    friends <span class="type">int</span>)</span><br><span class="line"><span class="type">row</span> format delimited </span><br><span class="line">fields terminated <span class="keyword">by</span> &quot;\t&quot; </span><br><span class="line">stored <span class="keyword">as</span> orc</span><br><span class="line">tblproperties(&quot;orc.compress&quot;<span class="operator">=</span>&quot;SNAPPY&quot;);</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>向ori表插入数据 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">load data inpath &quot;/gulivideo/video/output&quot; <span class="keyword">into</span> <span class="keyword">table</span> gulivideo_ori;</span><br><span class="line">load data inpath &quot;/gulivideo/user&quot; <span class="keyword">into</span> <span class="keyword">table</span> gulivideo_user_ori;</span><br></pre></td></tr></table></figure></li>
<li>向orc表插入数据 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> gulivideo_orc <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> gulivideo_ori;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> gulivideo_user_orc <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> gulivideo_user_ori;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="11-3-3-安装Tez引擎"><a href="#11-3-3-安装Tez引擎" class="headerlink" title="11.3.3 安装Tez引擎"></a>11.3.3 安装Tez引擎</h3><p>Tez是一个Hive的运行引擎，性能优于MR。为什么优于MR呢？看下<br><img src="https://anzhen-tech-imges.oss-cn-beijing.aliyuncs.com/2021/11/07/16356724726440.jpg?x-oss-process=image/auto-orient,1/quality,q_90/watermark,text_YW56aGVuLnRlY2g,size_40,x_10,y_10"></p>
<ul>
<li>用Hive直接编写MR程序，假设有四个有依赖关系的MR作业，上图中，绿色是Reduce Task，云状表示写屏蔽，需要将中间结果持久化写到HDFS。</li>
<li>Tez可以将多个有依赖的作业转换为一个作业，这样只需写一次HDFS，且中间节点较少，从而大大提升作业的计算性能。</li>
<li>安装步骤<ol>
<li>将tez安装包拷贝到集群，并解压tar包 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop102 software]$ mkdir /opt/module/tez</span><br><span class="line">[atguigu@hadoop102 software]$ tar -zxvf /opt/software/tez-0.10.1-SNAPSHOT-minimal.tar.gz -C /opt/module/tez</span><br></pre></td></tr></table></figure></li>
<li>上传tez依赖到HDFS <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop102 software]$ hadoop fs -mkdir /tez</span><br><span class="line">[atguigu@hadoop102 software]$ hadoop fs -put /opt/software/tez-0.10.1-SNAPSHOT.tar.gz /tez</span><br></pre></td></tr></table></figure></li>
<li>新建$HADOOP_HOME/etc/hadoop/tez-site.xml添加如下内容： <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>tez.lib.uris<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;fs.defaultFS&#125;/tez/tez-0.10.1-SNAPSHOT.tar.gz<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>tez.use.cluster.hadoop-libs<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>tez.am.resource.memory.mb<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>1024<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>tez.am.resource.cpu.vcores<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>tez.container.max.java.heap.fraction<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>0.4<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>tez.task.resource.memory.mb<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>1024<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>tez.task.resource.cpu.vcores<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ul>
<ol start="4">
<li>修改Hadoop环境变量$HADOOP_HOME/etc/hadoop/shellprofile.d/tez.sh <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加Tez的Jar包相关信息</span></span><br><span class="line">hadoop_add_profile tez</span><br><span class="line"><span class="keyword">function</span> _tez_hadoop_classpath</span><br><span class="line">&#123;</span><br><span class="line">    hadoop_add_classpath <span class="string">&quot;<span class="variable">$HADOOP_HOME</span>/etc/hadoop&quot;</span> after</span><br><span class="line">    hadoop_add_classpath <span class="string">&quot;/opt/module/tez/*&quot;</span> after</span><br><span class="line">    hadoop_add_classpath <span class="string">&quot;/opt/module/tez/lib/*&quot;</span> after</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>修改Hive的计算引擎$HIVE_HOME/conf/hive-site.xml <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.execution.engine<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>tez<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.tez.container.size<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>1024<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>解决日志Jar包冲突 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop102 software]$ rm /opt/module/tez/lib/slf4j-log4j12-1.7.10.jar</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="11-4-业务分析"><a href="#11-4-业务分析" class="headerlink" title="11.4 业务分析"></a>11.4 业务分析</h2><ul>
<li>统计视频观看数Top10  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> videoId,</span><br><span class="line">       uploader,</span><br><span class="line">       age,</span><br><span class="line">       category,</span><br><span class="line">       length,</span><br><span class="line">       `views`,</span><br><span class="line">       rate,</span><br><span class="line">       ratings,</span><br><span class="line">       comments,</span><br><span class="line">       relatedId</span><br><span class="line"><span class="keyword">from</span> gulivideo_orc</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> `views` <span class="keyword">desc</span></span><br><span class="line">limit <span class="number">10</span>;</span><br></pre></td></tr></table></figure></li>
<li>统计视频类别热度Top10  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">       category_name,</span><br><span class="line">       <span class="built_in">count</span>(videoId) video_count</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    videoId,category_name</span><br><span class="line"><span class="keyword">from</span> gulivideo_orc</span><br><span class="line"> <span class="keyword">lateral</span> <span class="keyword">view</span> explode(category) explode_category <span class="keyword">as</span> category_name</span><br><span class="line">) t1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> category_name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> video_count <span class="keyword">desc</span> limit <span class="number">10</span>;</span><br></pre></td></tr></table></figure></li>
<li>统计出视频观看数最高的20个视频的所属类别以及类别包含Top20视频的个数  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">       t2.category_name,</span><br><span class="line">       <span class="built_in">count</span>(videoId) video_count</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">         <span class="keyword">select</span></span><br><span class="line">                t1.videoId,</span><br><span class="line">                category_name</span><br><span class="line">         <span class="keyword">from</span> (</span><br><span class="line">                  <span class="keyword">select</span></span><br><span class="line">                         videoId,</span><br><span class="line">                         category,</span><br><span class="line">                         `views`</span><br><span class="line">                  <span class="keyword">from</span> gulivideo_orc</span><br><span class="line">                  <span class="keyword">order</span> <span class="keyword">by</span> `views` <span class="keyword">desc</span></span><br><span class="line">                  limit <span class="number">20</span></span><br><span class="line">              ) t1</span><br><span class="line">                  <span class="keyword">lateral</span> <span class="keyword">view</span> explode(t1.category) explode_category <span class="keyword">as</span> category_name</span><br><span class="line">     ) t2</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> t2.category_name</span><br><span class="line">;</span><br></pre></td></tr></table></figure>
</li>
<li>统计视频观看数Top50所关联视频的所属类别排名  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> category_name,</span><br><span class="line">       video_count,</span><br><span class="line">       <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> video_count) video_count_rank,</span><br><span class="line">       video_views,</span><br><span class="line">       <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> video_views) video_views_rank</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">         <span class="keyword">select</span> category_name,</span><br><span class="line">                <span class="built_in">count</span>(t5.single_relatedId)  video_count,</span><br><span class="line">                <span class="built_in">sum</span>(t5.related_video_views) video_views</span><br><span class="line">         <span class="keyword">from</span> (</span><br><span class="line">                  <span class="keyword">select</span> t4.orign_video_id,</span><br><span class="line">                         t4.orign_video_views,</span><br><span class="line">                         t4.single_relatedId,</span><br><span class="line">                         t4.related_video_views,</span><br><span class="line">                         category_name</span><br><span class="line">                  <span class="keyword">from</span> (</span><br><span class="line">                           <span class="keyword">select</span> t2.videoId orign_video_id,</span><br><span class="line">                                  t2.views   orign_video_views,</span><br><span class="line">                                  t2.single_relatedId,</span><br><span class="line">                                  t3.views   related_video_views,</span><br><span class="line">                                  t3.category</span><br><span class="line">                           <span class="keyword">from</span> (<span class="keyword">select</span> t1.videoId,</span><br><span class="line">                                        t1.views,</span><br><span class="line">                                        single_relatedId</span><br><span class="line">                                 <span class="keyword">from</span> (</span><br><span class="line">                                          <span class="keyword">select</span> videoId,</span><br><span class="line">                                                 `views`,</span><br><span class="line">                                                 relatedId</span><br><span class="line">                                          <span class="keyword">from</span> gulivideo_orc</span><br><span class="line">                                          <span class="keyword">order</span> <span class="keyword">by</span> `views` <span class="keyword">desc</span></span><br><span class="line">                                          limit <span class="number">50</span></span><br><span class="line">                                      ) t1</span><br><span class="line">                                          <span class="keyword">lateral</span> <span class="keyword">view</span> explode(t1.relatedId) explode_relatedId <span class="keyword">as</span> single_relatedId) t2</span><br><span class="line">                                    <span class="keyword">left</span> <span class="keyword">join</span> gulivideo_orc t3 <span class="keyword">on</span> t2.single_relatedId <span class="operator">=</span> t3.videoId</span><br><span class="line">                           <span class="keyword">where</span> t3.videoId <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">                       ) t4</span><br><span class="line">                           <span class="keyword">lateral</span> <span class="keyword">view</span> explode(t4.category) explode_category <span class="keyword">as</span> category_name</span><br><span class="line">              ) t5</span><br><span class="line">         <span class="keyword">group</span> <span class="keyword">by</span> t5.category_name</span><br><span class="line">     ) t6</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>统计每个类别中的视频热度Top10,以Music为例  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 统计每个类别中的视频热度Top10,以Music为例</span></span><br><span class="line"><span class="keyword">select</span> videoId,</span><br><span class="line">       `views`,</span><br><span class="line">       category_name</span><br><span class="line"><span class="keyword">from</span> gulivideo_orc</span><br><span class="line"><span class="keyword">lateral</span> <span class="keyword">VIEW</span> explode(category) gulivideo_orc_tmp <span class="keyword">AS</span> category_name</span><br><span class="line"><span class="keyword">where</span> array_contains(category, &quot;Music&quot;)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> `views` <span class="keyword">desc</span></span><br><span class="line">limit <span class="number">10</span>;</span><br><span class="line"><span class="comment">-- 统计每个类别中的视频热度Top10,以Music为例2</span></span><br><span class="line"><span class="keyword">SELECT</span> t1.videoId,</span><br><span class="line">       t1.views,</span><br><span class="line">       t1.category_name</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">         <span class="keyword">SELECT</span> videoId,</span><br><span class="line">                `views`,</span><br><span class="line">                category_name</span><br><span class="line">         <span class="keyword">FROM</span> gulivideo_orc</span><br><span class="line">                  <span class="keyword">lateral</span> <span class="keyword">VIEW</span> explode(category) gulivideo_orc_tmp <span class="keyword">AS</span> category_name</span><br><span class="line">     ) t1</span><br><span class="line"><span class="keyword">WHERE</span> t1.category_name <span class="operator">=</span> &quot;Music&quot;</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> t1.views <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">10</span>;</span><br></pre></td></tr></table></figure></li>
<li>统计每个类别视频观看数Top10  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">         <span class="keyword">SELECT</span> t1.videoId,</span><br><span class="line">                t1.views,</span><br><span class="line">                t1.category_name,</span><br><span class="line">                <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> t1.category_name <span class="keyword">order</span> <span class="keyword">by</span> t1.views <span class="keyword">desc</span>) video_rank</span><br><span class="line">         <span class="keyword">FROM</span> (</span><br><span class="line">                  <span class="keyword">SELECT</span> videoId,</span><br><span class="line">                         `views`,</span><br><span class="line">                         category_name</span><br><span class="line">                  <span class="keyword">FROM</span> gulivideo_orc</span><br><span class="line">                           <span class="keyword">lateral</span> <span class="keyword">VIEW</span> explode(category) gulivideo_orc_tmp <span class="keyword">AS</span> category_name</span><br><span class="line">              ) t1</span><br><span class="line">     ) t2</span><br><span class="line"><span class="keyword">where</span> t2.video_rank <span class="operator">&lt;=</span> <span class="number">10</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> t2.category_name, t2.video_rank</span><br></pre></td></tr></table></figure></li>
<li>统计上传视频最多的用户Top10以及他们上传的视频观看次数在前20的视频  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">         <span class="keyword">select</span> uploader,</span><br><span class="line">                videoId,</span><br><span class="line">                `views`,</span><br><span class="line">                <span class="built_in">percent_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> `views` )                                       views_percent_rank,</span><br><span class="line">                <span class="built_in">count</span>(videoId) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> uploader) video_count,</span><br><span class="line">                <span class="built_in">dense_rank</span>() <span class="keyword">over</span> (<span class="keyword">order</span> <span class="keyword">by</span> <span class="built_in">count</span>(videoId) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> uploader) <span class="keyword">desc</span>) video_count_rank</span><br><span class="line">         <span class="keyword">from</span> gulivideo_orc</span><br><span class="line">     ) t1</span><br><span class="line"><span class="keyword">where</span> t1.views_percent_rank <span class="operator">&gt;=</span> <span class="number">0.8</span></span><br><span class="line">  <span class="keyword">and</span> t1.video_count_rank <span class="operator">&lt;</span> <span class="number">10</span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">SELECT</span> t2.videoId,</span><br><span class="line">       t2.views,</span><br><span class="line">       t2.uploader</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">         <span class="keyword">SELECT</span> uploader,</span><br><span class="line">                videos</span><br><span class="line">         <span class="keyword">FROM</span> gulivideo_user_orc</span><br><span class="line">         <span class="keyword">ORDER</span> <span class="keyword">BY</span> videos <span class="keyword">DESC</span></span><br><span class="line">         LIMIT <span class="number">10</span></span><br><span class="line">     ) t1</span><br><span class="line">         <span class="keyword">JOIN</span> gulivideo_orc t2</span><br><span class="line">              <span class="keyword">ON</span> t1.uploader <span class="operator">=</span> t2.uploader</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> t2.views</span><br><span class="line">        <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">         <span class="keyword">SELECT</span> t2.videoId,</span><br><span class="line">                t2.views,</span><br><span class="line">                t2.uploader,</span><br><span class="line">                <span class="built_in">rank</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> t2.uploader <span class="keyword">order</span> <span class="keyword">by</span> t2.views <span class="keyword">desc</span> ) views_rank</span><br><span class="line">         <span class="keyword">FROM</span> (</span><br><span class="line">                  <span class="keyword">SELECT</span> uploader,</span><br><span class="line">                         videos</span><br><span class="line">                  <span class="keyword">FROM</span> gulivideo_user_orc</span><br><span class="line">                  <span class="keyword">ORDER</span> <span class="keyword">BY</span> videos <span class="keyword">DESC</span></span><br><span class="line">                  LIMIT <span class="number">10</span></span><br><span class="line">              ) t1</span><br><span class="line">                  <span class="keyword">JOIN</span> gulivideo_orc t2</span><br><span class="line">                       <span class="keyword">ON</span> t1.uploader <span class="operator">=</span> t2.uploader</span><br><span class="line">     ) t3</span><br><span class="line"><span class="keyword">where</span> t3.views_rank <span class="operator">&lt;=</span> <span class="number">20</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> uploader, views_rank</span><br></pre></td></tr></table></figure></li>
</ul>
 
      <!-- reward -->
      
      <div id="reword-out">
        <div id="reward-btn">
          打赏
        </div>
      </div>
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://anzhen-tech.github.io/2021/11/07/Hive/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hive/" rel="tag">Hive</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E4%BB%93/" rel="tag">数仓</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2021/11/07/Linux/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            Linux
          
        </div>
      </a>
    
    
      <a href="/2021/11/07/Hadoop/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">Hadoop</div>
      </a>
    
  </nav>

   
<!-- valine评论 -->
<div id="vcomments-box">
  <div id="vcomments"></div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script>
<script>
  new Valine({
    el: "#vcomments",
    app_id: "XCKHv09pYxF5EmF2ezNgFfLS-gzGzoHsz",
    app_key: "gyCHBp787fNNfXDiHGIcj7Am",
    path: window.location.pathname,
    avatar: "monsterid",
    placeholder: "给我的文章加点评论吧~",
    recordIP: true,
  });
  const infoEle = document.querySelector("#vcomments .info");
  if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
    infoEle.childNodes.forEach(function (item) {
      item.parentNode.removeChild(item);
    });
  }
</script>
<style>
  #vcomments-box {
    padding: 5px 30px;
  }

  @media screen and (max-width: 800px) {
    #vcomments-box {
      padding: 5px 0px;
    }
  }

  #vcomments-box #vcomments {
    background-color: #fff;
  }

  .v .vlist .vcard .vh {
    padding-right: 20px;
  }

  .v .vlist .vcard {
    padding-left: 10px;
  }
</style>

 
   
     
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2019-2021
        <i class="ri-heart-fill heart_icon"></i> Anzhen
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src=''></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="anzhen.tech"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/HDFS">HDFS</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/Yarn">Yarn</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/MR">MR</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/Hive">Hive</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86">数据采集</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/HBase">HBase</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/Kafka">Kafka</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/Spark">Spark</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/Flink">Flink</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/MySQL">MySQL</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/Java">Java</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/interview">面试宝典</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2019/11/07/about-me">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.png">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.png">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->
 <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.6/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
  var ayerConfig = {
    mathjax: true,
  };
</script>

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    <div id="music">
    
    
    
    <iframe frameborder="no" border="1" marginwidth="0" marginheight="0" width="200" height="52"
        src="//music.163.com/outchain/player?type=2&id=318916815&auto=1&height=32"></iframe>
</div>

<style>
    #music {
        position: fixed;
        right: 15px;
        bottom: 0;
        z-index: 998;
    }
</style>
    
    

  </div>
</body>

</html>